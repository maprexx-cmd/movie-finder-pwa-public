<!doctype html>

<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#5b34d6" />
  <title>Movie finder</title>  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; }
    .app { max-width: 720px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid rgba(0,0,0,.12); border-radius: 14px; padding: 12px; }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { opacity: .75; font-size: 13px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { border: 1px solid rgba(0,0,0,.18); border-radius: 999px; padding: 8px 10px; font-size: 14px; background: transparent; }
    .chip.on { border-color: rgba(0,0,0,.45); }
    .btn { border: 0; border-radius: 12px; padding: 10px 12px; font-size: 15px; }
    .btn.primary { background: #5b34d6; color: #fff; }
    .btn.secondary { background: rgba(0,0,0,.08); }
    .btn:disabled { opacity: .5; }
    .field { display: grid; gap: 6px; min-width: 160px; }
    select { padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.18); font-size: 15px; width: 100%; }
    input[type="range"] { width: 100%; }
    .movie { display: grid; grid-template-columns: 120px 1fr; gap: 12px; }
    .poster { width: 120px; height: 180px; border-radius: 12px; background: rgba(0,0,0,.08); overflow: hidden; display:flex; align-items:center; justify-content:center; }
    .poster img { width: 100%; height: 100%; object-fit: cover; display:block; }
    .kpi { display:flex; gap: 10px; flex-wrap: wrap; margin: 6px 0 10px; }
    .pill { font-size: 12px; padding: 6px 8px; border-radius: 999px; background: rgba(0,0,0,.08); }
    .why { margin-top: 10px; padding: 10px; border-radius: 12px; background: rgba(91,52,214,.10); }
    .err { color: #b00020; }
    .hr { height: 1px; background: rgba(0,0,0,.12); margin: 12px 0; }
  </style></head>
<body>
  <div class="app">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>
        <div class="title">Movie finder</div>
        <div class="muted">PWA, 1 film alla volta, generi, slider, disponibilità streaming.</div>
      </div>
      <button class="btn secondary" id="btnCredits">Crediti</button>
    </div><div class="hr"></div>

<div class="card">
  <div class="title">Generi</div>
  <div class="muted">Seleziona fino a 3 generi.</div>
  <div id="genres" class="chips" style="margin-top: 10px;"></div>
  <div id="errGenres" class="err" style="margin-top: 8px; display:none;"></div>
</div>

<div style="height: 12px;"></div>

<div class="card">
  <div class="title">Filtri</div>
  <div class="row">
    <div class="field">
      <label class="muted">Durata max</label>
      <select id="runtimeMax">
        <option value="">Qualsiasi</option>
        <option>80</option><option>90</option><option>100</option><option>110</option>
        <option selected>120</option>
        <option>140</option><option>160</option><option>180</option>
      </select>
    </div>
    <div class="field">
      <label class="muted">Tipo</label>
      <select id="monetization">
        <option value="flatrate,rent,buy">Tutti</option>
        <option value="flatrate">Solo abbonamento</option>
      </select>
    </div>
  </div>

  <div style="height: 8px;"></div>

  <label class="muted">
    <input type="checkbox" id="onlyAvailable" />
    Mostra solo disponibili online
  </label>
</div>

<div style="height: 12px;"></div>

<div class="card">
  <div class="title">Slider 0 a 5</div>

  <div class="row" style="margin-top: 10px;">
    <div class="field" style="flex:1;">
      <label class="muted">Comico: <span id="v_comico">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_comico" />
    </div>
    <div class="field" style="flex:1;">
      <label class="muted">Azione: <span id="v_azione">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_azione" />
    </div>
  </div>

  <div class="row">
    <div class="field" style="flex:1;">
      <label class="muted">Romantico: <span id="v_romantico">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_romantico" />
    </div>
    <div class="field" style="flex:1;">
      <label class="muted">Drammatico: <span id="v_drammatico">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_drammatico" />
    </div>
  </div>

  <div class="row">
    <div class="field" style="flex:1;">
      <label class="muted">Thriller: <span id="v_thriller">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_thriller" />
    </div>
    <div class="field" style="flex:1;">
      <label class="muted">Horror: <span id="v_horror">0</span></label>
      <input type="range" min="0" max="5" step="1" value="0" id="s_horror" />
    </div>
  </div>

  <div class="row" style="margin-top: 10px;">
    <button class="btn primary" id="btnFind">Trova un film</button>
    <button class="btn secondary" id="btnNext" disabled>Altro</button>
  </div>

  <div id="err" class="err" style="margin-top: 10px; display:none;"></div>
</div>

<div style="height: 12px;"></div>

<div class="card">
  <div class="title">Risultato</div>
  <div id="loading" class="muted" style="display:none;">Sto cercando...</div>
  <div id="result" style="margin-top: 10px;"></div>
</div>

  </div>  <script>
    const TMDB_KEY = "f8ecb75282e8dcea2d4845598cc7d030";
    const TMDB = "https://api.themoviedb.org/3";
    const IMG = "https://image.tmdb.org/t/p/w342";
    const LOGO = "https://image.tmdb.org/t/p/w92";
    const REGION = "IT";

    const state = {
      genres: [],
      selected: new Set(),
      pool: [],
      idx: 0,
      vibe: { comico:0, azione:0, romantico:0, drammatico:0, thriller:0, horror:0 }
    };

    const elGenres = document.getElementById("genres");
    const elErr = document.getElementById("err");
    const elErrGenres = document.getElementById("errGenres");
    const elLoading = document.getElementById("loading");
    const elResult = document.getElementById("result");

    const btnFind = document.getElementById("btnFind");
    const btnNext = document.getElementById("btnNext");

    const runtimeMax = document.getElementById("runtimeMax");
    const onlyAvailable = document.getElementById("onlyAvailable");
    const monetization = document.getElementById("monetization");

    function showErr(el, msg) {
      el.style.display = msg ? "block" : "none";
      el.textContent = msg || "";
    }

    function vibeBind() {
      const keys = ["comico","azione","romantico","drammatico","thriller","horror"];
      for (const k of keys) {
        const s = document.getElementById("s_"+k);
        const v = document.getElementById("v_"+k);
        s.addEventListener("input", () => {
          state.vibe[k] = Number(s.value);
          v.textContent = s.value;
        });
      }
    }

    function chip(name, on, onClick) {
      const b = document.createElement("button");
      b.className = "chip" + (on ? " on" : "");
      b.textContent = name;
      b.addEventListener("click", onClick);
      return b;
    }

    function renderGenres() {
      elGenres.innerHTML = "";
      for (const g of state.genres) {
        const on = state.selected.has(g.id);
        elGenres.appendChild(chip(g.name, on, () => toggleGenre(g.id)));
      }
    }

    function toggleGenre(id) {
      showErr(elErrGenres, "");
      if (state.selected.has(id)) state.selected.delete(id);
      else {
        if (state.selected.size >= 3) {
          showErr(elErrGenres, "Massimo 3 generi.");
          return;
        }
        state.selected.add(id);
      }
      renderGenres();
    }

    async function fetchJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error("Errore rete");
      return r.json();
    }

    async function fetchGenres() {
      const url = `${TMDB}/genre/movie/list?api_key=${TMDB_KEY}&language=it-IT`;
      const j = await fetchJson(url);
      return j.genres || [];
    }

    async function discover(page=1) {
      const g = [...state.selected].join(",");
      const rt = runtimeMax.value;

      const p = new URLSearchParams();
      p.set("api_key", TMDB_KEY);
      p.set("language", "it-IT");
      p.set("include_adult", "false");
      p.set("include_video", "false");
      p.set("sort_by", "vote_count.desc");
      p.set("page", String(page));
      if (g) p.set("with_genres", g);
      if (rt) p.set("with_runtime.lte", rt);

      if (onlyAvailable.checked) {
        p.set("watch_region", REGION);
        p.set("with_watch_monetization_types", monetization.value);
      }

      const url = `${TMDB}/discover/movie?` + p.toString();
      const j = await fetchJson(url);
      return j.results || [];
    }

    async function watchProviders(movieId) {
      const url = `${TMDB}/movie/${movieId}/watch/providers?api_key=${TMDB_KEY}`;
      const j = await fetchJson(url);
      const it = (j.results || {})[REGION];
      if (!it) return null;
      return {
        flatrate: it.flatrate || [],
        rent: it.rent || [],
        buy: it.buy || [],
        link: it.link || null
      };
    }

    function log10(x) { return Math.log(x) / Math.log(10); }

    function vibeBonus(movie) {
      const ids = new Set(movie.genre_ids || []);
      const v = state.vibe;
      let bonus = 0;

      const byName = {
        comico: [35],
        azione: [28,12],
        romantico: [10749],
        drammatico: [18],
        thriller: [53,80,9648],
        horror: [27]
      };

      for (const k of Object.keys(byName)) {
        const wanted = v[k] || 0;
        if (wanted === 0) continue;
        const hits = byName[k].some(id => ids.has(id));
        if (hits) bonus += wanted / 5;
        else bonus -= (wanted / 5) * 0.25;
      }
      return bonus;
    }

    function score(movie) {
      const vote = Number(movie.vote_average || 0) / 10;
      const count = Number(movie.vote_count || 0);
      const quality = vote * log10(count + 1);
      const vibe = vibeBonus(movie);
      return quality + (0.35 * vibe);
    }

    function pickBest(list) {
      const arr = [...list];
      arr.sort((a,b) => score(b) - score(a));
      return arr;
    }

    function esc(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function providersBlock(title, list) {
      if (!list || !list.length) return "";
      const items = list.map(p => {
        const logo = p.logo_path ? `<img src="${LOGO}${p.logo_path}" style="width:20px;height:20px;border-radius:999px;object-fit:cover">` : "";
        return `<span style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);margin:4px 6px 0 0;">${logo}${esc(p.provider_name)}</span>`;
      }).join("");
      return `<div style="margin-top:10px;"><div class="muted">${esc(title)}</div><div style="margin-top:6px;">${items}</div></div>`;
    }

    function whyText(movie) {
      const gmap = new Map(state.genres.map(x => [x.id, x.name]));
      const chosen = (movie.genre_ids || []).filter(id => state.selected.has(id)).map(id => gmap.get(id)).filter(Boolean);
      const topV = Object.entries(state.vibe).sort((a,b)=>b[1]-a[1]).filter(x=>x[1]>0).slice(0,2).map(x=>x[0]);
      const parts = [];
      if (chosen.length) parts.push("Generi: " + chosen.slice(0,3).join(", "));
      if (topV.length) parts.push("Slider: " + topV.join(", "));
      parts.push("Voto e numero voti buoni.");
      return parts.join(" ");
    }

    async function renderMovie(movie) {
      if (!movie) {
        elResult.innerHTML = `<div class="muted">Nessun film trovato.</div>`;
        btnNext.disabled = true;
        return;
      }

      const poster = movie.poster_path ? `${IMG}${movie.poster_path}` : "";
      const wp = await watchProviders(movie.id);

      if (onlyAvailable.checked) {
        const hasAny = wp && ((wp.flatrate && wp.flatrate.length) || (wp.rent && wp.rent.length) || (wp.buy && wp.buy.length));
        if (!hasAny) {
          next();
          return;
        }
      }

      const providersHtml = wp
        ? `<div class="why">
             <div class="muted">Disponibile online in Italia</div>
             ${providersBlock("Abbonamento", wp.flatrate)}
             ${providersBlock("Noleggio", wp.rent)}
             ${providersBlock("Acquisto", wp.buy)}
           </div>`
        : `<div class="muted" style="margin-top:10px;">Disponibilità online non trovata per IT.</div>`;

      elResult.innerHTML = `
        <div class="movie">
          <div class="poster">${poster ? `<img src="${poster}" alt="">` : `<div class="muted">No poster</div>`}</div>
          <div>
            <div class="title">${esc(movie.title || "Titolo non disponibile")}</div>
            <div class="kpi">
              <div class="pill">Voto: ${(movie.vote_average || 0).toFixed ? (movie.vote_average||0).toFixed(1) : movie.vote_average}</div>
              <div class="pill">Voti: ${movie.vote_count || 0}</div>
              <div class="pill">Uscita: ${movie.release_date || "n.d."}</div>
            </div>
            <div class="muted">${esc((movie.overview || "Trama non disponibile.").slice(0, 380))}${(movie.overview||"").length>380 ? "..." : ""}</div>
            <div class="why"><div class="muted">Perché te lo consiglio</div><div>${esc(whyText(movie))}</div></div>
            ${providersHtml}
          </div>
        </div>
      `;

      btnNext.disabled = false;
    }

    async function find() {
      showErr(elErr, "");
      showErr(elErrGenres, "");

      if (state.selected.size === 0) {
        showErr(elErrGenres, "Seleziona almeno 1 genere.");
        return;
      }

      elLoading.style.display = "block";
      elResult.innerHTML = "";
      btnNext.disabled = true;

      try {
        const list1 = await discover(1);
        const list2 = await discover(2);
        state.pool = pickBest([...list1, ...list2]);
        state.idx = 0;
        await renderMovie(state.pool[0] || null);
      } catch (e) {
        showErr(elErr, "Errore. Controlla internet o chiave.");
      } finally {
        elLoading.style.display = "none";
      }
    }

    async function next() {
      if (!state.pool.length) return;
      state.idx = (state.idx + 1) % state.pool.length;
      await renderMovie(state.pool[state.idx]);
    }

    document.getElementById("btnCredits").addEventListener("click", () => {
      alert("Questa PWA usa TMDB API. This product uses the TMDB API but is not endorsed or certified by TMDB.");
    });

    btnFind.addEventListener("click", find);
    btnNext.addEventListener("click", next);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(() => {});
    }

    (async function init() {
      vibeBind();
      try {
        state.genres = await fetchGenres();
        renderGenres();
      } catch (e) {
        showErr(elErr, "Non riesco a caricare i generi. Controlla internet o chiave.");
      }
    })();
  </script></body>
</html>
