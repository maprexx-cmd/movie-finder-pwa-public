<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Movie Finder</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1C1630">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root {
      --bg: #0E0B1A;
      --text: #FFFFFF;
      --muted: #BDB7D6;
      --violet: #7c3aed;
      --violet2: #5b21b6;
      --yellow: #F2C94C;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --devBlue: #4aa3ff;
      --devBlueBg: rgba(74,163,255,.10);
      --devBlueBorder: rgba(74,163,255,.22);
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: 
        radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 500px at 10% 30%,
                                radial-gradient(900px 500px at 10% 30%, rgba(242,201,76,.10), transparent 55%),
        linear-gradient(180deg, #070516, var(--bg));
      color: var(--text);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1040px;
      margin:
            }

    .wrap {
      max-width: 1040px;
      margin: 0 auto;
      padding:
        <script>
const TMDBKEY = 'INSERISCI LA TUA CHIAVE TMDB';
const TMDB = 'https://api.themoviedb.org/3';
const IMG = 'https://image.tmdb.org/t/p/w342';

const id = document.getElementById;

function toast(msg) {
  const t = toast;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toast.t);
  toast.t = setTimeout(() => t.classList.remove('show'), 2200);
}

function basePath() {
  const p = location.pathname;
  if (p.endsWith('/')) return p;
  const i = p.lastIndexOf('/');
  return i !== -1 ? p.slice(0, i) + '/' : '/';
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = id(id);
  if (el) el.classList.add('active');
  window.scrollTo(0, 0);
}

function bind(id, fn) {
  const el = id(id);
  if (!el) return;
  el.addEventListener('click', fn);
}

function hasKey() {
  return TMDBKEY !== 'INSERISCI LA TUA CHIAVE TMDB' && TMDBKEY.length > 20;
}

function genreMapMovie() {
  return { azione: 28, comico: 35, thriller: 53, animazione: 16, romantico: 10749, dramma: 18 };
}

function genreMapTv() {
  return { azione: 10759, comico: 35, thriller: 9648, animazione: 16, romantico: 10749, dramma: 18 };
}

function selectedGenresBasic() {
  return Array.from(document.querySelectorAll('#basicGenres input:checked')).map(x => x.value);
}

function selectedProviderIds(containerId) {
  return Array.from(document.querySelectorAll(`#${containerId} input:checked`))
    .map(x => x.value).filter(Boolean).join(',');
}

const STORE = {
  shownbasic: 'mf:shownbasic',
  shownpremium: 'mf:shownpremium',
  premiumenabled: 'mf:premiumenabled'
};

function loadShown(key) {
  try {
    const s = localStorage.getItem(key);
    if (!s) return new Set();
    const arr = JSON.parse(s);
    return new Set(Array.isArray(arr) ? arr : []);
  } catch(e) { return new Set(); }
}

function saveShown(key, set) {
  try {
    localStorage.setItem(key, JSON.stringify(Array.from(set)));
  } catch(e) {}
}

function resetShown(key) {
  try {
    localStorage.removeItem(key);
  } catch(e) {}
}

function prettyDate(s) {
  if (!s) return '';
  const d = new Date(s);
  if (!Number.isFinite(d.getTime())) return s;
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function scoreBadge(v) {
  const x = Number(v);
  if (!Number.isFinite(x) || !x) return 'Voto n.d.';
  return `Voto ${x.toFixed(1)}`;
}

function renderProviders(watch) {
  if (!watch) return null;
  const groups = [
    { label: 'Abbonamento', list: watch.flatrate },
    { label: 'Noleggio', list: watch.rent },
    { label: 'Acquisto', list: watch.buy }
  ].filter(g => Array.isArray(g.list) && g.list.length);

  if (!groups.length) return null;

  const box = document.createElement('div');
  box.className = 'providers';

  groups.forEach(({ label, list }) => {
    const g = document.createElement('div');
    g.className = 'provGroup';
    const t = document.createElement('p');
    t.className = 't';
    t.textContent = label;
    const l = document.createElement('div');
    l.className = 'provList';
    
    list.slice(0, 10).forEach(p => {
      const it = document.createElement('div');
      it.className = 'provItem';
      const img = document.createElement('img');
      img.src = `https://image.tmdb.org/t/p/w92${p.logo_path}`;
      img.alt = p.provider_name;
      const sp = document.createElement('span');
      sp.textContent = p.provider_name;
      it.appendChild(img);
      it.appendChild(sp);
      l.appendChild(it);
    });
    
    g.appendChild(t);
    g.appendChild(l);
    box.appendChild(g);
  });
  return box;
}

function buildResultCard(item, type, plotLen, watch) {
  const title = type === 'tv' ? item.name : item.title || 'Titolo';
  const date = type === 'tv' ? item.first_air_date : item.release_date;
  const poster = item.poster_path ? IMG + item.poster_path : '';
  const id = item.id;
  const overview = (item.overview || '').trim();
  const plotText = overview ? overview.slice(0, plotLen).trim() + (overview.length > plotLen ? '...' : '') : 'Trama non disponibile.';

  const card = document.createElement('div');
  card.className = 'resultCard';

  const left = document.createElement('div');
  left.className = 'poster';
  if (poster) {
    const img = document.createElement('img');
    img.src = poster;
    img.alt = title;
    left.appendChild(img);
  } else {
    left.textContent = 'Poster non disponibile';
  }

  const right = document.createElement('div');
  const h4 = document.createElement('h4');
  h4.textContent = title;
  const meta = document.createElement('div');
  meta.className = 'meta';
  const m1 = document.createElement('span');
  m1.textContent = prettyDate(date);
  const m2 = document.createElement('span');
  m2.textContent = scoreBadge(item.vote_average);
  meta.appendChild(m1);
  meta.appendChild(m2);

  const plot = document.createElement('p');
  plot.className = 'plot';
  plot.textContent = plotText;

  const actions = document.createElement('div');
  actions.className = 'actionRow';
  const btnJust = document.createElement('button');
  btnJust.className = 'watchBtn';
  btnJust.textContent = 'Dove guardarlo';
  btnJust.addEventListener('click', () => window.open(`https://www.justwatch.com/it/${type === 'tv' ? 'serie-tv' : 'film'}?q=${encodeURIComponent(title)}`, '_blank'));
  const btnTmdb = document.createElement('button');
  btnTmdb.className = 'openBtn';
  btnTmdb.textContent = 'Apri TMDB';
  btnTmdb.addEventListener('click', () => window.open(`https://www.themoviedb.org/${type === 'tv' ? 'tv' : 'movie'}/${id}`, '_blank'));
  actions.appendChild(btnJust);
  actions.appendChild(btnTmdb);

  right.appendChild(h4);
  right.appendChild(meta);
  right.appendChild(plot);
  right.appendChild(actions);

  const prov = renderProviders(watch);
  if (prov) right.appendChild(prov);

  card.appendChild(left);
  card.appendChild(right);

  // ðŸ”¥ MODIFICA 1: Click sulla card per cinema
  card.addEventListener('click', (e) => {
    if (e.target.closest('.watchBtn, .openBtn')) return;
    document.getElementById('cinemaTitle').textContent = title;
    showMovieStart(title);
  });

  return card;
}

async function api(path, params) {
  const u = new URL(TMDB + path);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== '') return u.searchParams.set(k, String(v));
  });
  const r = await fetch(u.toString(), { headers: { 'Accept': 'application/json' } });
  if (!r.ok) {
    const txt = await r.text().catch(() => '');
    throw new Error(`HTTP ${r.status}: ${txt.slice(0, 120)}`);
  }
  return await r.json();
}

async function getWatchProviders(type, id) {
  if (!hasKey()) return null;
  try {
    const data = await api(`${type}/${id}/watch/providers`, { apikey: TMDBKEY });
    const it = data.results?.IT || null;
    return it ? data.results.IT : null;
  } catch(e) { return null; }
}

async function loadProviderPicks() {
  const fallback = [
    { provider_id: 8, provider_name: 'Netflix' },
    { provider_id: 119, provider_name: 'Amazon Prime Video' },
    { provider_id: 337, provider_name: 'Disney+' },
    { provider_id: 350, provider_name: 'Apple TV' }
  ];

  if (!hasKey()) {
    renderProviderChips('basicProvidersPick', fallback);
    renderProviderChips('premiumProvidersPick', fallback);
    return;
  }

  try {
    const data = await api('watch/providers/movie', { apikey: TMDBKEY, watch_region: 'IT' });
    const list = data.results ? data.results : [];
    renderProviderChips('basicProvidersPick', list.slice(0, 20));
    renderProviderChips('premiumProvidersPick', list.slice(0, 20));
  } catch(e) {
    renderProviderChips('basicProvidersPick', fallback);
    renderProviderChips('premiumProvidersPick', fallback);
  }
}

function renderProviderChips(containerId, list) {
  const box = id(containerId);
  if (!box) return;
  box.innerHTML = '';
  list.forEach(p => {
    const lab = document.createElement('label');
    lab.className = 'chip';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.value = String(p.provider_id);
    lab.appendChild(input);
    lab.appendChild(document.createTextNode(p.provider_name));
    box.appendChild(lab);
  });
}

function renderPremiumSliders() {
  const box = id('premiumSliders');
  if (!box) return;
  box.innerHTML = '';
  const items = [
    { key: 'azione', label: 'Azione' },
    { key: 'comico', label: 'Comico' },
    { key: 'thriller', label: 'Thriller' },
    { key: 'animazione', label: 'Animazione' },
    { key: 'romantico', label: 'Romantico' },
    { key: 'dramma', label: 'Dramma' }
  ];
  items.forEach(it => {
    const row = document.createElement('div');
    row.className = 'sliderRow';
    const hdr = document.createElement('div');
    hdr.className = 'hdr';
    const strong = document.createElement('strong');
    strong.textContent = it.label;
    const span = document.createElement('span');
    span.textContent = '0';
    hdr.appendChild(strong);
    hdr.appendChild(span);
    const input = document.createElement('input');
    input.type = 'range';
    input.min = 0;
    input.max = 5;
    input.value = 0;
    input.id = `s-${it.key}`;
    input.addEventListener('input', () => span.textContent = input.value);
    row.appendChild(hdr);
    row.appendChild(input);
    box.appendChild(row);
  });
}

function premiumSelectedGenreIds(type) {
  const map = type === 'tv' ? genreMapTv() : genreMapMovie();
  const picks = [];
  Object.keys(map).forEach(k => {
    const el = id(`s-${k}`);
    const v = el ? Number(el.value) : 0;
    if (Number.isFinite(v) && v > 0) picks.push({ id: map[k], w: v });
  });
  picks.sort((a, b) => b.w - a.w);
  return picks.map(x => x.id);
}

async function discover(type, genreIds, providerPipe, limit, seenKey, plotLen) {
  if (!hasKey()) {
    toast('Inserisci la chiave TMDB per attivare la ricerca.');
    return;
  }

  const seen = loadShown(seenKey);
  const out = [];
  let page = 1;
  const path = type === 'tv' ? 'discover/tv' : 'discover/movie';

  while (out.length < limit && page <= 8) {
    const data = await api(path, {
      apikey: TMDBKEY,
      language: 'it-IT',
      watch_region: 'IT',
      include_adult: false,
      sort_by: 'popularity.desc',
      page,
      with_genres: genreIds && genreIds.length ? genreIds.join(',') : '',
      with_watch_providers: providerPipe,
      with_watch_monetization_types: providerPipe ? 'flatrate|rent|buy' : ''
    });
    const results = data.results ? data.results : [];

    for (const item of results) {
      if (!item || !item.id) continue;
      if (seen.has(item.id)) continue;
      out.push(item);
      seen.add(item.id);
      if (out.length >= limit) break;
    }
    if (!results.length) break;
    page++;
  }

  saveShown(seenKey, seen);

  const cards = [];
  for (const item of out) {
    const watch = await getWatchProviders(type, item.id);
    cards.push(buildResultCard(item, type, plotLen, watch));
  }
  return cards;
}

async function doBasicSearch() {
  const genres = selectedGenresBasic();
  if (!genres.length) {
    toast('Seleziona almeno un genere.');
    return;
  }
  const ids = genres.map(g => genreMapMovie()[g]).filter(Boolean);
  const providers = selectedProviderIds('basicProvidersPick');
  const box = id('basicResults');
  box.innerHTML = '';
  toast('Ricerca in corso...');
  try {
    const cards = await discover('movie', ids, providers, 3, STORE.shownbasic, 140);
    if (!cards.length) {
      toast('Nessun risultato nuovo.');
      return;
    }
    cards.forEach(c => box.appendChild(c));
    toast('Fatto.');
  } catch(e) {
    toast('Errore ricerca.');
  }
}

async function doPremiumSearch() {
  const type = id('premiumPickTv').checked ? 'tv' : 'movie';
  const ids = premiumSelectedGenreIds(type);
  if (!ids.length) {
    toast('Alza almeno uno slider.');
    return;
  }
  const providers = selectedProviderIds('premiumProvidersPick');
  const box = id('premiumResults');
  box.innerHTML = '';
  toast('Ricerca in corso...');
  try {
    const cards = await discover(type, ids, providers, 5, STORE.shownpremium, 260);
    if (!cards.length) {
      toast('Nessun risultato nuovo.');
      return;
    }
    cards.forEach(c => box.appendChild(c));
    toast('Fatto.');
  } catch(e) {
    toast('Errore ricerca.');
  }
}

function premiumEnabled() {
  return localStorage.getItem(STORE.premiumenabled) === '1';
}

function setPremiumEnabled(v) {
  localStorage.setItem(STORE.premiumenabled, v ? '1' : '0');
  renderPremiumStatus();
}

function renderPremiumStatus() {
  const el = id('premiumStatus');
  if (!el) return;
  el.textContent = premiumEnabled() ?
    'âœ… Premium attivo (in test su questo dispositivo).' :
    'Premium non attivo. In test puoi attivarlo con "Sblocca Premium".';
}

// ðŸ”¥ MODIFICA 2: NUOVA FUNZIONE per cinema al click film
function showMovieStart(title) {
  const c = document.getElementById('cinema');
  document.getElementById('cinemaTitle').textContent = title;
  document.getElementById('cinemaSub').textContent = 'Mettiti comodo, lo spettacolo sta per iniziare.';
  c.classList.add('show', 'flashOn', 'curtainsOn');
  setTimeout(() => c.classList.add('ready'), 260);
  setTimeout(() => c.classList.add('showButtons'), 650);
  setTimeout(() => c.classList.remove('flashOn'), 400);
}

function showExit() {
  const c = id('cinema');
  c.classList.add('show', 'flashOn', 'curtainsOn');
  setTimeout(() => c.classList.add('ready'), 260);
  setTimeout(() => c.classList.add('showButtons'), 650);
  setTimeout(() => c.classList.remove('flashOn'), 400);
}

function hideExit() {
  const c = id('cinema');
  c.className = 'cinemaOverlay';
}

function tryClose() {
  try {
    window.close();
  } catch(e) {
    setTimeout(() => toast('Usa Indietro o chiudi la scheda.'), 250);
  }
}

function init() {
  bind('btnGoBasic', () => showScreen('screenBasic'));
  bind('btnGoPremium', () => {
    if (!premiumEnabled()) {
      toast('Premium non attivo.');
      return;
    }
    showScreen('screenPremium');
  });
  bind('btnInfoBasic', () => toast('Basic: film, 4 generi, 3 risultati.'));
  bind('btnBuyPremium', () => {
    setPremiumEnabled(true);
    toast('âœ… Premium attivo in test.');
  });
  bind('btnBackFromBasic', () => showScreen('screenStart'));
  bind('btnBackFromPremium', () => showScreen('screenStart'));
  bind('btnExitFromStart', showExit);
  bind('btnExitFromBasic', showExit);
  bind('btnExitFromPremium', showExit);
  bind('cinemaCancel', hideExit);
  bind('cinemaExitNow', tryClose);
  bind('btnToggleDev', () => {
    document.body.classList.toggle('dev');
    toast('Dev');
  });
  bind('btnBasicSearch', doBasicSearch);
  bind('btnPremiumSearch', doPremiumSearch);
  bind('btnBasicResetShown', () => {
    resetShown(STORE.shownbasic);
    toast('Reset basic fatto.');
  });
  bind('btnPremiumResetShown', () => {
    resetShown(STORE.shownpremium);
    toast('Reset premium fatto.');
  });

  renderPremiumSliders();
  renderPremiumStatus();
  loadProviderPicks();
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

init();
</script>
</body>
</html>
