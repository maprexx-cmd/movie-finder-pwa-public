<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Movie Finder</title>

<style>
:root{
  --bg:#0f0f0f;
  --panel:#171717;
  --card:#1f1f1f;
  --border:#2b2b2b;
  --text:#ffffff;
  --muted:#cfcfcf;
  --muted2:#9a9a9a;
  --btn:#5b2cff;
  --btn2:#2a2a2a;
  --danger:#ff3b30;
  --ok:#34c759;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:980px;
  margin:0 auto;
  padding:16px;
}
h1{
  margin:8px 0 14px 0;
  text-align:center;
  font-size:22px;
}
.section{
  margin-top:14px;
  padding:12px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.col{
  flex:1;
  min-width:240px;
}
label{
  display:block;
  margin-top:10px;
  font-size:14px;
  color:var(--muted);
}
input[type="text"], select{
  width:100%;
  margin-top:8px;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#111111;
  color:var(--text);
}
input[type="range"]{
  width:100%;
  margin-top:10px;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  background:var(--btn);
  color:var(--text);
  border:none;
  border-radius:10px;
}
button.secondary{background:var(--btn2)}
button.danger{background:var(--danger)}
.inline{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.inline button{width:auto; flex:1; min-width:160px}
.notice{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#111111;
  color:var(--muted);
  font-size:13px;
  line-height:1.35;
}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#111111;
  color:var(--muted);
  font-size:12px;
}
.badge.ok{border-color:rgba(52,199,89,.35); color:#c8f7d8}
.badge.warn{border-color:rgba(255,59,48,.35); color:#ffd2cf}
.hidden{display:none !important}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media(max-width:520px){
  .grid2{grid-template-columns:1fr}
}

.chk{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#111111;
  margin-top:10px;
}
.chk input{width:18px; height:18px; margin:0}

.results{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap:12px;
  margin-top:12px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
.poster{
  width:100%;
  aspect-ratio: 2 / 3;
  background:#111111;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--muted2);
  font-size:13px;
}
.poster img{width:100%; height:100%; object-fit:cover; display:block}
.card-body{padding:10px}
.title{margin:0; font-size:16px}
.meta{margin:6px 0 0 0; font-size:13px; color:var(--muted)}
.overview{margin:8px 0 0 0; font-size:13px; color:#e8e8e8; line-height:1.35}

.packs{margin-top:10px}
.pack-label{font-size:12px; color:var(--muted2); margin-top:8px}
.p-row{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
.pill{
  display:flex;
  align-items:center;
  gap:6px;
  border:1px solid var(--border);
  background:#111111;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
}
.pill img{width:18px; height:18px; border-radius:4px}

.actions{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.actions button{
  margin-top:0;
  padding:10px;
  font-size:14px;
}

.kpi{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:10px;
  margin-top:10px;
}
.kpi .box{
  background:#111111;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.kpi .num{font-size:20px; margin:0}
.kpi .lbl{margin:6px 0 0 0; color:var(--muted2); font-size:12px}
</style>
</head>

<body>
<div class="container">
  <h1>Movie Finder</h1>

  <div class="section">
    <div class="row">
      <div class="col">
        <label>TMDB API Key</label>
        <input id="apiKey" type="text" placeholder="Incolla qui la tua API key" />
        <div class="notice">
          Tu inserisci la tua API key. L’app la salva in locale sul telefono.
        </div>
      </div>

      <div class="col">
        <label>Tipo utente</label>
        <select id="userType">
          <option value="base">Utente base</option>
          <option value="premium">Utente premium</option>
        </select>

        <div class="chk">
          <input id="onlyOnline" type="checkbox" />
          <label for="onlyOnline" style="margin:0">Mostra solo disponibili online in Italia</label>
        </div>

        <div class="notice" id="dailyNotice"></div>
      </div>
    </div>

    <div class="inline" style="margin-top:10px">
      <button id="btnSearch" onclick="runSearch()">Cerca</button>
      <button class="secondary" onclick="showWatchlist()">Watchlist</button>
      <button class="secondary" onclick="clearResults()">Pulisci</button>
    </div>

    <div class="inline" style="margin-top:10px">
      <span class="badge" id="statusBadge">Pronto</span>
      <span class="badge" id="modeBadge">Base</span>
    </div>

    <div id="msg" class="notice">Inserisci la tua API key, scegli i generi, poi premi Cerca.</div>
  </div>

  <div class="section" id="baseSection">
    <div class="notice">
      Utente base. Tu fai 1 ricerca al giorno. Tu ottieni 3 risultati. Tu vedi locandina e trama breve.
    </div>

    <div class="grid2">
      <div>
        <label>Genere 1</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 2</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 3</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 4</label>
        <select class="baseGenre"></select>
      </div>
    </div>
  </div>

  <div class="section hidden" id="premiumSection">
    <div class="notice">
      Utente premium. Tu scegli fino a 10 generi con slider. Tu cerchi film e serie TV. Tu vedi trama estesa, locandina, statistiche.
    </div>

    <label>Contenuti</label>
    <select id="contentType">
      <option value="movie">Film</option>
      <option value="tv">Serie TV</option>
      <option value="both">Film e serie TV</option>
    </select>

    <div class="section" style="margin-top:12px">
      <div class="notice">Se imposti 0, l’app ignora il genere.</div>
      <div id="premiumGenres"></div>
    </div>

    <div class="section" style="margin-top:12px">
      <div class="notice">Piattaforme. Tu puoi filtrare sui servizi che usi.</div>
      <div id="platformsBox" class="row"></div>
      <div class="inline" style="margin-top:10px">
        <button class="secondary" onclick="savePlatforms()">Salva piattaforme</button>
        <button class="secondary" onclick="resetPlatforms()">Reset piattaforme</button>
      </div>
    </div>

    <div class="section" style="margin-top:12px">
      <div class="notice">Statistiche personali. L’app le salva in locale.</div>
      <div class="kpi" id="statsKpi"></div>
      <button class="danger" onclick="resetStats()">Reset statistiche</button>
    </div>
  </div>

  <div class="section">
    <div id="results" class="results"></div>
  </div>
</div>

<script>
const TMDB_BASE = "https://api.themoviedb.org/3";
const IMG_BASE = "https://image.tmdb.org/t/p/w500";
const LOGO_BASE = "https://image.tmdb.org/t/p/w92";

const GENRES_MOVIE = [
  {id:28, name:"Azione"},
  {id:12, name:"Avventura"},
  {id:16, name:"Animazione"},
  {id:35, name:"Commedia"},
  {id:80, name:"Crime"},
  {id:99, name:"Documentario"},
  {id:18, name:"Drammatico"},
  {id:10751, name:"Famiglia"},
  {id:14, name:"Fantasy"},
  {id:36, name:"Storia"},
  {id:27, name:"Horror"},
  {id:10402, name:"Musica"},
  {id:9648, name:"Mistero"},
  {id:10749, name:"Romantico"},
  {id:878, name:"Fantascienza"},
  {id:53, name:"Thriller"},
  {id:10752, name:"Guerra"},
  {id:37, name:"Western"}
];

const PREMIUM_GENRE_SET = [
  {key:"action", name:"Azione", movieId:28, tvId:10759},
  {key:"comedy", name:"Commedia", movieId:35, tvId:35},
  {key:"drama", name:"Drammatico", movieId:18, tvId:18},
  {key:"thriller", name:"Thriller", movieId:53, tvId:9648},
  {key:"romance", name:"Romantico", movieId:10749, tvId:null},
  {key:"horror", name:"Horror", movieId:27, tvId:null},
  {key:"scifi", name:"Fantascienza", movieId:878, tvId:10765},
  {key:"crime", name:"Crime", movieId:80, tvId:80},
  {key:"family", name:"Famiglia", movieId:10751, tvId:10751},
  {key:"doc", name:"Documentario", movieId:99, tvId:99}
];

const KNOWN_PLATFORMS_IT = [
  "Netflix","Amazon Prime Video","Disney Plus","NOW","Sky Go","Apple TV","Paramount Plus",
  "Rakuten TV","Google Play Movies","YouTube","Infinity","Chili","TIMVISION","MUBI"
];

const LS = {
  apiKey:"mf_apiKey",
  userType:"mf_userType",
  daily:"mf_daily",
  watchlist:"mf_watchlist",
  stats:"mf_stats",
  platforms:"mf_platforms",
  sliders:"mf_sliders",
  onlyOnline:"mf_onlyOnline"
};

function $(id){return document.getElementById(id)}

function safeJson(s, fallback){
  try{ return s ? JSON.parse(s) : fallback; }catch(e){ return fallback; }
}

function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function setStatus(txt, kind){
  const b = $("statusBadge");
  b.textContent = txt;
  b.classList.remove("ok","warn");
  if(kind==="ok") b.classList.add("ok");
  if(kind==="warn") b.classList.add("warn");
}

function setMsg(txt){
  $("msg").textContent = txt;
}

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return y + "-" + m + "-" + da;
}

function refreshDailyNotice(){
  const ut = $("userType").value;
  const box = $("dailyNotice");
  if(ut === "premium"){
    box.textContent = "Premium attivo. Tu puoi cercare senza limite giornaliero.";
    return;
  }
  const daily = safeJson(localStorage.getItem(LS.daily), {});
  if(daily && daily.date === todayKey()){
    box.textContent = "Oggi hai già fatto la ricerca base. Torna domani.";
  }else{
    box.textContent = "Tu puoi fare 1 ricerca al giorno. Oggi non hai ancora cercato.";
  }
}

function refreshUI(){
  const ut = $("userType").value;
  $("modeBadge").textContent = ut === "premium" ? "Premium" : "Base";
  $("baseSection").classList.toggle("hidden", ut === "premium");
  $("premiumSection").classList.toggle("hidden", ut !== "premium");
  refreshDailyNotice();
}

function initBaseGenres(){
  const selects = document.querySelectorAll(".baseGenre");
  const opts = GENRES_MOVIE.slice().sort((a,b)=>a.name.localeCompare(b.name));
  selects.forEach(sel=>{
    sel.innerHTML = "";
    const none = document.createElement("option");
    none.value = "";
    none.textContent = "Nessuno";
    sel.appendChild(none);
    opts.forEach(g=>{
      const o = document.createElement("option");
      o.value = String(g.id);
      o.textContent = g.name;
      sel.appendChild(o);
    });
  });
}

function initPremiumGenres(){
  const host = $("premiumGenres");
  host.innerHTML = "";
  const saved = safeJson(localStorage.getItem(LS.sliders), {});
  PREMIUM_GENRE_SET.forEach(g=>{
    const wrap = document.createElement("div");
    wrap.className = "chk";
    wrap.style.flexDirection = "column";
    wrap.style.alignItems = "stretch";

    const top = document.createElement("div");
    top.className = "inline";
    top.style.justifyContent = "space-between";
    top.style.width = "100%";

    const l = document.createElement("div");
    l.textContent = g.name;
    l.style.fontSize = "14px";
    l.style.color = "#fff";

    const v = document.createElement("div");
    v.id = "val_" + g.key;
    v.style.fontSize = "13px";
    v.style.color = "var(--muted)";

    const r = document.createElement("input");
    r.type = "range";
    r.min = "0";
    r.max = "10";
    r.step = "1";
    r.id = "r_" + g.key;
    r.value = String(saved[g.key] ?? 0);
    v.textContent = r.value;

    r.addEventListener("input", ()=>{
      v.textContent = r.value;
      savePremiumSliders();
    });

    top.appendChild(l);
    top.appendChild(v);
    wrap.appendChild(top);
    wrap.appendChild(r);
    host.appendChild(wrap);
  });
}

function savePremiumSliders(){
  const out = {};
  PREMIUM_GENRE_SET.forEach(g=>{
    const r = document.getElementById("r_" + g.key);
    out[g.key] = Number(r ? r.value : 0);
  });
  localStorage.setItem(LS.sliders, JSON.stringify(out));
}

function getPremiumSliders(){
  const data = safeJson(localStorage.getItem(LS.sliders), {});
  const out = {};
  PREMIUM_GENRE_SET.forEach(g=>{
    out[g.key] = Number(data[g.key] ?? 0);
  });
  return out;
}

function initPlatformsBox(){
  const box = $("platformsBox");
  box.innerHTML = "";
  const saved = safeJson(localStorage.getItem(LS.platforms), {});
  KNOWN_PLATFORMS_IT.forEach(name=>{
    const d = document.createElement("div");
    d.className = "chk";
    d.style.flex = "1";
    d.style.minWidth = "190px";
    d.style.marginTop = "0";

    const c = document.createElement("input");
    c.type = "checkbox";
    c.id = "pl_" + name.replace(/\s+/g,"_");
    c.checked = !!saved[name];

    const l = document.createElement("label");
    l.setAttribute("for", c.id);
    l.textContent = name;
    l.style.margin = "0";

    d.appendChild(c);
    d.appendChild(l);
    box.appendChild(d);
  });
}

function savePlatforms(){
  const out = {};
  KNOWN_PLATFORMS_IT.forEach(name=>{
    const id = "pl_" + name.replace(/\s+/g,"_");
    const el = document.getElementById(id);
    out[name] = !!(el && el.checked);
  });
  localStorage.setItem(LS.platforms, JSON.stringify(out));
  setMsg("Piattaforme salvate.");
}

function resetPlatforms(){
  localStorage.removeItem(LS.platforms);
  initPlatformsBox();
  setMsg("Piattaforme resettate.");
}

function getSelectedPlatforms(){
  const saved = safeJson(localStorage.getItem(LS.platforms), {});
  return Object.keys(saved).filter(k=>saved[k]);
}

function canSearchBaseToday(){
  const daily = safeJson(localStorage.getItem(LS.daily), {});
  return !(daily && daily.date === todayKey());
}

function markBaseSearchedToday(){
  localStorage.setItem(LS.daily, JSON.stringify({date: todayKey()}));
}

function shortOverview(text){
  if(!text) return "Trama non disponibile.";
  const t = text.trim();
  if(t.length <= 220) return t;
  return t.slice(0, 220).trim() + "...";
}

function normalize(n, min, max){
  if(max === min) return 0;
  return (n - min) / (max - min);
}

async function tmdbFetch(path, params){
  const apiKey = $("apiKey").value.trim();
  if(!apiKey) throw new Error("Manca la API key.");
  const url = new URL(TMDB_BASE + path);
  url.searchParams.set("api_key", apiKey);
  url.searchParams.set("language", "it-IT");
  if(params){
    Object.keys(params).forEach(k=>{
      const v = params[k];
      if(v !== undefined && v !== null && v !== ""){
        url.searchParams.set(k, String(v));
      }
    });
  }
  const res = await fetch(url.toString());
  if(!res.ok) throw new Error("Errore TMDB: " + res.status);
  return await res.json();
}

async function discover(kind, genreIds, page){
  const withGenres = genreIds && genreIds.length ? genreIds.join(",") : "";
  const params = {
    include_adult: "false",
    sort_by: "popularity.desc",
    watch_region: "IT",
    with_watch_monetization_types: "flatrate|rent|buy",
    page: page || 1
  };
  if(withGenres) params.with_genres = withGenres;
  const path = kind === "tv" ? "/discover/tv" : "/discover/movie";
  return await tmdbFetch(path, params);
}

async function getProviders(kind, id){
  try{
    const data = await tmdbFetch(`/${kind}/${id}/watch/providers`, {});
    const it = data && data.results && data.results.IT ? data.results.IT : null;
    if(!it) return null;

    const packs = [];
    const pushPack = (label, arr)=>{
      if(!Array.isArray(arr) || !arr.length) return;
      const seen = new Set();
      const items = [];
      arr.forEach(p=>{
        if(!p || !p.provider_name) return;
        if(seen.has(p.provider_name)) return;
        seen.add(p.provider_name);
        items.push({
          name: p.provider_name,
          logo: p.logo_path ? (LOGO_BASE + p.logo_path) : null
        });
      });
      if(items.length) packs.push({label, items});
    };

    pushPack("Abbonamento", it.flatrate);
    pushPack("Noleggio", it.rent);
    pushPack("Acquisto", it.buy);

    if(!packs.length) return null;
    return packs;
  }catch(e){
    return null;
  }
}

function providersMatchSelected(packs, selectedPlatforms){
  if(!packs) return false;
  if(!selectedPlatforms || !selectedPlatforms.length) return true;
  const set = new Set(selectedPlatforms);
  for(const p of packs){
    for(const it of p.items){
      if(set.has(it.name)) return true;
    }
  }
  return false;
}

function baseReRank(items, genreIds){
  const filtered = items.slice();
  const pops = filtered.map(x=>Number(x.popularity || 0));
  const votes = filtered.map(x=>Number(x.vote_average || 0));
  const pMin = Math.min(...pops, 0), pMax = Math.max(...pops, 1);
  const vMin = Math.min(...votes, 0), vMax = Math.max(...votes, 10);

  filtered.forEach(x=>{
    const p = normalize(Number(x.popularity||0), pMin, pMax);
    const v = normalize(Number(x.vote_average||0), vMin, vMax);
    const g = Array.isArray(x.genre_ids) ? x.genre_ids : [];
    let match = 0;
    genreIds.forEach(id=>{
      if(g.includes(id)) match += 1;
    });
    const m = genreIds.length ? (match / genreIds.length) : 0;
    x._score = (v * 0.55) + (p * 0.30) + (m * 0.15);
  });

  filtered.sort((a,b)=> (b._score||0) - (a._score||0));
  return filtered;
}

function premiumReRank(items, weightedGenreIds){
  const filtered = items.slice();
  const pops = filtered.map(x=>Number(x.popularity || 0));
  const votes = filtered.map(x=>Number(x.vote_average || 0));
  const pMin = Math.min(...pops, 0), pMax = Math.max(...pops, 1);
  const vMin = Math.min(...votes, 0), vMax = Math.max(...votes, 10);

  const maxW = Math.max(...weightedGenreIds.map(x=>x.w), 10);

  filtered.forEach(x=>{
    const p = normalize(Number(x.popularity||0), pMin, pMax);
    const v = normalize(Number(x.vote_average||0), vMin, vMax);
    const g = Array.isArray(x.genre_ids) ? x.genre_ids : [];

    let wsum = 0;
    let wmatch = 0;
    weightedGenreIds.forEach(it=>{
      wsum += it.w;
      if(g.includes(it.id)) wmatch += it.w;
    });
    const wm = wsum ? (wmatch / wsum) : 0;
    const topBoost = weightedGenreIds.length ? (weightedGenreIds[0].w / maxW) : 0;

    x._score = (v * 0.50) + (p * 0.25) + (wm * 0.25) + (topBoost * 0.03);
  });

  filtered.sort((a,b)=> (b._score||0) - (a._score||0));
  return filtered;
}

async function buildItems(kind, raw){
  const out = [];
  for(const r of raw){
    const title = kind === "tv" ? (r.name || "") : (r.title || "");
    const date = kind === "tv" ? (r.first_air_date || "") : (r.release_date || "");
    const year = date ? String(date).slice(0,4) : "";
    const poster = r.poster_path ? (IMG_BASE + r.poster_path) : null;
    out.push({
      kind,
      id: r.id,
      title,
      year,
      rating: Number(r.vote_average || 0).toFixed(1),
      popularity: Number(r.popularity || 0),
      overview: r.overview || "",
      poster
    });
  }
  return out;
}

async function attachProviders(items){
  const onlyOnline = $("onlyOnline").checked;
  const ut = $("userType").value;
  const selectedPlatforms = ut === "premium" ? getSelectedPlatforms() : [];

  const final = [];
  for(const it of items){
    const packs = await getProviders(it.kind, it.id);
    it.providers = packs;

    const hasOnline = !!packs;
    if(onlyOnline && !hasOnline) continue;

    const okPlatforms = providersMatchSelected(packs, selectedPlatforms);
    if(!okPlatforms) continue;

    final.push(it);
  }
  return final;
}

function buildProvidersHtml(packs){
  if(!packs) return '<div class="notice">Disponibilità streaming IT non trovata.</div>';
  let html = '<div class="packs">';
  packs.forEach(p=>{
    html += '<div class="pack-label">' + escapeHtml(p.label) + '</div>';
    html += '<div class="p-row">';
    p.items.forEach(i=>{
      const logo = i.logo ? '<img src="' + i.logo + '" alt="">' : "";
      html += '<div class="pill">' + logo + escapeHtml(i.name) + '</div>';
    });
    html += '</div>';
  });
  html += "</div>";
  return html;
}

function renderItems(items, userType){
  const host = $("results");
  host.innerHTML = "";

  if(!items.length){
    setMsg("Nessun risultato. Cambia generi o disattiva i filtri.");
    setStatus("Nessun risultato", "warn");
    return;
  }

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card";

    const posterHtml = it.poster ? '<img src="' + it.poster + '" alt="Locandina">' : "";
    const overviewText = userType === "premium" ? (it.overview || "Trama non disponibile.") : shortOverview(it.overview);
    const kindLabel = it.kind === "tv" ? "Serie TV" : "Film";

    const onlineBadge = it.providers ? '<span class="badge ok">Online IT</span>' : '<span class="badge warn">Non trovato online</span>';

    card.innerHTML =
      '<div class="poster">' + (posterHtml || "Locandina") + '</div>' +
      '<div class="card-body">' +
        '<h3 class="title">' + escapeHtml(it.title) + '</h3>' +
        '<div class="meta">' + escapeHtml(kindLabel) + (it.year ? " , " + escapeHtml(it.year) : "") + " , Voto " + escapeHtml(it.rating) + '</div>' +
        '<div style="margin-top:8px">' + onlineBadge + '</div>' +
        '<p class="overview">' + escapeHtml(overviewText) + '</p>' +
        buildProvidersHtml(it.providers) +
        '<div class="actions">' +
          '<button class="secondary" onclick="openTmdb(\'' + it.kind + '\',' + it.id + ')">Apri su TMDB</button>' +
          '<button onclick="addToWatchlist(\'' + it.kind + '\',' + it.id + ',\'' + escapeHtml(it.title).replace(/'/g,"&#039;") + '\',\'' + (it.poster ? it.poster : "") + '\',\'' + (it.year ? it.year : "") + '\')">Watchlist</button>' +
        '</div>' +
      '</div>';

    host.appendChild(card);
  });
}

function openTmdb(kind, id){
  updateStatsOnClick();
  const url = "https://www.themoviedb.org/" + (kind === "tv" ? "tv/" : "movie/") + id;
  window.open(url, "_blank");
}

function getBaseSelectedGenres(){
  const ids = Array.from(document.querySelectorAll(".baseGenre"))
    .map(s=>Number(s.value || 0))
    .filter(n=>n > 0);
  return Array.from(new Set(ids)).slice(0, 4);
}

function getPremiumGenreIdsFor(kind){
  const sliders = getPremiumSliders();
  const active = PREMIUM_GENRE_SET.map(g=>{
    const w = Number(sliders[g.key] || 0);
    const id = kind === "movie" ? g.movieId : g.tvId;
    return {id, w};
  }).filter(x=>x.id && x.w > 0);

  active.sort((a,b)=>b.w - a.w);
  return active;
}

function updateStatsOnSearch(payload){
  const st = safeJson(localStorage.getItem(LS.stats), {
    searches:0,
    searchesBase:0,
    searchesPremium:0,
    movieSearches:0,
    tvSearches:0,
    clicks:0,
    watchAdds:0
  });

  st.searches += 1;
  if(payload.userType === "base") st.searchesBase += 1;
  if(payload.userType === "premium") st.searchesPremium += 1;

  if(payload.contentType === "movie") st.movieSearches += 1;
  if(payload.contentType === "tv") st.tvSearches += 1;
  if(payload.contentType === "both"){ st.movieSearches += 1; st.tvSearches += 1; }

  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function updateStatsOnClick(){
  const st = safeJson(localStorage.getItem(LS.stats), {});
  st.clicks = Number(st.clicks || 0) + 1;
  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function updateStatsOnWatchAdd(){
  const st = safeJson(localStorage.getItem(LS.stats), {});
  st.watchAdds = Number(st.watchAdds || 0) + 1;
  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function renderStats(){
  const box = $("statsKpi");
  if(!box) return;
  const st = safeJson(localStorage.getItem(LS.stats), {
    searches:0, searchesBase:0, searchesPremium:0, movieSearches:0, tvSearches:0, clicks:0, watchAdds:0
  });

  box.innerHTML = "";
  const items = [
    {num: st.searches || 0, lbl: "Ricerche totali"},
    {num: st.searchesPremium || 0, lbl: "Ricerche premium"},
    {num: st.searchesBase || 0, lbl: "Ricerche base"},
    {num: st.movieSearches || 0, lbl: "Ricerche film"},
    {num: st.tvSearches || 0, lbl: "Ricerche serie TV"},
    {num: st.clicks || 0, lbl: "Click su risultati"},
    {num: st.watchAdds || 0, lbl: "Aggiunte in watchlist"}
  ];
  items.forEach(it=>{
    const d = document.createElement("div");
    d.className = "box";
    d.innerHTML = '<p class="num">' + it.num + '</p><p class="lbl">' + it.lbl + '</p>';
    box.appendChild(d);
  });
}

function resetStats(){
  localStorage.removeItem(LS.stats);
  renderStats();
  setMsg("Statistiche resettate.");
}

function getWatchlist(){
  return safeJson(localStorage.getItem(LS.watchlist), []);
}

function saveWatchlist(list){
  localStorage.setItem(LS.watchlist, JSON.stringify(list));
}

function addToWatchlist(kind, id, title, poster, year){
  const list = getWatchlist();
  const key = kind + ":" + id;
  if(list.some(x => (x.kind + ":" + x.id) === key)){
    setMsg("È già in watchlist.");
    return;
  }
  list.unshift({kind, id, title, poster: poster || null, year: year || "", addedAt: Date.now()});
  saveWatchlist(list);
  updateStatsOnWatchAdd();
  setMsg("Aggiunto in watchlist.");
}

function removeFromWatchlist(kind, id){
  const list = getWatchlist();
  const key = kind + ":" + id;
  saveWatchlist(list.filter(x => (x.kind + ":" + x.id) !== key));
  showWatchlist();
}

function showWatchlist(){
  clearResults();
  const list = getWatchlist();
  if(!list.length){
    setMsg("Watchlist vuota.");
    return;
  }
  setMsg("Watchlist. Tocca Rimuovi per cancellare.");
  const host = $("results");

  list.forEach(w=>{
    const card = document.createElement("div");
    card.className = "card";
    const posterHtml = w.poster ? '<img src="' + w.poster + '" alt="Locandina">' : "";
    card.innerHTML =
      '<div class="poster">' + (posterHtml || "Locandina") + '</div>' +
      '<div class="card-body">' +
        '<h3 class="title">' + escapeHtml(w.title) + '</h3>' +
        '<div class="meta">' + escapeHtml(w.year || "") + '</div>' +
        '<div class="actions">' +
          '<button class="danger" onclick="removeFromWatchlist(\'' + w.kind + '\',' + w.id + ')">Rimuovi</button>' +
        '</div>' +
      '</div>';
    host.appendChild(card);
  });
}

function clearResults(){
  $("results").innerHTML = "";
  setStatus("Pronto");
}

function persistTopSettings(){
  localStorage.setItem(LS.apiKey, $("apiKey").value.trim());
  localStorage.setItem(LS.userType, $("userType").value);
  localStorage.setItem(LS.onlyOnline, $("onlyOnline").checked ? "1" : "0");
}

async function runSearch(){
  try{
    persistTopSettings();
    refreshUI();
    clearResults();
    setStatus("Cerco...");

    const userType = $("userType").value;

    if(userType === "base"){
      if(!canSearchBaseToday()){
        setMsg("Oggi hai già fatto la ricerca base. Torna domani.");
        setStatus("Bloccato", "warn");
        return;
      }

      const genres = getBaseSelectedGenres();
      if(!genres.length){
        setMsg("Seleziona almeno 1 genere.");
        setStatus("Attenzione", "warn");
        return;
      }

      setMsg("Sto cercando 3 film con locandina e trama breve.");
      const d1 = await discover("movie", genres, 1);
      const d2 = await discover("movie", genres, 2);

      const raw = (d1.results || []).concat(d2.results || []);
      const ranked = baseReRank(raw, genres).slice(0, 14);

      let items = await buildItems("movie", ranked);
      items = await attachProviders(items);
      items = items.slice(0, 3);

      renderItems(items, "base");
      markBaseSearchedToday();
      refreshDailyNotice();
      updateStatsOnSearch({userType:"base", contentType:"movie"});
      setStatus("Fatto", "ok");
      return;
    }

    if(userType === "premium"){
      const contentType = $("contentType").value;

      const activeMovie = getPremiumGenreIdsFor("movie");
      const activeTv = getPremiumGenreIdsFor("tv");

      const anyActive = Object.values(getPremiumSliders()).some(v=>Number(v)>0);
      if(!anyActive){
        setMsg("Imposta almeno 1 slider sopra 0.");
        setStatus("Attenzione", "warn");
        return;
      }

      let pool = [];

      if(contentType === "movie" || contentType === "both"){
        if(!activeMovie.length){
          setMsg("I generi scelti non hanno corrispondenze film. Alza altri slider.");
          setStatus("Attenzione", "warn");
          return;
        }
        const gids = activeMovie.map(x=>x.id);
        const d1 = await discover("movie", gids, 1);
        const d2 = await discover("movie", gids, 2);
        const raw = (d1.results || []).concat(d2.results || []);
        const ranked = premiumReRank(raw, activeMovie).slice(0, 18);
        pool = pool.concat(await buildItems("movie", ranked));
      }

      if(contentType === "tv" || contentType === "both"){
        if(!activeTv.length){
          setMsg("I generi scelti non hanno corrispondenze serie TV. Alza altri slider.");
          setStatus("Attenzione", "warn");
          return;
        }
        const gids = activeTv.map(x=>x.id);
        const d1 = await discover("tv", gids, 1);
        const d2 = await discover("tv", gids, 2);
        const raw = (d1.results || []).concat(d2.results || []);
        const ranked = premiumReRank(raw, activeTv).slice(0, 18);
        pool = pool.concat(await buildItems("tv", ranked));
      }

      pool = await attachProviders(pool);
      pool = pool.slice(0, 8);

      setMsg("Risultati premium con trama estesa e locandina.");
      renderItems(pool, "premium");
      updateStatsOnSearch({userType:"premium", contentType});
      setStatus("Fatto", "ok");
      return;
    }

  }catch(e){
    setMsg(String(e && e.message ? e.message : e));
    setStatus("Errore", "warn");
  }
}

function loadState(){
  $("apiKey").value = localStorage.getItem(LS.apiKey) || "";
  $("userType").value = localStorage.getItem(LS.userType) || "base";
  $("onlyOnline").checked = (localStorage.getItem(LS.onlyOnline) === "1");

  initBaseGenres();
  initPremiumGenres();
  initPlatformsBox();
  refreshUI();
  renderStats();
  setStatus("Pronto");
}

$("apiKey").addEventListener("input", ()=>localStorage.setItem(LS.apiKey, $("apiKey").value.trim()));
$("userType").addEventListener("change", ()=>{ localStorage.setItem(LS.userType, $("userType").value); refreshUI(); });
$("onlyOnline").addEventListener("change", ()=>localStorage.setItem(LS.onlyOnline, $("onlyOnline").checked ? "1" : "0"));

loadState();
</script>
</body>
</html>
