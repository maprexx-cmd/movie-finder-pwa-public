<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Finder</title>

  <meta name="theme-color" content="#0b0b0b">
  <meta name="description" content="Trova film e serie e dove vederli in streaming">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#141414;
      --text:#f2f2f2;
      --muted:#b9b9b9;
      --line:#242424;
      --acc:#ffd24a;
      --danger:#ff5a5a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
    }
    button, input, select{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background:#101010;
      color:var(--text);
      padding:12px 14px;
      outline:none;
    }
    button{
      cursor:pointer;
    }
    button.primary{
      border-color:transparent;
      background:var(--acc);
      color:#111;
      font-weight:700;
    }
    button.ghost{
      background:transparent;
    }
    button.danger{
      background:transparent;
      border-color:rgba(255,90,90,.5);
      color:var(--danger);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 280px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .title{font-size:20px; font-weight:800; margin:0 0 6px}
    .sub{color:var(--muted); margin:0 0 10px; line-height:1.35}
    .small{font-size:12px; color:var(--muted)}
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:14px;
      display:grid;
      place-items:center;
      border:1px solid var(--line);
      background:#111;
      overflow:hidden;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      line-height:1.1;
    }
    .brand .by{
      margin:0;
      color:var(--muted);
      font-size:12px;
    }
    .hidden{display:none !important}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .grid{
      display:grid;
      grid-template-columns:repeat(1, minmax(0,1fr));
      gap:12px;
    }
    @media(min-width:760px){
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    .result{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .poster{
      width:92px;
      height:138px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#0f0f0f;
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .poster img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .meta h3{margin:0 0 6px; font-size:16px}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#101010;
      color:var(--muted);
      font-size:12px;
      margin:0 6px 6px 0;
    }
    .plot{margin:6px 0 0; color:var(--muted); line-height:1.35; font-size:13px}
    .providers{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .prov{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#101010;
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .prov img{width:20px; height:20px; border-radius:6px; display:block}
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      max-width:92vw;
      width:520px;
      display:none;
      z-index:40;
    }
    .toast.show{display:block}
    .toast p{margin:0; color:var(--muted); font-size:13px}

    /* Intro */
    .intro{
      min-height:calc(100vh - 32px);
      display:grid;
      place-items:center;
    }
    .introInner{
      width:min(680px, 100%);
      text-align:center;
      padding:10px;
    }
    .hero{
      display:grid;
      place-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    .heroSvg{
      width:140px;
      height:140px;
      border-radius:26px;
      border:1px solid var(--line);
      background:#101010;
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .heroTitle{
      margin:0;
      font-size:28px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .heroSub{
      margin:0;
      color:var(--muted);
      line-height:1.35;
    }
    .choose{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:16px;
    }
    @media(min-width:760px){
      .choose{grid-template-columns:1fr 1fr}
    }

    /* Cinema outro (chiusura) */
    .outro{
      position:fixed;
      inset:0;
      z-index:60;
      display:none;
      background:#000;
      color:#fff;
    }
    .outro.show{display:block}
    .outroStage{
      height:100%;
      display:grid;
      place-items:center;
      padding:18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .outroStage::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 40%, rgba(255,210,74,.20), transparent 38%),
        radial-gradient(circle at 70% 45%, rgba(255,210,74,.16), transparent 40%),
        radial-gradient(circle at 50% 60%, rgba(255,255,255,.08), transparent 45%);
      filter:blur(18px);
      opacity:.9;
      animation:flicker 120ms infinite;
    }
    .outroStage::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(to bottom, rgba(255,255,255,.05), rgba(0,0,0,0) 30%, rgba(0,0,0,.25)),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0 1px, rgba(0,0,0,0) 1px 4px);
      mix-blend-mode:overlay;
      opacity:.6;
      animation:scan 2.4s linear infinite;
      pointer-events:none;
    }
    @keyframes flicker{
      0%{opacity:.80}
      20%{opacity:.95}
      40%{opacity:.75}
      60%{opacity:.98}
      80%{opacity:.82}
      100%{opacity:.92}
    }
    @keyframes scan{
      0%{transform:translateY(-6%)}
      100%{transform:translateY(6%)}
    }
    .outroText{
      position:relative;
      z-index:2;
      max-width:720px;
      padding:18px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .outroText h2{
      margin:0 0 6px;
      font-size:22px;
      font-weight:900;
    }
    .outroText p{
      margin:0;
      color:rgba(255,255,255,.75);
      line-height:1.35;
    }
    .outroActions{
      position:relative;
      z-index:2;
      margin-top:14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- INTRO -->
    <section id="intro" class="intro">
      <div class="introInner">
        <div class="hero">
          <div class="heroSvg" aria-hidden="true">
            <!-- icona stilizzata: proiettore verso TV e divano -->
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="10" y="18" width="46" height="26" rx="8" stroke="#2a2a2a" fill="#0f0f0f"/>
              <circle cx="24" cy="31" r="6" stroke="#2a2a2a" fill="#121212"/>
              <circle cx="42" cy="31" r="6" stroke="#2a2a2a" fill="#121212"/>
              <rect x="12" y="46" width="42" height="10" rx="5" fill="#101010" stroke="#2a2a2a"/>
              <path d="M56 28 L102 46" stroke="#ffd24a" stroke-width="4" stroke-linecap="round" opacity="0.55"/>
              <path d="M56 34 L102 56" stroke="#ffd24a" stroke-width="4" stroke-linecap="round" opacity="0.35"/>
              <rect x="78" y="40" width="30" height="22" rx="6" stroke="#2a2a2a" fill="#0f0f0f"/>
              <rect x="82" y="44" width="22" height="14" rx="3" fill="#101010" stroke="#2a2a2a"/>
              <path d="M60 84 C72 74, 96 74, 108 84" stroke="#2a2a2a" stroke-width="8" stroke-linecap="round"/>
              <path d="M58 92 C72 82, 96 82, 110 92" stroke="#1f1f1f" stroke-width="10" stroke-linecap="round"/>
            </svg>
          </div>
          <p class="heroTitle">Movie Finder</p>
          <p class="heroSub">Mettiti comodo, inizia lo spettacolo</p>
          <p class="small">Max des OSMUS</p>
        </div>

        <div class="choose">
          <div class="card">
            <p class="title">Basic</p>
            <p class="sub">Solo film. 1 ricerca al giorno. Generi essenziali.</p>
            <div class="row">
              <button id="btnGoBasic" class="primary col">Entra in Basic</button>
            </div>
          </div>

          <div class="card">
            <p class="title">Premium</p>
            <p class="sub">Film e serie. Filtri completi. Ricerche illimitate.</p>
            <div class="row">
              <button id="btnGoPremium" class="primary col">Entra in Premium</button>
              <button id="btnServiceUnlock" class="ghost col" title="Solo test">Servizio sblocca Premium</button>
            </div>
            <p class="small">Se non hai acquistato, la app deve aprire Play Store. Qui resta simulato.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <span style="font-weight:900;color:var(--acc);">MF</span>
          </div>
          <div>
            <h1>Movie Finder</h1>
            <p class="by" id="modeLine">Modalità</p>
          </div>
        </div>

        <div class="row">
          <button id="btnExit" class="danger">Esci</button>
        </div>
      </div>

      <div class="card">
        <p class="title">Cosa cerchi</p>
        <p class="sub">Scegli e premi Cerca. Ordino i risultati per qualità e recenza.</p>

        <div class="row" id="basicControls">
          <div class="col">
            <label class="small">Tipo</label><br>
            <select id="basicType">
              <option value="movie">Film</option>
              <option value="tv" disabled>Serie TV (Premium)</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Genere</label><br>
            <select id="basicGenre">
              <option value="28">Azione</option>
              <option value="35">Comico</option>
              <option value="53">Thriller</option>
              <option value="16">Animazione</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Disponibile online</label><br>
            <select id="onlyStreaming">
              <option value="0">No</option>
              <option value="1">Sì</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Risultati</label><br>
            <select id="basicLimit">
              <option value="3">3</option>
              <option value="5">5 (Premium)</option>
            </select>
          </div>
        </div>

        <div class="row hidden" id="premiumControls">
          <div class="col">
            <label class="small">Tipo</label><br>
            <select id="premiumType">
              <option value="movie">Film</option>
              <option value="tv">Serie TV</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Disponibile online</label><br>
            <select id="onlyStreamingP">
              <option value="0">No</option>
              <option value="1">Sì</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Numero risultati</label><br>
            <select id="premiumLimit">
              <option value="5">5</option>
              <option value="10">10</option>
            </select>
          </div>

          <div class="col">
            <label class="small">Generi</label><br>
            <select id="premiumGenres" multiple size="6" style="width:100%; border-radius:12px">
              <option value="28">Azione</option>
              <option value="35">Comico</option>
              <option value="53">Thriller</option>
              <option value="16">Animazione</option>
              <option value="10749">Romantico</option>
              <option value="18">Dramma</option>
              <option value="80">Crime</option>
              <option value="12">Avventura</option>
              <option value="14">Fantasy</option>
              <option value="27">Horror</option>
              <option value="878">Fantascienza</option>
              <option value="9648">Mistero</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnSearch" class="primary col">Cerca</button>
          <button id="btnClear" class="ghost col">Pulisci</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="col">
            <p class="small" id="orderInfo">Ordino per data recente e voto alto.</p>
            <p class="small" id="limitInfo"></p>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div id="results" class="grid"></div>
    </section>

  </div>

  <!-- OUTRO / CHIUSURA -->
  <div id="outro" class="outro" aria-hidden="true">
    <div class="outroStage">
      <div class="outroText">
        <h2>Fine spettacolo</h2>
        <p>Premi Esci per chiudere la app.</p>
      </div>
      <div class="outroActions">
        <button id="btnCloseApp" class="primary">Esci ora</button>
        <button id="btnBackApp" class="ghost">Torna alla app</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><p id="toastText"></p></div>

  <script>
    /* ========= CONFIG ========= */
    const TMDB_API_KEY = "INCOLLA_LA_TUA_CHIAVE_TMDB";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const IMG_BASE = "https://image.tmdb.org/t/p/w342";
    const WATCH_REGION = "IT";

    const BASIC_LIMIT_PER_DAY = 1;

    /* ========= STATE ========= */
    const state = {
      mode: "basic",
      premiumUnlocked: false,
      purchasedPremium: false,
      todayKey: null,
    };

    /* ========= DOM ========= */
    const intro = document.getElementById("intro");
    const app = document.getElementById("app");
    const modeLine = document.getElementById("modeLine");

    const btnGoBasic = document.getElementById("btnGoBasic");
    const btnGoPremium = document.getElementById("btnGoPremium");
    const btnServiceUnlock = document.getElementById("btnServiceUnlock");

    const basicControls = document.getElementById("basicControls");
    const premiumControls = document.getElementById("premiumControls");

    const btnSearch = document.getElementById("btnSearch");
    const btnClear = document.getElementById("btnClear");
    const btnExit = document.getElementById("btnExit");

    const resultsEl = document.getElementById("results");

    const onlyStreaming = document.getElementById("onlyStreaming");
    const basicLimit = document.getElementById("basicLimit");
    const orderInfo = document.getElementById("orderInfo");
    const limitInfo = document.getElementById("limitInfo");

    const basicType = document.getElementById("basicType");
    const basicGenre = document.getElementById("basicGenre");

    const premiumType = document.getElementById("premiumType");
    const onlyStreamingP = document.getElementById("onlyStreamingP");
    const premiumLimit = document.getElementById("premiumLimit");
    const premiumGenres = document.getElementById("premiumGenres");

    const outro = document.getElementById("outro");
    const btnCloseApp = document.getElementById("btnCloseApp");
    const btnBackApp = document.getElementById("btnBackApp");

    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");

    /* ========= UTIL ========= */
    function showToast(msg){
      toastText.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function todayStorageKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `mf_basic_${y}-${m}-${day}`;
    }

    function canRunBasicSearch(){
      const k = todayStorageKey();
      state.todayKey = k;
      const n = Number(localStorage.getItem(k) || "0");
      return n < BASIC_LIMIT_PER_DAY;
    }

    function markBasicSearchUsed(){
      const k = state.todayKey || todayStorageKey();
      const n = Number(localStorage.getItem(k) || "0");
      localStorage.setItem(k, String(n+1));
    }

    function setMode(mode){
      state.mode = mode;

      const isPremium = (mode === "premium");
      basicControls.classList.toggle("hidden", isPremium);
      premiumControls.classList.toggle("hidden", !isPremium);

      modeLine.textContent = isPremium ? "Modalità Premium" : "Modalità Basic";

      if(!isPremium){
        basicLimit.value = "3";
        basicLimit.disabled = true;
        basicType.value = "movie";
        onlyStreaming.value = "0";
      } else {
        basicLimit.disabled = true;
      }

      orderInfo.textContent = "Ordino per data recente e voto alto, con filtro qualità minimo.";
      updateLimitInfo();
    }

    function updateLimitInfo(){
      if(state.mode === "basic"){
        const ok = canRunBasicSearch();
        limitInfo.textContent = ok ? "Hai 1 ricerca disponibile oggi." : "Hai già usato la ricerca di oggi.";
      } else {
        limitInfo.textContent = "Ricerche illimitate.";
      }
    }

    function switchToApp(){
      intro.classList.add("hidden");
      app.classList.remove("hidden");
      updateLimitInfo();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    /* ========= PREMIUM SIMULAZIONE ========= */
    function openPlayStore(){
      showToast("Simulazione: qui apro Play Store per acquistare Premium.");
      // In produzione: usa Billing Library Android. Qui è solo placeholder.
    }

    async function showLogin(){
      // Login finto per test rapido.
      const email = prompt("Email");
      if(email === null) return false;
      const pass = prompt("Password");
      if(pass === null) return false;

      // NOTA: non salvare credenziali in chiaro in produzione.
      const ok = (email === "maprexx@gmail.com" && pass === "Max2025Aa@@@@@");
      if(!ok){
        showToast("Credenziali errate.");
        return false;
      }
      return true;
    }

    /* ========= TMDB ========= */
    function tmdbUrl(path, params){
      const url = new URL(TMDB_BASE + path);
      url.searchParams.set("api_key", TMDB_API_KEY);
      url.searchParams.set("language", "it-IT");
      for(const [k,v] of Object.entries(params || {})){
        if(v !== undefined && v !== null && v !== ""){
          url.searchParams.set(k, String(v));
        }
      }
      return url.toString();
    }

    function safeDate(str){
      if(!str) return null;
      const t = Date.parse(str);
      if(Number.isNaN(t)) return null;
      return new Date(t);
    }

    function yearFromDateStr(str){
      const d = safeDate(str);
      return d ? d.getFullYear() : null;
    }

    function computeScore(item){
      // Ordinamento richiesto:
      // - priorità recenza
      // - ma voto conta tanto
      // score = (vote_average*0.7) + (freshness*0.3)
      // freshness normalizzato su 25 anni, clamp 0..10

      const vote = Number(item.vote_average || 0);

      const dateStr = item.release_date || item.first_air_date || "";
      const y = yearFromDateStr(dateStr);
      const nowY = new Date().getFullYear();
      const age = (y ? (nowY - y) : 50);
      const freshness = Math.max(0, Math.min(10, 10 - (age * (10/25))));

      const score = (vote * 0.7) + (freshness * 0.3);

      return {
        score,
        vote,
        freshness,
        y: y || 0,
        dateStr
      };
    }

    function qualityFilter(item){
      const vote = Number(item.vote_average || 0);
      const votes = Number(item.vote_count || 0);

      // filtri minimi per aumentare pertinenza
      if(vote < 6.5) return false;
      if(votes < 200) return false;

      // scarta roba senza data
      const dateStr = item.release_date || item.first_air_date || "";
      if(!dateStr) return false;

      return true;
    }

    async function fetchDiscover(type, genreIds){
      // Non puoi fare due ordinamenti nativi.
      // Faccio sort per data desc lato TMDB, poi riordino in app con score.

      const common = {
        sort_by: (type === "tv") ? "first_air_date.desc" : "primary_release_date.desc",
        "vote_count.gte": 200,
        "vote_average.gte": 6.5,
        include_adult: "false",
        watch_region: WATCH_REGION
      };

      if(genreIds && genreIds.length){
        common.with_genres = genreIds.join(",");
      }

      return fetch(tmdbUrl(`/discover/${type}`, common))
        .then(r => r.ok ? r.json() : Promise.reject(new Error("Errore TMDB")));
    }

    async function fetchProviders(type, id){
      // watch/providers. Filtriamo regione IT lato app.
      return fetch(tmdbUrl(`/${type}/${id}/watch/providers`, {}))
        .then(r => r.ok ? r.json() : Promise.reject(new Error("Errore providers")));
    }

    function pickProvidersIT(provJson){
      try{
        const it = provJson?.results?.[WATCH_REGION];
        if(!it) return { flatrate:[], rent:[], buy:[] };
        return {
          flatrate: it.flatrate || [],
          rent: it.rent || [],
          buy: it.buy || []
        };
      } catch(e){
        return { flatrate:[], rent:[], buy:[] };
      }
    }

    function hasAnyProvider(p){
      return (p.flatrate.length || p.rent.length || p.buy.length);
    }

    function monetizationLabel(kind){
      if(kind === "flatrate") return "Abbonamento";
      if(kind === "rent") return "Noleggio";
      if(kind === "buy") return "Acquisto";
      return "Online";
    }

    function providerBadge(provider, kind){
      const div = document.createElement("div");
      div.className = "prov";

      if(provider.logo_path){
        const img = document.createElement("img");
        img.alt = provider.provider_name;
        img.src = "https://image.tmdb.org/t/p/w45" + provider.logo_path;
        div.appendChild(img);
      }

      const t = document.createElement("div");
      t.textContent = `${provider.provider_name} , ${monetizationLabel(kind)}`;
      div.appendChild(t);

      return div;
    }

    function renderResult(item, type, scoreMeta, providers){
      const card = document.createElement("div");
      card.className = "card";

      const wrap = document.createElement("div");
      wrap.className = "result";

      const poster = document.createElement("div");
      poster.className = "poster";

      if(item.poster_path){
        const img = document.createElement("img");
        img.alt = item.title || item.name || "Poster";
        img.loading = "lazy";
        img.src = IMG_BASE + item.poster_path;
        poster.appendChild(img);
      } else {
        const s = document.createElement("span");
        s.className = "small";
        s.textContent = "Nessuna immagine";
        poster.appendChild(s);
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const h3 = document.createElement("h3");
      h3.textContent = item.title || item.name || "Titolo";
      meta.appendChild(h3);

      const p1 = document.createElement("span");
      p1.className = "pill";
      p1.textContent = `Voto ${Number(item.vote_average||0).toFixed(1)} , ${item.vote_count||0} voti`;
      meta.appendChild(p1);

      const dateStr = scoreMeta.dateStr;
      const y = scoreMeta.y;
      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = `Anno ${y}`;
      meta.appendChild(p2);

      const p3 = document.createElement("span");
      p3.className = "pill";
      p3.textContent = `Score ${scoreMeta.score.toFixed(2)}`;
      meta.appendChild(p3);

      const plot = document.createElement("p");
      plot.className = "plot";
      plot.textContent = (item.overview && item.overview.trim()) ? item.overview.trim() : "Trama non disponibile.";
      meta.appendChild(plot);

      const provWrap = document.createElement("div");
      provWrap.className = "providers";

      const addKind = (kind, arr) => {
        arr.slice(0, 6).forEach(pr => provWrap.appendChild(providerBadge(pr, kind)));
      };

      if(providers && hasAnyProvider(providers)){
        addKind("flatrate", providers.flatrate);
        addKind("rent", providers.rent);
        addKind("buy", providers.buy);
      } else {
        const none = document.createElement("div");
        none.className = "prov";
        none.textContent = "Nessuna piattaforma trovata in IT";
        provWrap.appendChild(none);
      }

      meta.appendChild(provWrap);

      wrap.appendChild(poster);
      wrap.appendChild(meta);
      card.appendChild(wrap);

      return card;
    }

    async function getScoredResults(type, rawResults, onlyOnline){
      const filtered = rawResults.filter(qualityFilter);

      // Calcolo score
      const scored = filtered.map(it => {
        const m = computeScore(it);
        return { it, m };
      });

      // Ordinamento: prima recenza implicita nello score, ma rinforzo con tie-break
      scored.sort((a,b) => {
        if(b.m.score !== a.m.score) return b.m.score - a.m.score;

        // tie-break 1: anno più recente
        if(b.m.y !== a.m.y) return b.m.y - a.m.y;

        // tie-break 2: voto più alto
        return (b.m.vote - a.m.vote);
      });

      // Se vuoi solo disponibili online, filtro dopo fetch providers.
      if(!onlyOnline){
        return scored.map(s => ({ ...s, providers:null }));
      }

      const out = [];
      for(const s of scored){
        try{
          const provJson = await fetchProviders(type, s.it.id);
          const p = pickProvidersIT(provJson);
          if(hasAnyProvider(p)){
            out.push({ ...s, providers:p });
          }
        } catch(e){
          // ignora
        }
        if(out.length >= 25) break;
      }
      return out;
    }

    async function enrichProvidersIfNeeded(type, scoredList){
      // Se non filtro online, provo comunque a prendere providers per i primi 10,
      // così la UI è utile ma non lenta.
      const max = Math.min(10, scoredList.length);
      const copy = scoredList.slice();

      for(let i=0;i<max;i++){
        try{
          const provJson = await fetchProviders(type, copy[i].it.id);
          copy[i].providers = pickProvidersIT(provJson);
        } catch(e){
          copy[i].providers = null;
        }
      }
      return copy;
    }

    function readSelectedGenresMulti(){
      const opts = Array.from(premiumGenres.selectedOptions);
      return opts.map(o => o.value);
    }

    function clearResults(){
      resultsEl.innerHTML = "";
    }

    /* ========= SEARCH ========= */
    async function runSearch(){
      if(TMDB_API_KEY === "INCOLLA_LA_TUA_CHIAVE_TMDB"){
        showToast("Inserisci la chiave TMDB dentro TMDB_API_KEY.");
        return;
      }

      clearResults();
      resultsEl.innerHTML = `<div class="card"><p class="title">Cerco...</p><p class="sub">Attendi.</p></div>`;

      if(state.mode === "basic"){
        if(!canRunBasicSearch()){
          showToast("Hai già usato la ricerca di oggi.");
          updateLimitInfo();
          resultsEl.innerHTML = "";
          return;
        }
      }

      try{
        let type = "movie";
        let genreIds = [];
        let limit = 3;
        let onlyOnline = false;

        if(state.mode === "basic"){
          type = "movie";
          genreIds = [basicGenre.value];
          limit = 3;
          onlyOnline = (onlyStreaming.value === "1");
        } else {
          type = premiumType.value;
          genreIds = readSelectedGenresMulti();
          limit = Number(premiumLimit.value || "5");
          onlyOnline = (onlyStreamingP.value === "1");
        }

        const discover = await fetchDiscover(type, genreIds);
        const raw = Array.isArray(discover?.results) ? discover.results : [];

        // Nuova logica: qualità + score (voto + recenza)
        let scored = await getScoredResults(type, raw, onlyOnline);

        // Se non filtro online, aggiungo providers ai primi risultati per evitare lentezza
        if(!onlyOnline){
          scored = await enrichProvidersIfNeeded(type, scored);
        }

        // Applica limite richiesto
        const finalList = scored.slice(0, Math.max(1, limit));

        if(state.mode === "basic"){
          markBasicSearchUsed();
          updateLimitInfo();
        }

        resultsEl.innerHTML = "";

        if(!finalList.length){
          resultsEl.innerHTML = `<div class="card"><p class="title">Nessun risultato</p><p class="sub">Allarga i filtri o disattiva "Disponibile online".</p></div>`;
          return;
        }

        finalList.forEach(s => {
          const card = renderResult(s.it, type, s.m, s.providers);
          resultsEl.appendChild(card);
        });

        window.scrollTo({top: app.offsetTop, behavior:"smooth"});
      } catch(err){
        resultsEl.innerHTML = "";
        showToast("Errore durante la ricerca.");
      }
    }

    /* ========= CHIUSURA GRAFICA ========= */
    function showOutro(){
      // Fix: la grafica deve partire sempre, durare almeno 3 secondi,
      // poi mostra i bottoni. Evito race conditions usando requestAnimationFrame.
      outro.classList.add("show");
      outro.setAttribute("aria-hidden","false");

      btnCloseApp.disabled = true;
      btnBackApp.disabled = true;

      requestAnimationFrame(() => {
        setTimeout(() => {
          btnCloseApp.disabled = false;
          btnBackApp.disabled = false;
        }, 3000);
      });
    }

    function hideOutro(){
      outro.classList.remove("show");
      outro.setAttribute("aria-hidden","true");
    }

    function closeAppNow(){
      // Su Android WebView spesso window.close non funziona se la pagina non è stata aperta da script.
      // Quindi faccio fallback: torno alla intro e svuoto risultati.
      clearResults();
      app.classList.add("hidden");
      intro.classList.remove("hidden");
      hideOutro();
      showToast("Uscita eseguita.");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    /* ========= EVENTS ========= */
    btnGoBasic.addEventListener("click", () => {
      setMode("basic");
      switchToApp();
    });

    btnGoPremium.addEventListener("click", async () => {
      // Se non hai premium, apro Play Store.
      // Se hai premium o sblocco servizio, chiedo login.
      if(!(state.purchasedPremium || state.premiumUnlocked)){
        openPlayStore();
        return;
      }
      const ok = await showLogin();
      if(!ok) return;
      setMode("premium");
      switchToApp();
    });

    btnServiceUnlock.addEventListener("click", async () => {
      state.premiumUnlocked = true;
      showToast("Premium sbloccato per test.");
      const ok = await showLogin();
      if(!ok) return;
      setMode("premium");
      switchToApp();
    });

    btnSearch.addEventListener("click", runSearch);

    btnClear.addEventListener("click", () => {
      clearResults();
      showToast("Pulito.");
    });

    btnExit.addEventListener("click", () => {
      showOutro();
    });

    btnBackApp.addEventListener("click", () => {
      hideOutro();
    });

    btnCloseApp.addEventListener("click", () => {
      closeAppNow();
    });

    // Init
    setMode("basic");
  </script>
</body>
</html>
