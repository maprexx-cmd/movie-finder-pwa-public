<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Movie Finder</title>

<style>
:root{
  --bg1:#0f172a;
  --bg2:#020617;
  --card:#0b1220;
  --text:#ffffff;
  --muted:rgba(255,255,255,0.72);
  --acidY:#EFFF00;
  --acidG:#7CFF00;
  --blue:#0033cc;
}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:radial-gradient(circle at top,var(--bg1),var(--bg2));
  color:var(--text);
}

.container{
  max-width:420px;
  margin:40px auto;
  padding:20px;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  box-shadow:0 0 40px rgba(0,0,0,0.6);
}

h1{
  font-size:24px;
  margin:0 0 16px 0;
}

h2{
  font-size:20px;
  margin:0 0 10px 0;
}

p{
  color:var(--muted);
  margin:8px 0 0 0;
  line-height:1.35;
}

button{
  width:100%;
  margin-top:14px;
  padding:16px;
  border-radius:30px;
  border:none;
  background:linear-gradient(90deg,var(--acidY),var(--acidG));
  color:var(--blue);
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

.secondary{
  background:transparent;
  border:1px solid rgba(255,255,255,0.25);
  color:#fff;
}

.small{
  font-size:14px;
  padding:12px;
  border-radius:18px;
}

label{
  display:flex;
  align-items:center;
  margin:10px 0;
  font-size:16px;
}

input[type="checkbox"]{
  margin-right:10px;
  width:20px;
  height:20px;
  accent-color:var(--acidG);
}

input[type="email"], input[type="password"]{
  width:100%;
  box-sizing:border-box;
  margin-top:12px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.06);
  color:#fff;
  font-size:16px;
  outline:none;
}

.row{
  display:flex;
  gap:10px;
}

.row button{
  width:50%;
}

.hidden{
  display:none;
}

.result{
  margin-top:20px;
  background:var(--card);
  border-radius:18px;
  padding:20px;
  display:none;
}

.posterBox{
  width:100%;
  height:260px;
  border-radius:14px;
  margin-bottom:12px;
  background:#111827;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.posterBox img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.posterFallback{
  font-size:13px;
  color:var(--muted);
}

.close-btn{
  margin-top:16px;
  background:transparent;
  border:1px solid #444;
  color:#fff;
  padding:12px;
  border-radius:20px;
  cursor:pointer;
  width:auto;
}

.badge{
  display:inline-block;
  margin-top:10px;
  padding:8px 10px;
  border-radius:999px;
  background:rgba(255,255,255,0.08);
  color:var(--muted);
  font-size:13px;
}

.fade{
  position:fixed;
  inset:0;
  background:black;
  opacity:0;
  pointer-events:none;
  transition:opacity 600ms ease;
  z-index:998;
}

.fade.active{
  opacity:1;
  pointer-events:auto;
}

.overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  text-align:center;
  z-index:999;
  padding:20px;
}

.overlay.active{
  display:flex;
}

.overlay h2{
  font-size:26px;
  margin-bottom:10px;
}

.overlay p{
  color:var(--acidY);
  font-size:18px;
  font-weight:bold;
  margin-bottom:20px;
}
</style>
</head>

<body>

<div class="container">

  <div class="card" id="screenStart">
    <h1>Movie Finder</h1>
    <p>Scegli come vuoi usare l’app.</p>

    <button onclick="startBasic()">Continua senza account</button>

    <button class="secondary" onclick="openPremiumGate()">Area Premium</button>

    <span class="badge" id="modeBadge">Modalità: non selezionata</span>
  </div>

  <div class="card hidden" id="screenPremiumGate">
    <h1>Area Premium</h1>
    <p>Se non hai Premium, fai l’acquisto su Google Play. Se hai già Premium, entra con le credenziali.</p>

    <button onclick="goToPlayBilling()">Passa a Premium</button>

    <button class="secondary" onclick="openPremiumLogin()">Ho già pagato, accedi</button>

    <button class="secondary small" onclick="backToStart()">Indietro</button>
  </div>

  <div class="card hidden" id="screenPremiumLogin">
    <h1>Accesso Premium</h1>
    <p>Accedi con le credenziali.</p>

    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">

    <button onclick="loginPremium()">Entra</button>
    <button class="secondary small" onclick="backToPremiumGate()">Indietro</button>
  </div>

  <div class="card hidden" id="screenChooser">
    <h1 id="chooserTitle">Cosa guardi oggi?</h1>

    <div id="premiumTabs" class="row hidden">
      <button class="secondary small" onclick="setType('movie')" id="tabMovie">Film</button>
      <button class="secondary small" onclick="setType('tv')" id="tabTv">Serie TV</button>
    </div>

    <label><input type="checkbox" value="35" class="genre">Comico</label>
    <label><input type="checkbox" value="28" class="genre">Azione</label>
    <label><input type="checkbox" value="10749" class="genre">Romantico</label>

    <button onclick="findSomething()">Cosa guardi oggi?</button>

    <div class="result" id="resultBox">
      <div class="posterBox" id="posterBox">
        <div class="posterFallback" id="posterFallback">Locandina non disponibile</div>
      </div>
      <h2 id="title"></h2>
      <p id="overview"></p>

      <button class="close-btn" onclick="closeAfterResult()">Chiudi</button>
    </div>

    <button class="secondary small" onclick="resetAll()">Torna all’inizio</button>
  </div>

</div>

<div class="fade" id="fade"></div>

<div class="overlay" id="overlay">
  <h2>Sta per iniziare il film</h2>
  <p>Buona visione</p>
  <button onclick="exitApp()">Esci dalla app</button>
  <button class="secondary small" onclick="cancelExit()">Annulla</button>
</div>

<script>
const TMDB_KEY = "f8ecb75282e8dcea2d4845598cc7d030";

let isPremium = false;
let contentType = "movie";
let lastResultShown = false;

function show(id){
  document.getElementById("screenStart").classList.add("hidden");
  document.getElementById("screenPremiumGate").classList.add("hidden");
  document.getElementById("screenPremiumLogin").classList.add("hidden");
  document.getElementById("screenChooser").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

function startBasic(){
  isPremium = false;
  document.getElementById("modeBadge").textContent = "Modalità: BASIC";
  document.getElementById("premiumTabs").classList.add("hidden");
  contentType = "movie";
  lastResultShown = false;
  show("screenChooser");
  updateTabsUI();
}

function openPremiumGate(){
  show("screenPremiumGate");
}

function goToPlayBilling(){
  alert("Qui devi collegare Google Play Billing nella versione app. Per ora è un placeholder.");
}

function openPremiumLogin(){
  show("screenPremiumLogin");
}

function loginPremium(){
  const email = (document.getElementById("email").value || "").trim();
  const password = (document.getElementById("password").value || "").trim();

  if(!email || !password){
    alert("Inserisci email e password.");
    return;
  }

  isPremium = true;
  document.getElementById("modeBadge").textContent = "Modalità: PREMIUM";
  document.getElementById("premiumTabs").classList.remove("hidden");
  contentType = "movie";
  lastResultShown = false;
  show("screenChooser");
  updateTabsUI();
}

function backToStart(){
  show("screenStart");
}

function backToPremiumGate(){
  show("screenPremiumGate");
}

function setType(type){
  if(!isPremium) return;
  contentType = type;
  updateTabsUI();
}

function updateTabsUI(){
  if(!isPremium) return;
  const tabMovie = document.getElementById("tabMovie");
  const tabTv = document.getElementById("tabTv");
  tabMovie.style.borderColor = (contentType==="movie") ? "rgba(255,255,255,0.6)" : "rgba(255,255,255,0.25)";
  tabTv.style.borderColor = (contentType==="tv") ? "rgba(255,255,255,0.6)" : "rgba(255,255,255,0.25)";
}

function getSelectedGenres(){
  return Array.from(document.querySelectorAll(".genre:checked")).map(x => x.value);
}

async function findSomething(){
  const genres = getSelectedGenres();
  if(genres.length === 0){
    alert("Seleziona almeno un genere.");
    return;
  }

  const resultBox = document.getElementById("resultBox");
  resultBox.style.display = "none";

  const url = buildDiscoverUrl(genres);

  try{
    const res = await fetch(url);
    const data = await res.json();

    if(!data || !data.results || data.results.length === 0){
      alert("Nessun risultato con questi generi. Prova a cambiare selezione.");
      return;
    }

    const pick = data.results[Math.floor(Math.random() * data.results.length)];

    renderResult(pick);
    lastResultShown = true;
  }catch(e){
    alert("Errore di rete. Riprova.");
  }
}

function buildDiscoverUrl(genres){
  const base = (contentType === "tv")
    ? "https://api.themoviedb.org/3/discover/tv"
    : "https://api.themoviedb.org/3/discover/movie";

  const params = new URLSearchParams();
  params.set("api_key", TMDB_KEY);
  params.set("language", "it-IT");
  params.set("sort_by", "popularity.desc");
  params.set("include_adult", "false");
  params.set("with_genres", genres.join(","));
  params.set("with_genres_operator", "AND");

  return base + "?" + params.toString();
}

function renderResult(item){
  const title = document.getElementById("title");
  const overview = document.getElementById("overview");
  const resultBox = document.getElementById("resultBox");

  const name = item.title || item.name || "Titolo non disponibile";
  const desc = item.overview || "Descrizione non disponibile";

  title.textContent = name;
  overview.textContent = desc;

  renderPoster(item.poster_path);

  resultBox.style.display = "block";
}

function renderPoster(posterPath){
  const box = document.getElementById("posterBox");
  const fallback = document.getElementById("posterFallback");

  box.innerHTML = "";
  if(!posterPath){
    fallback.style.display = "block";
    box.appendChild(fallback);
    return;
  }

  const img = document.createElement("img");
  img.src = "https://image.tmdb.org/t/p/w500" + posterPath;
  img.alt = "Locandina";
  img.onload = () => {};
  img.onerror = () => {
    box.innerHTML = "";
    fallback.style.display = "block";
    box.appendChild(fallback);
  };

  fallback.style.display = "none";
  box.appendChild(img);
}

function closeAfterResult(){
  if(!lastResultShown){
    alert("Prima trova un risultato.");
    return;
  }
  startExitEffect();
}

function startExitEffect(){
  const fade = document.getElementById("fade");
  const overlay = document.getElementById("overlay");

  fade.classList.add("active");
  setTimeout(() => {
    overlay.classList.add("active");
  }, 500);
}

function cancelExit(){
  const fade = document.getElementById("fade");
  const overlay = document.getElementById("overlay");
  overlay.classList.remove("active");
  fade.classList.remove("active");
}

function exitApp(){
  cancelExit();

  try{
    window.close();
  }catch(e){}

  setTimeout(() => {
    alert("Se il browser non chiude la scheda, chiudila tu. Nell’app Android questo comando può chiudere l’app.");
  }, 150);
}

function resetAll(){
  document.querySelectorAll(".genre").forEach(x => x.checked = false);
  document.getElementById("resultBox").style.display = "none";
  lastResultShown = false;
  show("screenStart");
}
</script>

</body>
</html>
