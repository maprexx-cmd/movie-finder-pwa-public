<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Finder</title>
  <style>
    :root{
      --bg:#0b0720;
      --card:#151033;
      --card2:#0f0a28;
      --text:#f3f1ff;
      --muted:#b9b2e6;
      --violet:#7c3aed;
      --violet2:#5b21b6;
      --yellow:#ffd400;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 500px at 10% 30%, rgba(255,212,0,.10), transparent 55%),
                  linear-gradient(180deg, #070516, var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1040px;margin:0 auto;padding:18px 14px 80px}
    .topbar{
      position:sticky;top:0;z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(7,5,22,.70);
      border-bottom:1px solid var(--border);
    }
    .topbar .wrap{padding:14px}
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, var(--yellow), #fff0 55%),
                  linear-gradient(135deg, var(--violet), var(--violet2));
      box-shadow: 0 10px 24px rgba(124,58,237,.35);
    }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .screen{display:none;animation:fade .35s ease forwards}
    .screen.active{display:block}
    @keyframes fade{from{opacity:0;transform: translateY(6px)}to{opacity:1;transform:none}}

    .hero{
      margin-top:18px;
      padding:18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(124,58,237,.22), rgba(255,212,0,.06));
      box-shadow: var(--shadow);
    }
    .hero h2{margin:0 0 8px;font-size:18px}
    .hero .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.04);
    }

    .grid2{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:860px){ .grid2{grid-template-columns:1fr 1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h3{margin:0 0 6px;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:12px 14px;border-radius:14px;
      color:#0b0720;font-weight:700;
      background: var(--yellow);
      box-shadow: 0 12px 26px rgba(255,212,0,.22);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    button.danger{
      background: rgba(255,70,70,.18);
      color: #ffd6d6;
      border:1px solid rgba(255,70,70,.25);
      box-shadow:none;
    }
    button:disabled{
      opacity:.45;cursor:not-allowed;
    }

    .sectionTitle{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
      margin:18px 2px 10px;
    }
    .sectionTitle h2{margin:0;font-size:16px}
    .sectionTitle .small{color:var(--muted);font-size:12px}

    .modeBar{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(255,255,255,.03);
      padding:10px;
    }
    .toggle{
      display:flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .toggle input{accent-color: var(--yellow);}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size:13px;
    }
    .chip input{accent-color: var(--yellow);}

    .sliders{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:860px){ .sliders{grid-template-columns:1fr 1fr} }
    .sliderRow{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    .sliderRow .hdr{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:6px;
    }
    .sliderRow .hdr span{font-size:13px;color:var(--muted)}
    .sliderRow .hdr strong{font-size:13px}
    input[type="range"]{
      width:100%;
      accent-color: var(--yellow);
    }

    .results{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .resultCard{
      display:grid;
      grid-template-columns:92px 1fr;
      gap:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .poster{
      width:92px;height:138px;border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color: var(--muted);font-size:11px;text-align:center;padding:8px;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .resultCard h4{margin:0 0 6px;font-size:15px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-bottom:8px}
    .plot{margin:0;color:var(--text);opacity:.92;font-size:13px;line-height:1.35}
    .providers{margin-top:10px;display:grid;gap:10px}
    .provGroup{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px;
      background: rgba(0,0,0,.10);
    }
    .provGroup .t{font-size:12px;color:var(--muted);margin:0 0 8px}
    .provList{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .provItem{display:flex;gap:8px;align-items:center}
    .provItem img{
      width:22px;height:22px;border-radius:6px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .provItem span{font-size:12px;color:var(--text)}
    .note{color:var(--muted);font-size:12px;margin-top:10px}
    .footerRow{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .badge{
      font-size:12px;color:#120d2a;background: var(--yellow);
      padding:6px 10px;border-radius:999px;font-weight:800;
    }
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid var(--border);
      color: var(--text);
      padding:10px 12px;border-radius:14px;
      max-width:92vw;
      display:none;
      z-index:50;
      font-size:13px;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block;animation:fade .25s ease forwards}
    a.link{color:var(--yellow);text-decoration:none}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Movie Finder</h1>
          <p>Film e serie, con piattaforme disponibili in Italia</p>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- SCHERMATA START -->
    <div id="screenStart" class="screen active">
      <div class="hero">
        <h2>Trova cosa guardare in pochi secondi</h2>
        <div class="row">
          <div class="pill">Basic, 1 ricerca al giorno</div>
          <div class="pill">Premium, ricerche illimitate</div>
          <div class="pill">Locandina, trama, statistiche</div>
          <div class="pill">Piattaforme, abbonamento, noleggio, acquisto</div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <h3>Basic</h3>
          <p>Film בלבד. 4 generi. 1 ricerca al giorno. 3 risultati.</p>
          <div class="btnRow">
            <button id="btnGoBasic">Entra in Basic</button>
            <button class="secondary" id="btnInfoBasic">Dettagli</button>
          </div>
        </div>

        <div class="card">
          <h3>Premium</h3>
          <p>Film e serie. Slider intensità. Filtri piattaforme. Ricerche illimitate. 5 risultati.</p>
          <div class="btnRow">
            <button id="btnGoPremium">Entra in Premium</button>
            <button class="secondary" id="btnBuyPremium">Sblocca Premium</button>
          </div>
          <div class="note" id="premiumStatus"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Prima cosa da fare</h3>
        <p>Inserisci la tua API key di TMDB nel codice. Senza, la ricerca non parte.</p>
        <p class="note">
          Vai su TMDB, crea una API key, poi incollala in TMDB_API_KEY.
          Se non sai dove, cerca nel file la stringa INCOLLA_LA_TUA_API_KEY.
        </p>
      </div>
    </div>

    <!-- SCHERMATA BASIC -->
    <div id="screenBasic" class="screen">
      <div class="sectionTitle">
        <h2>Basic</h2>
        <div class="small">1 ricerca al giorno, 3 risultati</div>
      </div>

      <div class="modeBar">
        <div class="toggle">
          <input type="radio" name="basicType" checked />
          <div>
            <div style="font-weight:800">Film</div>
            <div class="tiny">Disponibile</div>
          </div>
        </div>

        <div class="toggle" style="opacity:.55">
          <input type="radio" name="basicType" disabled />
          <div>
            <div style="font-weight:800">Serie TV</div>
            <div class="tiny">Non disponibile in Basic</div>
          </div>
        </div>

        <div style="flex:1"></div>

        <button class="secondary" id="btnBackFromBasic">Indietro</button>
      </div>

      <div class="sectionTitle">
        <h2>Seleziona generi</h2>
        <div class="small">Scegli 1 o più</div>
      </div>

      <div class="chips" id="basicGenres">
        <label class="chip"><input type="checkbox" value="azione" /> Azione</label>
        <label class="chip"><input type="checkbox" value="comico" /> Comico</label>
        <label class="chip"><input type="checkbox" value="thriller" /> Thriller</label>
        <label class="chip"><input type="checkbox" value="animazione" /> Animazione</label>
      </div>

      <div class="sectionTitle">
        <h2>Filtri piattaforme</h2>
        <div class="small">Italia</div>
      </div>

      <div class="card">
        <div class="chips" id="basicProvidersPick"></div>
        <div class="btnRow">
          <label class="chip"><input id="basicOnlyOnline" type="checkbox" /> Mostra solo disponibili online</label>
        </div>
        <p class="note">Se non selezioni piattaforme, la ricerca non filtra. Mostra solo dove sono disponibili i risultati.</p>
      </div>

      <div class="btnRow" style="margin-top:12px">
        <button id="btnBasicSearch">Cerca</button>
        <button class="secondary" id="btnBasicResetShown">Reset risultati mostrati</button>
      </div>

      <div class="note" id="basicLimitInfo"></div>

      <div id="basicResults" class="results"></div>
    </div>

    <!-- SCHERMATA PREMIUM -->
    <div id="screenPremium" class="screen">
      <div class="sectionTitle">
        <h2>Premium</h2>
        <div class="small">Ricerche illimitate, 5 risultati</div>
      </div>

      <div class="modeBar">
        <label class="toggle">
          <input id="premiumPickMovie" type="radio" name="premiumType" value="movie" checked />
          <div>
            <div style="font-weight:800">Film</div>
            <div class="tiny">TMDB</div>
          </div>
        </label>

        <label class="toggle">
          <input id="premiumPickTv" type="radio" name="premiumType" value="tv" />
          <div>
            <div style="font-weight:800">Serie TV</div>
            <div class="tiny">TMDB</div>
          </div>
        </label>

        <div style="flex:1"></div>

        <button class="secondary" id="btnBackFromPremium">Indietro</button>
      </div>

      <div class="sectionTitle">
        <h2>Intensità generi</h2>
        <div class="small">0, 5</div>
      </div>

      <div class="sliders" id="premiumSliders"></div>

      <div class="sectionTitle">
        <h2>Filtri piattaforme</h2>
        <div class="small">Italia</div>
      </div>

      <div class="card">
        <div class="chips" id="premiumProvidersPick"></div>
        <div class="btnRow">
          <label class="chip"><input id="premiumOnlyOnline" type="checkbox" checked /> Mostra solo disponibili online</label>
          <label class="chip"><input id="monFlatrate" type="checkbox" checked /> Abbonamento</label>
          <label class="chip"><input id="monRent" type="checkbox" /> Noleggio</label>
          <label class="chip"><input id="monBuy" type="checkbox" /> Acquisto</label>
        </div>
        <p class="note">Se selezioni piattaforme, la ricerca filtra già i risultati. Se non selezioni nulla, mostra solo le piattaforme trovate su ogni titolo.</p>
      </div>

      <div class="btnRow" style="margin-top:12px">
        <button id="btnPremiumSearch">Cerca</button>
        <button class="secondary" id="btnPremiumResetShown">Reset risultati mostrati</button>
        <button class="danger" id="btnLockPremium">Blocca Premium</button>
      </div>

      <div class="note" id="premiumGateInfo"></div>

      <div id="premiumResults" class="results"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ============================
   CONFIG
   ============================ */

const TMDB_API_KEY = "INCOLLA_LA_TUA_API_KEY";
const TMDB_LANG = "it-IT";
const TMDB_REGION = "IT";

const POSTER_W342 = "https://image.tmdb.org/t/p/w342";
const LOGO_W45 = "https://image.tmdb.org/t/p/w45";

const LS = {
  premium: "mf_premium_purchased",
  lastBasicSearchDate: "mf_basic_last_search_date",
  shownMovies: "mf_shown_movies",
  shownTv: "mf_shown_tv"
};

const GENRE_MAP_MOVIE = {
  azione: 28,
  comico: 35,
  thriller: 53,
  animazione: 16,
  romantico: 10749,
  dramma: 18,
  horror: 27,
  fantascienza: 878,
  avventura: 12,
  crime: 80
};

const GENRE_MAP_TV = {
  azione: 10759,        // Action & Adventure
  comico: 35,           // Comedy
  thriller: 9648,       // Mystery come proxy thriller
  animazione: 16,       // Animation
  romantico: 10749,     // Romance
  dramma: 18,           // Drama
  horror: 9648,         // non perfetto, ma mantiene filtro "tensione"
  fantascienza: 10765,  // Sci-Fi & Fantasy
  avventura: 10759,     // Action & Adventure
  crime: 80             // Crime
};

/* Provider IDs comuni in Italia.
   Se vuoi, aggiungine altri. */
const PROVIDERS = [
  { id: 8,   name: "Netflix" },
  { id: 119, name: "Prime Video" },
  { id: 337, name: "Disney+" },
  { id: 350, name: "Apple TV" },
  { id: 384, name: "HBO Max" },
  { id: 39,  name: "NOW" },
  { id: 2,   name: "Apple iTunes" },
  { id: 35,  name: "Rakuten TV" },
  { id: 283, name: "Crunchyroll" },
  { id: 386, name: "Peacock" }
];

/* ============================
   UI HELPERS
   ============================ */

const el = (id) => document.getElementById(id);

function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), 2400);
}

function showScreen(name){
  const screens = ["screenStart","screenBasic","screenPremium"];
  screens.forEach(s => el(s).classList.remove("active"));
  el(name).classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
}

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

function hasApiKey(){
  return TMDB_API_KEY && TMDB_API_KEY !== "INCOLLA_LA_TUA_API_KEY";
}

function randInt(min, max){
  const range = max - min + 1;
  const buf = new Uint32Array(1);
  crypto.getRandomValues(buf);
  return min + (buf[0] % range);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = randInt(0,i);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function tmdbFetch(url){
  const res = await fetch(url, {
    method: "GET",
    cache: "no-store",
    headers: { "Accept": "application/json" }
  });
  if(!res.ok) throw new Error("TMDB HTTP " + res.status);
  return res.json();
}

/* ============================
   PREMIUM GATE
   ============================ */

function isPremiumPurchased(){
  return localStorage.getItem(LS.premium) === "1";
}

function setPremiumPurchased(v){
  localStorage.setItem(LS.premium, v ? "1" : "0");
  refreshPremiumStatus();
}

function refreshPremiumStatus(){
  const st = el("premiumStatus");
  if(isPremiumPurchased()){
    st.textContent = "Premium attivo su questo dispositivo.";
  }else{
    st.textContent = "Premium non attivo. Premi Sblocca Premium per simulare l'acquisto.";
  }
}

function refreshPremiumGateInfo(){
  const info = el("premiumGateInfo");
  if(isPremiumPurchased()){
    info.textContent = "Ok. Premi Cerca per ottenere 5 risultati coerenti con gli slider.";
  }else{
    info.textContent = "Premium bloccato. Premi Sblocca Premium nella home, oppure usa Basic.";
  }
}

/* ============================
   BASIC LIMIT
   ============================ */

function canBasicSearch(){
  const last = localStorage.getItem(LS.lastBasicSearchDate) || "";
  return last !== todayISO();
}

function markBasicSearched(){
  localStorage.setItem(LS.lastBasicSearchDate, todayISO());
}

function refreshBasicLimitInfo(){
  const info = el("basicLimitInfo");
  const last = localStorage.getItem(LS.lastBasicSearchDate) || "";
  if(canBasicSearch()){
    info.textContent = "Puoi fare 1 ricerca oggi.";
  }else{
    info.textContent = "Hai già fatto la ricerca oggi. Riprova domani.";
  }
}

/* ============================
   SHOWN ITEMS, NO DUPLICATES
   ============================ */

function loadShownSet(kind){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return new Set();
    return new Set(arr);
  }catch{
    return new Set();
  }
}

function saveShownSet(kind, set){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  const arr = Array.from(set).slice(0, 1500);
  localStorage.setItem(key, JSON.stringify(arr));
}

function resetShown(kind){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  localStorage.removeItem(key);
}

/* ============================
   PROVIDER PICK UI
   ============================ */

function buildProviderPick(containerId){
  const box = el(containerId);
  box.innerHTML = "";
  PROVIDERS.forEach(p => {
    const lab = document.createElement("label");
    lab.className = "chip";
    lab.innerHTML = `<input type="checkbox" value="${p.id}"> ${p.name}`;
    box.appendChild(lab);
  });
}

function readPickedProviders(containerId){
  const box = el(containerId);
  const ids = [];
  box.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if(cb.checked) ids.push(cb.value);
  });
  return ids.join("|");
}

/* ============================
   SLIDERS UI
   ============================ */

const PREMIUM_GENRES = [
  { key:"azione", label:"Azione" },
  { key:"comico", label:"Comico" },
  { key:"thriller", label:"Thriller" },
  { key:"animazione", label:"Animazione" },
  { key:"romantico", label:"Romantico" },
  { key:"dramma", label:"Dramma" },
  { key:"horror", label:"Horror" },
  { key:"fantascienza", label:"Fantascienza" },
  { key:"avventura", label:"Avventura" },
  { key:"crime", label:"Crime" }
];

function buildPremiumSliders(){
  const root = el("premiumSliders");
  root.innerHTML = "";
  PREMIUM_GENRES.forEach(g => {
    const row = document.createElement("div");
    row.className = "sliderRow";
    row.innerHTML = `
      <div class="hdr">
        <strong>${g.label}</strong>
        <span id="val_${g.key}">0</span>
      </div>
      <input id="s_${g.key}" type="range" min="0" max="5" step="1" value="0" />
    `;
    root.appendChild(row);
    const inp = row.querySelector("input");
    inp.addEventListener("input", () => {
      el("val_"+g.key).textContent = inp.value;
    });
  });
}

function readPremiumWeights(){
  const weights = {};
  PREMIUM_GENRES.forEach(g => {
    const v = Number(el("s_"+g.key).value || 0);
    weights[g.key] = v;
  });
  return weights;
}

function pickTopGenres(weights, maxCount){
  const arr = Object.keys(weights)
    .map(k => ({ k, v: weights[k] }))
    .filter(x => x.v > 0)
    .sort((a,b) => b.v - a.v);

  if(arr.length === 0){
    return [];
  }
  return arr.slice(0, maxCount).map(x => x.k);
}

/* ============================
   TMDB DISCOVER LOGIC
   ============================ */

function buildDiscoverParams({ kind, genreCsv, providerCsv, onlyOnline, monetizationCsv }){
  const params = new URLSearchParams();
  params.set("api_key", TMDB_API_KEY);
  params.set("language", TMDB_LANG);
  params.set("region", TMDB_REGION);
  params.set("watch_region", TMDB_REGION);

  params.set("include_adult", "false");
  params.set("include_video", "false");

  params.set("vote_count.gte", "150");
  params.set("vote_average.gte", "6.0");

  if(kind === "movie"){
    params.set("primary_release_date.gte", "1980-01-01");
  }else{
    params.set("first_air_date.gte", "1980-01-01");
  }

  if(genreCsv) params.set("with_genres", genreCsv);

  if(providerCsv){
    params.set("with_watch_providers", providerCsv);
  }
  if(monetizationCsv){
    params.set("with_watch_monetization_types", monetizationCsv);
  }

  const sortPool = ["popularity.desc","vote_average.desc","revenue.desc"];
  params.set("sort_by", sortPool[randInt(0, sortPool.length-1)]);

  return params;
}

async function fetchDiscover({ kind, params, page }){
  params.set("page", String(page));
  const endpoint = kind === "movie" ? "discover/movie" : "discover/tv";
  const url = `https://api.themoviedb.org/3/${endpoint}?` + params.toString();
  return tmdbFetch(url);
}

async function getProvidersForItem(kind, id){
  const endpoint = kind === "movie" ? `movie/${id}/watch/providers` : `tv/${id}/watch/providers`;
  const url = `https://api.themoviedb.org/3/${endpoint}?api_key=${encodeURIComponent(TMDB_API_KEY)}`;
  const data = await tmdbFetch(url);
  const it = data && data.results ? data.results[TMDB_REGION] : null;
  if(!it) return null;

  return {
    link: it.link || "",
    flatrate: Array.isArray(it.flatrate) ? it.flatrate : [],
    rent: Array.isArray(it.rent) ? it.rent : [],
    buy: Array.isArray(it.buy) ? it.buy : []
  };
}

function hasAnyProvider(p){
  if(!p) return false;
  return (p.flatrate && p.flatrate.length) || (p.rent && p.rent.length) || (p.buy && p.buy.length);
}

async function getRandomItems({
  kind,
  genreCsv,
  providerCsv,
  onlyOnline,
  monetizationCsv,
  count
}){
  const shown = loadShownSet(kind);

  const params = buildDiscoverParams({
    kind,
    genreCsv,
    providerCsv,
    onlyOnline,
    monetizationCsv
  });

  const maxTries = 7;
  const pageMax = 20;
  const collected = [];

  for(let t=0; t<maxTries && collected.length < count; t++){
    const page = randInt(1, pageMax);
    const data = await fetchDiscover({ kind, params: new URLSearchParams(params.toString()), page });

    const results = Array.isArray(data.results) ? data.results.slice() : [];
    shuffle(results);

    for(const item of results){
      const id = item && item.id ? String(item.id) : "";
      if(!id) continue;
      if(shown.has(id)) continue;

      const poster = item.poster_path ? item.poster_path : "";
      if(!poster) continue;

      let providers = null;
      try{
        providers = await getProvidersForItem(kind, id);
      }catch{
        providers = null;
      }

      if(onlyOnline && !hasAnyProvider(providers)){
        continue;
      }

      shown.add(id);
      collected.push({ item, providers });
      if(collected.length >= count) break;
    }
  }

  saveShownSet(kind, shown);
  return collected;
}

/* ============================
   RENDER
   ============================ */

function formatYear(kind, item){
  const d = kind === "movie" ? item.release_date : item.first_air_date;
  if(!d) return "";
  return String(d).slice(0,4);
}

function formatRating(item){
  const v = typeof item.vote_average === "number" ? item.vote_average.toFixed(1) : "-";
  const c = typeof item.vote_count === "number" ? item.vote_count : "-";
  return `Voto ${v}, voti ${c}`;
}

function shortPlot(text){
  if(!text) return "Trama non disponibile.";
  const t = String(text).trim();
  if(t.length <= 240) return t;
  return t.slice(0, 240) + "...";
}

function renderProvidersBlock(p){
  if(!p) return `<div class="note">Piattaforme non disponibili per IT.</div>`;

  const makeGroup = (title, list) => {
    if(!list || !list.length) return "";
    const items = list.slice(0, 10).map(x => {
      const logo = x.logo_path ? (LOGO_W45 + x.logo_path) : "";
      const img = logo ? `<img src="${logo}" alt="">` : `<img alt="">`;
      const nm = x.provider_name ? x.provider_name : "";
      return `<div class="provItem">${img}<span>${nm}</span></div>`;
    }).join("");
    return `
      <div class="provGroup">
        <p class="t">${title}</p>
        <div class="provList">${items}</div>
      </div>
    `;
  };

  const blocks = [
    makeGroup("Abbonamento", p.flatrate),
    makeGroup("Noleggio", p.rent),
    makeGroup("Acquisto", p.buy)
  ].filter(Boolean).join("");

  const link = p.link ? `<div class="note">Link: <a class="link" href="${p.link}" target="_blank" rel="noopener">Apri</a></div>` : "";

  if(!blocks){
    return `<div class="note">Nessuna piattaforma trovata per IT.</div>${link}`;
  }
  return `<div class="providers">${blocks}</div>${link}`;
}

function renderResults(containerId, kind, entries, titleSuffix){
  const root = el(containerId);
  if(!entries || !entries.length){
    root.innerHTML = `<div class="card"><h3>Nessun risultato</h3><p>Allarga i filtri o resetta i risultati mostrati.</p></div>`;
    return;
  }

  const html = entries.map(e => {
    const item = e.item;
    const providers = e.providers;

    const name = kind === "movie" ? item.title : item.name;
    const year = formatYear(kind, item);
    const rating = formatRating(item);
    const pop = typeof item.popularity === "number" ? item.popularity.toFixed(0) : "-";

    const posterUrl = POSTER_W342 + item.poster_path;

    return `
      <div class="resultCard">
        <div class="poster"><img src="${posterUrl}" alt=""></div>
        <div>
          <h4>${name || "Titolo"}</h4>
          <div class="meta">
            <div>${year ? "Anno " + year : "Anno -"}</div>
            <div>${rating}</div>
            <div>Pop ${pop}</div>
            <div>${titleSuffix}</div>
          </div>
          <p class="plot">${shortPlot(item.overview)}</p>
          ${renderProvidersBlock(providers)}
        </div>
      </div>
    `;
  }).join("");

  root.innerHTML = html;
}

/* ============================
   BASIC ACTIONS
   ============================ */

function readBasicSelectedGenres(){
  const ids = [];
  document.querySelectorAll("#basicGenres input[type='checkbox']").forEach(cb => {
    if(cb.checked){
      const key = cb.value;
      const id = GENRE_MAP_MOVIE[key];
      if(id) ids.push(id);
    }
  });
  return ids.join(",");
}

async function runBasic(){
  if(!hasApiKey()){
    toast("Inserisci la tua API key di TMDB.");
    return;
  }
  if(!canBasicSearch()){
    toast("Hai già fatto la ricerca oggi.");
    refreshBasicLimitInfo();
    return;
  }

  const genreCsv = readBasicSelectedGenres();
  if(!genreCsv){
    toast("Seleziona almeno 1 genere.");
    return;
  }

  const providerCsv = readPickedProviders("basicProvidersPick");
  const onlyOnline = el("basicOnlyOnline").checked;

  el("btnBasicSearch").disabled = true;
  el("basicResults").innerHTML = `<div class="card"><h3>Ricerca in corso</h3><p>Sto cercando risultati coerenti, con piattaforme in IT.</p></div>`;

  try{
    const entries = await getRandomItems({
      kind: "movie",
      genreCsv,
      providerCsv,
      onlyOnline,
      monetizationCsv: "",
      count: 3
    });
    renderResults("basicResults", "movie", entries, "Basic");
    markBasicSearched();
    refreshBasicLimitInfo();
    toast("Fatto.");
  }catch(err){
    el("basicResults").innerHTML = `<div class="card"><h3>Errore</h3><p>Controlla API key, rete e riprova.</p><p class="note">${String(err || "")}</p></div>`;
    toast("Errore TMDB.");
  }finally{
    el("btnBasicSearch").disabled = false;
  }
}

/* ============================
   PREMIUM ACTIONS
   ============================ */

function getPremiumKind(){
  const v = document.querySelector('input[name="premiumType"]:checked');
  return v ? v.value : "movie";
}

function buildGenreCsvForPremium(kind, weights){
  const top = pickTopGenres(weights, 3);
  if(top.length === 0) return "";

  const map = kind === "movie" ? GENRE_MAP_MOVIE : GENRE_MAP_TV;
  const ids = top.map(k => map[k]).filter(Boolean);
  return ids.join(",");
}

function buildMonetizationCsv(){
  const m = [];
  if(el("monFlatrate").checked) m.push("flatrate");
  if(el("monRent").checked) m.push("rent");
  if(el("monBuy").checked) m.push("buy");
  return m.join("|");
}

async function runPremium(){
  if(!hasApiKey()){
    toast("Inserisci la tua API key di TMDB.");
    return;
  }
  if(!isPremiumPurchased()){
    toast("Premium bloccato.");
    refreshPremiumGateInfo();
    return;
  }

  const kind = getPremiumKind();
  const weights = readPremiumWeights();

  const genreCsv = buildGenreCsvForPremium(kind, weights);
  if(!genreCsv){
    toast("Alza almeno 1 slider.");
    return;
  }

  const providerCsv = readPickedProviders("premiumProvidersPick");
  const onlyOnline = el("premiumOnlyOnline").checked;
  const monetizationCsv = buildMonetizationCsv();

  el("btnPremiumSearch").disabled = true;
  el("premiumResults").innerHTML = `<div class="card"><h3>Ricerca in corso</h3><p>Sto cercando risultati coerenti con gli slider e le piattaforme.</p></div>`;

  try{
    const entries = await getRandomItems({
      kind,
      genreCsv,
      providerCsv,
      onlyOnline,
      monetizationCsv,
      count: 5
    });
    renderResults("premiumResults", kind, entries, "Premium");
    toast("Fatto.");
  }catch(err){
    el("premiumResults").innerHTML = `<div class="card"><h3>Errore</h3><p>Controlla API key, rete e riprova.</p><p class="note">${String(err || "")}</p></div>`;
    toast("Errore TMDB.");
  }finally{
    el("btnPremiumSearch").disabled = false;
  }
}

/* ============================
   WIRES
   ============================ */

function init(){
  refreshPremiumStatus();
  refreshBasicLimitInfo();

  buildProviderPick("basicProvidersPick");
  buildProviderPick("premiumProvidersPick");
  buildPremiumSliders();
  refreshPremiumGateInfo();

  el("btnGoBasic").addEventListener("click", () => {
    showScreen("screenBasic");
    refreshBasicLimitInfo();
  });

  el("btnGoPremium").addEventListener("click", () => {
    showScreen("screenPremium");
    refreshPremiumGateInfo();
  });

  el("btnBuyPremium").addEventListener("click", () => {
    setPremiumPurchased(true);
    toast("Premium attivato su questo dispositivo.");
  });

  el("btnInfoBasic").addEventListener("click", () => {
    toast("Basic: Film, 4 generi, 1 ricerca al giorno, 3 risultati.");
  });

  el("btnBackFromBasic").addEventListener("click", () => showScreen("screenStart"));
  el("btnBackFromPremium").addEventListener("click", () => showScreen("screenStart"));

  el("btnBasicSearch").addEventListener("click", runBasic);
  el("btnPremiumSearch").addEventListener("click", runPremium);

  el("btnBasicResetShown").addEventListener("click", () => {
    resetShown("movie");
    el("basicResults").innerHTML = "";
    toast("Reset fatto.");
  });

  el("btnPremiumResetShown").addEventListener("click", () => {
    const kind = getPremiumKind();
    resetShown(kind);
    el("premiumResults").innerHTML = "";
    toast("Reset fatto.");
  });

  el("btnLockPremium").addEventListener("click", () => {
    setPremiumPurchased(false);
    el("premiumResults").innerHTML = "";
    refreshPremiumGateInfo();
    toast("Premium bloccato.");
  });

  document.querySelectorAll('input[name="premiumType"]').forEach(r => {
    r.addEventListener("change", () => {
      el("premiumResults").innerHTML = "";
      toast(getPremiumKind() === "movie" ? "Modalità Film" : "Modalità Serie TV");
    });
  });

  el("premiumOnlyOnline").addEventListener("change", () => {
    const v = el("premiumOnlyOnline").checked ? "Solo online" : "Anche offline";
    toast(v);
  });

  refreshPremiumGateInfo();

  if(!hasApiKey()){
    toast("Inserisci la tua API key TMDB nel codice.");
  }
}

init();
</script>
</body>
</html>
