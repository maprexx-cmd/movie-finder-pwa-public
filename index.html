<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>Movie Finder</title>

  <style>
    :root{
      --bg0:#050813;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.03);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.10);
      --y:#d9ff2f;
      --g:#39ff6b;
      --blue:#1e40af;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1000px 600px at 25% 15%, rgba(217,255,47,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 25%, rgba(57,255,107,.09), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      padding:18px 14px 34px;
    }
    .wrap{max-width:980px;margin:0 auto;}
    .topline{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:13px;color:var(--muted);margin-bottom:12px;opacity:.95;
      flex-wrap:wrap;
    }
    .topline a{color:var(--y);text-decoration:none}
    .brand{display:flex;align-items:center;gap:12px;margin:10px 0 16px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(217,255,47,.95), rgba(57,255,107,.85));
      box-shadow:0 12px 40px rgba(217,255,47,.12);
      display:grid;place-items:center;color:#0b1020;font-weight:1000;
    }
    .brand h1{margin:0;font-size:22px;letter-spacing:.2px}
    .brand .sub{color:var(--muted);margin-top:2px;font-size:13px}
    .card{
      background:linear-gradient(180deg, var(--card), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:14px;
    }
    h2{margin:0 0 10px;font-size:20px}
    h3{margin:0 0 8px;font-size:15px}
    p{margin:0 0 10px;color:var(--muted);line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      border-radius:999px;
      padding:12px 16px;
      font-weight:1000;
      cursor:pointer;
      background:rgba(255,255,255,.02);
      color:var(--text);
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{
      border:none;
      background:linear-gradient(90deg, var(--y), var(--g));
      color:var(--blue);
      box-shadow:0 18px 45px rgba(217,255,47,.18);
    }
    .btnGhost{background:rgba(255,255,255,.02)}
    .btnSmall{padding:10px 12px;font-weight:1000}
    .btnDanger{border:1px solid rgba(255,255,255,.16);color:#ffb4b4}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:12px;
    }
    .pill strong{color:var(--text)}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      color:var(--text);
      outline:none;
    }
    .toggleRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:10px;padding:10px 12px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);border-radius:16px;
    }
    .toggleRow span{color:var(--muted);font-size:13px}
    .toggleRow input{width:22px;height:22px;accent-color:var(--g);}
    .genres{display:grid;gap:8px;margin-top:10px;max-height:380px;overflow:auto;padding-right:4px;}
    .genreRow{
      display:grid;grid-template-columns:1.35fr .65fr;gap:10px;align-items:center;
      border:1px solid var(--line);background:rgba(255,255,255,.02);
      border-radius:14px;padding:10px 12px;
    }
    .genreName{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{
      min-width:34px;text-align:center;
      padding:6px 10px;border-radius:999px;
      background:rgba(217,255,47,.12);
      border:1px solid rgba(217,255,47,.25);
      color:var(--y);
      font-weight:1000;
      font-size:12px;
    }
    input[type="range"]{width:100%}

    .providersPick{
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .provList{display:flex;gap:8px;flex-wrap:wrap}
    .provChip{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:var(--muted);
    }
    .provChip img{width:20px;height:20px;border-radius:7px;border:1px solid rgba(255,255,255,.12)}
    .provChip.active{
      border-color:rgba(57,255,107,.45);
      background:rgba(57,255,107,.12);
      color:var(--text);
    }

    .results{display:grid;gap:12px;margin-top:10px;}
    .resultCard{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:18px;
      padding:12px;
      display:grid;
      grid-template-columns:96px 1fr;
      gap:12px;
      align-items:start;
    }
    .poster{
      width:96px;height:144px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      overflow:hidden;
      display:grid;place-items:center;
      color:rgba(229,231,235,.55);
      font-size:11px;text-align:center;padding:6px;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .meta h3{margin:0 0 6px;font-size:16px;line-height:1.15}
    .meta .o{margin:0 0 8px;color:var(--muted);font-size:13px;line-height:1.35}
    .providersBox{
      margin-top:8px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      border-radius:14px;
      padding:10px 10px;
    }
    .provTitle{
      font-size:12px;color:var(--muted);
      margin:0 0 8px 0;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .provGroups{display:grid;gap:8px;}
    .provGroup{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .provLabel{
      font-size:11px;
      color:rgba(229,231,235,.75);
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.02);
    }
    .provLogo{
      width:26px;height:26px;border-radius:9px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      overflow:hidden;
      display:grid;place-items:center;
      font-size:10px;
      color:rgba(229,231,235,.65);
    }
    .provLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .provEmpty{font-size:12px;color:var(--muted);}

    .hidden{display:none}

    .splash{
      position:fixed;inset:0;display:grid;place-items:center;
      background:
        radial-gradient(800px 520px at 50% 35%, rgba(217,255,47,.12), transparent 55%),
        radial-gradient(700px 480px at 60% 45%, rgba(57,255,107,.10), transparent 55%),
        linear-gradient(180deg, #050813, #070b16);
      z-index:50;
      transition:opacity .55s ease;
    }
    .splashHidden{opacity:0;pointer-events:none}
    .splashInner{text-align:center;padding:20px;}
    .splashIcon{
      width:86px;height:86px;border-radius:26px;margin:0 auto 16px;
      background:linear-gradient(135deg, rgba(217,255,47,.98), rgba(57,255,107,.86));
      box-shadow:0 18px 60px rgba(217,255,47,.16);
      display:grid;place-items:center;color:#0b1020;font-weight:1000;font-size:34px;
    }
    .splashTitle{font-size:22px;margin:0 0 6px}
    .splashAsk{font-size:14px;color:var(--muted);margin:0}

    .fadeOut{
      position:fixed;inset:0;background:#000;
      opacity:0;pointer-events:none;
      z-index:80;
      transition:opacity .7s ease;
      display:grid;place-items:center;
      padding:20px;
    }
    .fadeOut.show{opacity:1;pointer-events:auto}
    .fadeText{text-align:center;font-weight:1000;font-size:22px;color:var(--text);margin-bottom:14px}

    .page{display:none}
    .page.show{display:block}
  </style>
</head>

<body>
  <div class="splash" id="splash">
    <div class="splashInner">
      <div class="splashIcon">MF</div>
      <div class="splashTitle">Movie Finder</div>
      <div class="splashAsk">COSA VUOI GUARDARE OGGI?</div>
    </div>
  </div>

  <div class="fadeOut" id="fadeOut">
    <div>
      <div class="fadeText">Sta iniziando il film...</div>
      <div class="row" style="justify-content:center">
        <button class="btn btnPrimary" id="exitNowBtn">Esci dalla app</button>
      </div>
      <div style="height:10px"></div>
      <div class="small" style="text-align:center;max-width:420px">
        Se il telefono non chiude la scheda, chiudi tu questa pagina.
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topline">
      <div>Profilo: <a href="https://github.com/maprexx-cmd" target="_blank" rel="noreferrer">github.com/maprexx-cmd</a></div>
      <div>App: <a href="https://maprexx-cmd.github.io/movie-finder-pwa-public/" target="_blank" rel="noreferrer">maprexx-cmd.github.io</a></div>
    </div>

    <div class="brand">
      <div class="logo">MF</div>
      <div>
        <h1>Movie Finder</h1>
        <div class="sub">Pagine separate. Provider più comuni in alto. Generi ridotti di default.</div>
      </div>
    </div>

    <!-- PAGINA: HOME -->
    <div class="page show" id="pageHome">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Benvenuta</h2>
          <span class="pill" id="planPill"><strong>Basic</strong> attivo</span>
        </div>
        <p>Seleziona il piano. Poi premi Cosa guardi oggi.</p>

        <div class="row">
          <button class="btn btnPrimary" id="goPlanBtn">Scegli piano</button>
          <button class="btn btnGhost" id="goSettingsBtn">Impostazioni</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn btnPrimary" id="goMainBtn">Cosa guardi oggi?</button>
        </div>

        <div class="small" style="margin-top:10px">
          Nota: la disponibilità streaming dipende da TMDB per regione IT.
        </div>
      </div>
    </div>

    <!-- PAGINA: PIANO -->
    <div class="page" id="pagePlan">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Piano</h2>
          <button class="btn btnGhost btnSmall" id="backFromPlanBtn">Indietro</button>
        </div>

        <div class="row">
          <button class="btn btnPrimary" id="tabBasic">Basic</button>
          <button class="btn btnGhost" id="tabPremium">Premium</button>
        </div>

        <div class="divider"></div>

        <div id="planInfo"></div>

        <div class="divider"></div>

        <div class="toggleRow">
          <span>Mostra solo disponibili online</span>
          <input type="checkbox" id="onlyOnlineToggle" checked>
        </div>

        <div id="premiumGate" class="hidden" style="margin-top:12px">
          <div class="pill"><strong>Premium</strong> accesso</div>

          <div class="row" style="margin-top:10px">
            <button class="btn btnPrimary" id="payBtn">Vai al pagamento Play Store</button>
            <button class="btn btnGhost" id="alreadyBtn">Ho già Premium</button>
          </div>

          <div class="hidden" id="loginBox" style="margin-top:10px">
            <input class="input" id="loginEmail" placeholder="Email">
            <input class="input" id="loginPass" type="password" placeholder="Password" style="margin-top:8px">
            <div class="row" style="margin-top:10px">
              <button class="btn btnPrimary" id="loginBtn">Accedi</button>
              <button class="btn btnGhost" id="logoutBtn">Esci</button>
            </div>
            <div class="small" id="loginMsg" style="margin-top:8px"></div>
            <div class="small">Demo Premium: maprexx@gmail.com e password 1234</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGINA: BASIC GENRES -->
    <div class="page" id="pageBasic">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Basic, filtri</h2>
          <button class="btn btnGhost btnSmall" id="backFromBasicBtn">Indietro</button>
        </div>
        <div class="pill"><strong>Basic</strong> 1 ricerca al giorno. 3 risultati. VM18 escluso.</div>
        <div class="small" style="margin-top:8px">Selezioni multiple. La ricerca usa AND.</div>

        <div class="genres" id="basicGenres"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="basicSearchBtn">Cerca film</button>
        </div>
      </div>
    </div>

    <!-- PAGINA: PREMIUM MENU -->
    <div class="page" id="pagePremiumMenu">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Premium</h2>
          <button class="btn btnGhost btnSmall" id="backFromPremiumMenuBtn">Indietro</button>
        </div>

        <div class="row">
          <button class="btn btnPrimary" id="goPremFilmBtn">Film</button>
          <button class="btn btnPrimary" id="goPremTvBtn">Serie TV</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnGhost" id="goTrendingBtn">Trending</button>
          <button class="btn btnGhost" id="goSocialBtn">Social</button>
          <button class="btn btnGhost" id="goLastBtn">Ultimi visti</button>
          <button class="btn btnGhost" id="goWatchBtn">Watchlist</button>
        </div>

        <div class="small" style="margin-top:12px">
          Per i provider: mostro prima quelli più comuni. Se vuoi, apri Mostra altri.
        </div>
      </div>
    </div>

    <!-- PAGINA: PREMIUM FILM -->
    <div class="page" id="pagePremFilm">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Premium, film</h2>
          <button class="btn btnGhost btnSmall" id="backFromPremFilmBtn">Indietro</button>
        </div>

        <div class="pill"><strong>Film</strong> Slider 0 a 5. AND. 5 risultati.</div>
        <div class="small" style="margin-top:8px">Mostro pochi generi. Se vuoi, apri Mostra tutti.</div>

        <div class="row" style="margin-top:10px">
          <button class="btn btnGhost btnSmall" id="toggleAllGenresFilmBtn">Mostra tutti i generi</button>
          <button class="btn btnPrimary btnSmall" id="goProvidersFilmBtn">Scegli piattaforme</button>
        </div>

        <div class="genres" id="premFilmGenres"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="premFilmSearchBtn">Cerca</button>
        </div>
      </div>
    </div>

    <!-- PAGINA: PREMIUM TV -->
    <div class="page" id="pagePremTv">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Premium, serie TV</h2>
          <button class="btn btnGhost btnSmall" id="backFromPremTvBtn">Indietro</button>
        </div>

        <div class="pill"><strong>Serie TV</strong> Slider 0 a 5. AND. 5 risultati.</div>
        <div class="small" style="margin-top:8px">Mostro pochi generi. Se vuoi, apri Mostra tutti.</div>

        <div class="row" style="margin-top:10px">
          <button class="btn btnGhost btnSmall" id="toggleAllGenresTvBtn">Mostra tutti i generi</button>
          <button class="btn btnPrimary btnSmall" id="goProvidersTvBtn">Scegli piattaforme</button>
        </div>

        <div class="genres" id="premTvGenres"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="premTvSearchBtn">Cerca</button>
        </div>
      </div>
    </div>

    <!-- PAGINA: PROVIDERS -->
    <div class="page" id="pageProviders">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Piattaforme</h2>
          <button class="btn btnGhost btnSmall" id="backFromProvidersBtn">Indietro</button>
        </div>

        <div class="pill" id="providersForPill"><strong>Film</strong> piattaforme</div>
        <div class="small" style="margin-top:8px">
          Prima mostro le più comuni. Poi puoi aprire Mostra altri.
        </div>

        <div class="providersPick" style="margin-top:10px">
          <div class="row">
            <button class="btn btnGhost btnSmall" id="provAllBtn">Tutte</button>
            <button class="btn btnGhost btnSmall" id="provClearBtn">Svuota</button>
            <button class="btn btnGhost btnSmall" id="provToggleMoreBtn">Mostra altri</button>
          </div>

          <div class="divider"></div>

          <div class="small">Comuni</div>
          <div class="provList" id="provCommonList" style="margin-top:8px"></div>

          <div class="divider"></div>

          <div class="small">Altri</div>
          <div class="provList hidden" id="provMoreList" style="margin-top:8px"></div>

          <div class="small" id="provMsg" style="margin-top:10px"></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btnPrimary" id="provDoneBtn">Fatto</button>
        </div>
      </div>
    </div>

    <!-- PAGINA: RISULTATI -->
    <div class="page" id="pageResults">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Risultati</h2>
          <button class="btn btnGhost btnSmall" id="backFromResultsBtn">Indietro</button>
        </div>
        <div class="results" id="resultsBox"></div>
      </div>
    </div>

    <!-- PAGINA: TRENDING -->
    <div class="page" id="pageTrending">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Trending</h2>
          <button class="btn btnGhost btnSmall" id="backFromTrendingBtn">Indietro</button>
        </div>

        <div class="row">
          <button class="btn btnPrimary" id="loadTrendingBtn">Carica</button>
          <button class="btn btnGhost" id="toggleTrendingBtn">Mostra: Film</button>
        </div>

        <div class="results" id="trendingResults" style="margin-top:10px"></div>

        <div class="small" style="margin-top:10px">
          Nota: TMDB non dà i “più visti per piattaforma”. Qui uso Trending TMDB e loghi provider.
        </div>
      </div>
    </div>

    <!-- PAGINA: SOCIAL -->
    <div class="page" id="pageSocial">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Social</h2>
          <button class="btn btnGhost btnSmall" id="backFromSocialBtn">Indietro</button>
        </div>

        <input class="input" id="socialMsg" placeholder="Messaggio opzionale">
        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="shareLastBtn">Condividi ultimo visto</button>
          <button class="btn btnGhost" id="shareAppBtn">Condividi la app</button>
        </div>
        <div class="small" id="shareHint" style="margin-top:10px">Se non si apre la condivisione, copia e incolla.</div>
        <textarea class="input hidden" id="shareFallback" rows="4" style="margin-top:8px"></textarea>
      </div>
    </div>

    <!-- PAGINA: LISTE -->
    <div class="page" id="pageLists">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 id="listsTitle">Liste</h2>
          <button class="btn btnGhost btnSmall" id="backFromListsBtn">Indietro</button>
        </div>

        <div class="row">
          <button class="btn btnGhost" id="listsClearBtn">Svuota</button>
        </div>

        <div class="results" id="listsBox" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- PAGINA: SETTINGS -->
    <div class="page" id="pageSettings">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Impostazioni</h2>
          <button class="btn btnGhost btnSmall" id="backFromSettingsBtn">Indietro</button>
        </div>

        <p>Se la chiave è già presente, non toccare nulla.</p>
        <input class="input" id="apiKeyInput" placeholder="TMDB API key">
        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="saveKeyBtn">Salva</button>
          <button class="btn btnGhost" id="clearKeyBtn">Rimuovi</button>
          <button class="btn btnDanger" id="resetBtn">Reset app</button>
        </div>
        <div class="small" id="keyStatus" style="margin-top:10px"></div>
      </div>
    </div>

  </div>

<script>
  const APP_URL = "https://maprexx-cmd.github.io/movie-finder-pwa-public/";
  const REGION = "IT";
  const IMG_POSTER = "https://image.tmdb.org/t/p/w500";
  const IMG_PROVIDER = "https://image.tmdb.org/t/p/w92";

  const DEMO_EMAIL = "maprexx@gmail.com";
  const DEMO_PASS = "1234";

  const LS = {
    apiKey:"mf_tmdb_key",
    plan:"mf_plan",
    onlyOnline:"mf_only_online",
    basicDate:"mf_basic_date",
    basicCount:"mf_basic_count",
    premiumActive:"mf_premium_active",
    lastViewed:"mf_last_viewed",
    watchlist:"mf_watchlist",
    selectedProvMovie:"mf_sel_prov_movie",
    selectedProvTv:"mf_sel_prov_tv"
  };

  const el = (id) => document.getElementById(id);

  const state = {
    apiKey: localStorage.getItem(LS.apiKey) || "f8ecb75282e8dcea2d4845598cc7d030",
    plan: localStorage.getItem(LS.plan) || "basic",
    onlyOnline: (localStorage.getItem(LS.onlyOnline) ?? "1") === "1",
    premiumActive: localStorage.getItem(LS.premiumActive) === "1",
    trendingType: "movie",
    providersMovie: [],
    providersTv: [],
    selProvMovie: loadIntArray(LS.selectedProvMovie),
    selProvTv: loadIntArray(LS.selectedProvTv),
    providersMode: "movie",
    showAllGenresFilm: false,
    showAllGenresTv: false,
    listMode: "last"
  };

  // Provider preferiti in alto. Se TMDB non li ha per IT, li ignoro.
  const PREFERRED_PROVIDER_IDS = [
    8,    // Netflix
    119,  // Amazon Prime Video
    337,  // Disney Plus
    350,  // Apple TV Plus
    531,  // Paramount Plus
    2,    // Apple TV (store)
    384,  // HBO Max (se presente IT)
    15    // Hulu (probabile non IT, ignora)
  ];

  // Mostro pochi generi di default
  const TOP_GENRE_COUNT = 14;

  function loadIntArray(key){
    try{
      const a = JSON.parse(localStorage.getItem(key) || "[]");
      return Array.isArray(a) ? a.map(x => parseInt(x,10)).filter(n => Number.isFinite(n)) : [];
    }catch(e){return []}
  }
  function saveIntArray(key, arr){
    localStorage.setItem(key, JSON.stringify((arr||[]).map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n))));
  }

  function safeText(s){
    return (s || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function showPage(id){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("show"));
    el(id).classList.add("show");
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function todayKey(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function getBasicCount(){
    const t=todayKey();
    const dt=localStorage.getItem(LS.basicDate);
    if(dt !== t){
      localStorage.setItem(LS.basicDate, t);
      localStorage.setItem(LS.basicCount, "0");
      return 0;
    }
    return parseInt(localStorage.getItem(LS.basicCount) || "0", 10);
  }
  function incBasicCount(){
    const c=getBasicCount()+1;
    localStorage.setItem(LS.basicCount, String(c));
    return c;
  }

  async function tmdb(path, params){
    if(!state.apiKey) throw new Error("Manca la TMDB API key.");
    const url = new URL("https://api.themoviedb.org/3"+path);
    url.searchParams.set("api_key", state.apiKey);
    if(!(params && params.language === false)) url.searchParams.set("language","it-IT");
    if(params){
      for(const [k,v] of Object.entries(params)){
        if(k==="language") continue;
        if(v===undefined || v===null || v==="") continue;
        url.searchParams.set(k, String(v));
      }
    }
    const res = await fetch(url.toString());
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error("Errore TMDB: "+res.status+" "+txt);
    }
    return res.json();
  }

  async function loadProviders(type){
    const data = await tmdb(`/watch/providers/${type}`, { watch_region: REGION, language:false });
    const list = (data && data.results) ? data.results : [];
    return list
      .filter(p => p && p.provider_id && p.provider_name && p.logo_path)
      .map(p => ({
        id: p.provider_id,
        name: p.provider_name,
        logo: p.logo_path ? (IMG_PROVIDER + p.logo_path) : ""
      }));
  }

  async function getWatchProviders(type, id){
    const data = await tmdb(`/${type}/${id}/watch/providers`, { language:false });
    const it = data && data.results && data.results[REGION] ? data.results[REGION] : null;
    const out = { flatrate:[], rent:[], buy:[] };
    if(!it) return out;
    out.flatrate = Array.isArray(it.flatrate) ? it.flatrate : [];
    out.rent = Array.isArray(it.rent) ? it.rent : [];
    out.buy = Array.isArray(it.buy) ? it.buy : [];
    return out;
  }

  function providersExist(p){
    return (p.flatrate && p.flatrate.length) || (p.rent && p.rent.length) || (p.buy && p.buy.length);
  }

  function provLogoHtml(p){
    const logo = p.logo_path ? (IMG_PROVIDER + p.logo_path) : "";
    if(logo){
      return `<span class="provLogo" title="${safeText(p.provider_name)}"><img src="${logo}" alt=""></span>`;
    }
    return `<span class="provLogo" title="${safeText(p.provider_name)}">Logo</span>`;
  }

  function buildProvidersBox(){
    return `
      <div class="providersBox">
        <div class="provTitle">
          <span>Dove guardarlo</span>
          <span class="small" style="margin:0">Regione: ${REGION}</span>
        </div>
        <div class="provGroups">
          <div class="provGroup"><span class="provLabel">Abbonamento</span><span class="provList" data-kind="flatrate"></span></div>
          <div class="provGroup"><span class="provLabel">Noleggio</span><span class="provList" data-kind="rent"></span></div>
          <div class="provGroup"><span class="provLabel">Acquisto</span><span class="provList" data-kind="buy"></span></div>
          <div class="provEmpty" data-empty style="display:none">Non disponibile online per IT, o dato non disponibile.</div>
        </div>
      </div>
    `;
  }

  async function fillProvidersBox(cardEl, type, id){
    const box = cardEl.querySelector(".providersBox");
    if(!box) return;
    try{
      const p = await getWatchProviders(type, id);
      const emptyEl = box.querySelector('[data-empty]');
      const fl = box.querySelector('[data-kind="flatrate"]');
      const re = box.querySelector('[data-kind="rent"]');
      const bu = box.querySelector('[data-kind="buy"]');

      fl.innerHTML = (p.flatrate || []).slice(0, 10).map(provLogoHtml).join("");
      re.innerHTML = (p.rent || []).slice(0, 10).map(provLogoHtml).join("");
      bu.innerHTML = (p.buy || []).slice(0, 10).map(provLogoHtml).join("");

      const ok = providersExist(p);
      emptyEl.style.display = ok ? "none" : "block";
      cardEl.dataset.onlineOk = ok ? "1" : "0";

      if(state.onlyOnline && cardEl.dataset.onlineOk === "0"){
        cardEl.style.display = "none";
      }
    }catch(e){
      const emptyEl = box.querySelector('[data-empty]');
      emptyEl.textContent = "Errore provider.";
      emptyEl.style.display = "block";
      cardEl.dataset.onlineOk = "0";
      if(state.onlyOnline) cardEl.style.display = "none";
    }
  }

  function shortOverview(text, premium){
    const t=(text || "").trim();
    if(!t) return "Trama non disponibile.";
    if(premium) return t;
    if(t.length <= 140) return t;
    return t.slice(0,140).trim()+"...";
  }

  function triggerExitFade(){
    el("fadeOut").classList.add("show");
  }
  el("exitNowBtn").onclick = () => { try{ window.close(); }catch(e){} };

  function addLastViewed(item, type){
    const title = item.title || item.name || "Titolo";
    const entry = { id:item.id, type, title, poster_path:item.poster_path||"", ts:Date.now() };
    const list = JSON.parse(localStorage.getItem(LS.lastViewed) || "[]");
    const filtered = list.filter(x => !(x.id===entry.id && x.type===entry.type));
    filtered.unshift(entry);
    localStorage.setItem(LS.lastViewed, JSON.stringify(filtered.slice(0, 30)));
  }

  function addWatchlist(item, type){
    const title = item.title || item.name || "Titolo";
    const entry = { id:item.id, type, title, poster_path:item.poster_path||"", ts:Date.now() };
    const list = JSON.parse(localStorage.getItem(LS.watchlist) || "[]");
    const filtered = list.filter(x => !(x.id===entry.id && x.type===entry.type));
    filtered.unshift(entry);
    localStorage.setItem(LS.watchlist, JSON.stringify(filtered.slice(0, 60)));
  }

  async function shareWithFallback(payload){
    const txt = payload.text || "";
    const url = payload.url || "";
    const full = (txt ? (txt+"\n") : "") + url;

    try{
      if(navigator.share){
        await navigator.share(payload);
        el("shareFallback").classList.add("hidden");
        el("shareHint").textContent = "Condivisione inviata.";
        return;
      }
    }catch(e){}

    el("shareFallback").classList.remove("hidden");
    el("shareFallback").value = full;
    el("shareHint").textContent = "Copia e incolla questo testo nella app social.";
    el("shareFallback").focus();
    el("shareFallback").select();
  }

  function shareTitle(item, type){
    const title = item.title || item.name || "Titolo";
    const msg = (el("socialMsg").value || "").trim();
    const base = "Sto usando Movie Finder. "+(type==="tv"?"Serie TV":"Film")+": "+title+".";
    const text = msg ? (msg+"\n"+base) : base;
    shareWithFallback({ title:"Movie Finder", text, url:APP_URL });
  }

  function shareLastViewed(){
    const list = JSON.parse(localStorage.getItem(LS.lastViewed) || "[]");
    if(!list.length){
      alert("Nessun ultimo visto.");
      return;
    }
    const x = list[0];
    const msg = (el("socialMsg").value || "").trim();
    const base = "Sto usando Movie Finder. "+(x.type==="tv"?"Serie TV":"Film")+": "+x.title+".";
    const text = msg ? (msg+"\n"+base) : base;
    shareWithFallback({ title:"Movie Finder", text, url:APP_URL });
  }

  function shareApp(){
    const msg = (el("socialMsg").value || "").trim();
    const base = "Movie Finder. Scegli i generi e trova cosa guardare oggi.";
    const text = msg ? (msg+"\n"+base) : base;
    shareWithFallback({ title:"Movie Finder", text, url:APP_URL });
  }

  function buildResultCard(item, type, premium){
    const title = item.title || item.name || "Titolo";
    const overview = shortOverview(item.overview, premium);
    const poster = item.poster_path ? (IMG_POSTER + item.poster_path) : "";
    const posterHtml = poster ? `<img src="${poster}" alt="Locandina">` : `Locandina non disponibile`;

    const wrapper = document.createElement("div");
    wrapper.innerHTML = `
      <div class="resultCard">
        <div class="poster">${posterHtml}</div>
        <div class="meta">
          <h3>${safeText(title)}</h3>
          <p class="o">${safeText(overview)}</p>
          ${buildProvidersBox()}
          <div class="divider"></div>
          <div class="row">
            <button class="btn btnPrimary" data-act="watch">Guarda</button>
            <button class="btn btnGhost" data-act="saveLast">Ultimi visti</button>
            <button class="btn btnGhost" data-act="saveWatch">Watchlist</button>
            <button class="btn btnGhost" data-act="share">Condividi</button>
          </div>
        </div>
      </div>
    `;
    const card = wrapper.firstElementChild;

    card.querySelector('[data-act="watch"]').onclick = () => triggerExitFade();
    card.querySelector('[data-act="saveLast"]').onclick = () => { addLastViewed(item, type); alert("Salvato in Ultimi visti."); };
    card.querySelector('[data-act="saveWatch"]').onclick = () => { addWatchlist(item, type); alert("Aggiunto in Watchlist."); };
    card.querySelector('[data-act="share"]').onclick = () => shareTitle(item, type);

    fillProvidersBox(card, type, item.id);

    return card;
  }

  function applyOnlyOnlineFilter(container){
    if(!container) return;
    const cards = Array.from(container.querySelectorAll(".resultCard"));
    for(const c of cards){
      if(!state.onlyOnline){
        c.style.display = "";
        continue;
      }
      const ok = c.dataset.onlineOk === "1";
      c.style.display = ok ? "" : "none";
    }
  }

  function limitVisible(container, max){
    if(!container) return;
    const cards = Array.from(container.querySelectorAll(".resultCard")).filter(c => c.style.display !== "none");
    cards.forEach((c,i)=>{ if(i>=max) c.style.display="none"; });
  }

  function planInfoHtml(plan){
    if(plan==="basic"){
      return `
        <div class="card" style="margin:0">
          <h3>Versione BASIC, gratuita</h3>
          <ul style="margin:0;padding-left:18px;color:var(--muted);line-height:1.35">
            <li>Solo film, nessuna serie TV</li>
            <li>Una ricerca al giorno, 3 risultati</li>
            <li>Filtri: comico, azione, romantico, cartoni animati</li>
            <li>Esclusione contenuti VM18</li>
            <li>Disponibilità streaming con loghi</li>
            <li>Trama molto breve</li>
            <li>Nessuna registrazione</li>
          </ul>
        </div>
      `;
    }
    return `
      <div class="card" style="margin:0">
        <h3>Versione PREMIUM</h3>
        <ul style="margin:0;padding-left:18px;color:var(--muted);line-height:1.35">
          <li>Film e serie TV</li>
          <li>Nessun limite di ricerche giornaliere</li>
          <li>Slider 0 a 5 per i generi</li>
          <li>Filtro piattaforme selezionabili</li>
          <li>Contenuti VM18</li>
          <li>Trama estesa</li>
          <li>Watchlist, trending, social, ultimi visti</li>
        </ul>
      </div>
    `;
  }

  function renderKeyStatus(){
    el("apiKeyInput").value = state.apiKey || "";
    el("keyStatus").textContent = state.apiKey ? "Chiave salvata." : "Incolla la chiave e salva.";
  }

  function setPlan(plan){
    state.plan = plan;
    localStorage.setItem(LS.plan, plan);

    el("planInfo").innerHTML = planInfoHtml(plan);
    el("tabBasic").classList.toggle("btnPrimary", plan==="basic");
    el("tabBasic").classList.toggle("btnGhost", plan!=="basic");
    el("tabPremium").classList.toggle("btnPrimary", plan==="premium");
    el("tabPremium").classList.toggle("btnGhost", plan!=="premium");

    el("premiumGate").classList.toggle("hidden", plan!=="premium");

    el("planPill").innerHTML = plan==="basic"
      ? "<strong>Basic</strong> attivo"
      : ("<strong>Premium</strong> " + (state.premiumActive ? "attivo" : "bloccato"));
  }

  function setPremiumActive(active){
    state.premiumActive = active;
    localStorage.setItem(LS.premiumActive, active ? "1" : "0");
    setPlan("premium");
  }

  function buildBasicGenres(){
    const basic = [
      { id:35, name:"Comico" },
      { id:28, name:"Azione" },
      { id:10749, name:"Romantico" },
      { id:16, name:"Cartoni animati" }
    ];
    const box = el("basicGenres");
    box.innerHTML = "";
    for(const g of basic){
      const row = document.createElement("div");
      row.className="genreRow";
      row.innerHTML = `
        <div class="genreName">
          <div>${safeText(g.name)}</div>
          <div class="badge" id="b_basic_${g.id}">No</div>
        </div>
        <div style="display:flex;justify-content:flex-end">
          <input type="checkbox" id="c_basic_${g.id}" style="width:22px;height:22px;accent-color:var(--g)">
        </div>
      `;
      box.appendChild(row);
      const c = row.querySelector("#c_basic_"+g.id);
      const b = row.querySelector("#b_basic_"+g.id);
      c.addEventListener("change", ()=> b.textContent = c.checked ? "Si" : "No");
    }
  }

  async function basicSearch(){
    const out = el("resultsBox");
    out.innerHTML = `<div class="small">Carico...</div>`;

    const count = getBasicCount();
    if(count >= 1){
      out.innerHTML = `<div class="small">Hai già fatto la ricerca di oggi.</div>`;
      showPage("pageResults");
      return;
    }

    const selected = [];
    el("basicGenres").querySelectorAll('input[type="checkbox"]').forEach(ch=>{
      if(ch.checked){
        const id = parseInt(ch.id.replace("c_basic_",""),10);
        if(Number.isFinite(id)) selected.push(id);
      }
    });

    if(!selected.length){
      alert("Seleziona almeno un genere.");
      return;
    }

    incBasicCount();

    try{
      const data = await tmdb("/discover/movie", {
        include_adult:"false",
        sort_by:"popularity.desc",
        page:1,
        with_genres:selected.join(","),
        watch_region:REGION,
        with_watch_monetization_types:"flatrate|rent|buy"
      });

      const list = (data.results || []).slice(0, 12);
      out.innerHTML = "";

      if(!list.length){
        out.innerHTML = `<div class="small">Nessun risultato.</div>`;
        showPage("pageResults");
        return;
      }

      for(const item of list){
        out.appendChild(buildResultCard(item, "movie", false));
      }

      showPage("pageResults");

      setTimeout(()=>{
        applyOnlyOnlineFilter(out);
        limitVisible(out, 3);
      }, 1100);

    }catch(e){
      out.innerHTML = `<div class="small">${safeText(e.message || "Errore")}</div>`;
      showPage("pageResults");
    }
  }

  function buildSliderRow(container, g){
    const row = document.createElement("div");
    row.className="genreRow";
    row.innerHTML = `
      <div class="genreName">
        <div>${safeText(g.name)}</div>
        <div class="badge" id="${container.id}_b_${g.id}">0</div>
      </div>
      <div><input type="range" min="0" max="5" value="0" step="1" id="${container.id}_r_${g.id}"></div>
    `;
    container.appendChild(row);
    const r = row.querySelector("#"+container.id+"_r_"+g.id);
    const b = row.querySelector("#"+container.id+"_b_"+g.id);
    r.addEventListener("input", ()=> b.textContent = r.value);
  }

  function getSliderSelections(container){
    const list=[];
    container.querySelectorAll('input[type="range"]').forEach(r=>{
      const v=parseInt(r.value,10);
      const id=parseInt(r.id.split("_r_")[1],10);
      if(v>0) list.push({id, w:v});
    });
    list.sort((a,b)=>b.w-a.w);
    return list;
  }

  function requireAllSelected(items, selectedIds){
    if(!selectedIds.length) return items;
    return items.filter(it=>{
      const ids = it.genre_ids || [];
      return selectedIds.every(gid => ids.includes(gid));
    });
  }

  function scoreItems(items, weights){
    const map = new Map(weights.map(w=>[w.id,w.w]));
    return items.map(it=>{
      const ids = it.genre_ids || [];
      let s = 0;
      for(const gid of ids){
        if(map.has(gid)) s += map.get(gid);
      }
      return {it, s};
    }).sort((a,b)=>b.s-a.s).map(x=>x.it);
  }

  async function ensurePremiumDataLoaded(){
    if(!state.apiKey) return;

    if(!state.providersMovie.length) state.providersMovie = await loadProviders("movie");
    if(!state.providersTv.length) state.providersTv = await loadProviders("tv");

    await ensureGenresLoaded("movie");
    await ensureGenresLoaded("tv");
  }

  async function ensureGenresLoaded(type){
    const box = type==="movie" ? el("premFilmGenres") : el("premTvGenres");
    const showAll = type==="movie" ? state.showAllGenresFilm : state.showAllGenresTv;

    const data = await tmdb(`/genre/${type}/list`, {});
    const all = (data.genres || []).slice().sort((a,b)=>a.name.localeCompare(b.name));

    const top = all.slice(0, TOP_GENRE_COUNT);
    const use = showAll ? all : top;

    box.innerHTML = "";
    use.forEach(g=>buildSliderRow(box,g));
  }

  function splitProviders(list){
    const common = [];
    const more = [];

    const byId = new Map(list.map(p=>[p.id,p]));
    for(const id of PREFERRED_PROVIDER_IDS){
      if(byId.has(id)) common.push(byId.get(id));
    }

    const commonIds = new Set(common.map(p=>p.id));
    const rest = list.filter(p=>!commonIds.has(p.id)).sort((a,b)=>a.name.localeCompare(b.name));

    // Limito “altri” per non esplodere la UI
    rest.forEach(p=>more.push(p));
    return {common, more};
  }

  function renderProvidersPage(){
    const type = state.providersMode;
    const list = type==="movie" ? state.providersMovie : state.providersTv;
    const sel = type==="movie" ? state.selProvMovie : state.selProvTv;

    el("providersForPill").innerHTML = type==="movie"
      ? "<strong>Film</strong> piattaforme"
      : "<strong>Serie TV</strong> piattaforme";

    const {common, more} = splitProviders(list);

    el("provCommonList").innerHTML = "";
    el("provMoreList").innerHTML = "";

    const mkChip = (p) => {
      const chip = document.createElement("div");
      chip.className = "provChip"+(sel.includes(p.id) ? " active" : "");
      chip.dataset.pid = String(p.id);
      chip.innerHTML = `${p.logo ? `<img src="${p.logo}" alt="">` : ""}<span>${safeText(p.name)}</span>`;
      chip.onclick = () => {
        const id = parseInt(chip.dataset.pid,10);
        let current = type==="movie" ? state.selProvMovie : state.selProvTv;

        if(current.includes(id)) current = current.filter(x=>x!==id);
        else current = current.concat([id]);

        if(type==="movie"){
          state.selProvMovie = current;
          saveIntArray(LS.selectedProvMovie, current);
        }else{
          state.selProvTv = current;
          saveIntArray(LS.selectedProvTv, current);
        }
        chip.classList.toggle("active");
        updateProvMsg();
      };
      return chip;
    };

    common.forEach(p=>el("provCommonList").appendChild(mkChip(p)));
    more.forEach(p=>el("provMoreList").appendChild(mkChip(p)));

    updateProvMsg();
  }

  function updateProvMsg(){
    const type = state.providersMode;
    const sel = type==="movie" ? state.selProvMovie : state.selProvTv;
    el("provMsg").textContent = sel.length ? ("Selezionate: "+sel.length) : "Nessuna selezione. Uso tutte.";
  }

  async function premiumSearch(type){
    const out = el("resultsBox");
    out.innerHTML = `<div class="small">Carico...</div>`;

    try{
      const genreBox = type==="movie" ? el("premFilmGenres") : el("premTvGenres");
      const weights = getSliderSelections(genreBox);
      if(!weights.length){
        alert("Alza almeno uno slider.");
        return;
      }

      const selectedIds = weights.map(x=>x.id);

      const selectedProviders = type==="movie" ? state.selProvMovie : state.selProvTv;
      const provParam = selectedProviders.length ? selectedProviders.join("|") : "";

      const data = await tmdb(`/discover/${type}`, {
        sort_by:"popularity.desc",
        page:1,
        include_adult:"true",
        watch_region:REGION,
        with_watch_providers:provParam,
        with_watch_monetization_types:"flatrate|rent|buy"
      });

      let items = (data.results || []).slice(0, 80);
      items = requireAllSelected(items, selectedIds);
      items = scoreItems(items, weights);

      out.innerHTML = "";

      if(!items.length){
        out.innerHTML = `<div class="small">Nessun risultato. Cambia slider o piattaforme.</div>`;
        showPage("pageResults");
        return;
      }

      for(const item of items.slice(0, 12)){
        out.appendChild(buildResultCard(item, type, true));
        addLastViewed(item, type);
      }

      showPage("pageResults");

      setTimeout(()=>{
        applyOnlyOnlineFilter(out);
        limitVisible(out, 5);
      }, 1200);

    }catch(e){
      out.innerHTML = `<div class="small">${safeText(e.message || "Errore")}</div>`;
      showPage("pageResults");
    }
  }

  async function loadTrending(){
    const out = el("trendingResults");
    out.innerHTML = `<div class="small">Carico...</div>`;
    try{
      const data = await tmdb(`/trending/${state.trendingType}/week`, {});
      let list = (data.results || []).slice(0, 12);

      out.innerHTML = "";
      if(!list.length){
        out.innerHTML = `<div class="small">Nessun dato.</div>`;
        return;
      }

      for(const item of list){
        out.appendChild(buildResultCard(item, state.trendingType, true));
      }

      setTimeout(()=>{
        applyOnlyOnlineFilter(out);
        limitVisible(out, 5);
      }, 1200);

    }catch(e){
      out.innerHTML = `<div class="small">${safeText(e.message || "Errore")}</div>`;
    }
  }

  function renderList(storageKey){
    const box = el("listsBox");
    const list = JSON.parse(localStorage.getItem(storageKey) || "[]");
    if(!list.length){
      box.innerHTML = `<div class="small">Vuoto.</div>`;
      return;
    }
    box.innerHTML = "";
    for(const x of list){
      const fake = {
        id:x.id,
        title: x.type==="movie" ? x.title : undefined,
        name: x.type==="tv" ? x.title : undefined,
        poster_path:x.poster_path,
        overview:""
      };
      box.appendChild(buildResultCard(fake, x.type, true));
    }
  }

  function resetApp(){
    localStorage.clear();
    location.reload();
  }

  function init(){
    setTimeout(()=> el("splash").classList.add("splashHidden"), 2000);

    el("onlyOnlineToggle").checked = state.onlyOnline;
    el("onlyOnlineToggle").addEventListener("change", ()=>{
      state.onlyOnline = el("onlyOnlineToggle").checked;
      localStorage.setItem(LS.onlyOnline, state.onlyOnline ? "1" : "0");
    });

    el("goPlanBtn").onclick = ()=> showPage("pagePlan");
    el("goSettingsBtn").onclick = ()=> showPage("pageSettings");

    el("goMainBtn").onclick = async ()=>{
      if(state.plan==="basic"){
        showPage("pageBasic");
        return;
      }
      if(!state.premiumActive){
        showPage("pagePlan");
        alert("Premium bloccato. Accedi prima.");
        return;
      }
      await ensurePremiumDataLoaded();
      showPage("pagePremiumMenu");
    };

    el("backFromPlanBtn").onclick = ()=> showPage("pageHome");
    el("backFromSettingsBtn").onclick = ()=> showPage("pageHome");

    el("tabBasic").onclick = ()=> setPlan("basic");
    el("tabPremium").onclick = ()=> setPlan("premium");

    el("payBtn").onclick = ()=> alert("Qui è PWA. Il pagamento reale arriva nella app Play Store con Google Play Billing.");
    el("alreadyBtn").onclick = ()=>{
      el("loginBox").classList.remove("hidden");
      el("loginMsg").textContent = "Inserisci email e password.";
    };

    el("loginBtn").onclick = async ()=>{
      const email = (el("loginEmail").value || "").trim().toLowerCase();
      const pass = (el("loginPass").value || "").trim();
      if(email===DEMO_EMAIL && pass===DEMO_PASS){
        el("loginMsg").textContent = "Premium attivo.";
        setPremiumActive(true);
        await ensurePremiumDataLoaded();
        showPage("pagePremiumMenu");
      }else{
        el("loginMsg").textContent = "Credenziali non valide.";
      }
    };

    el("logoutBtn").onclick = ()=>{
      el("loginMsg").textContent = "Sei uscita.";
      setPremiumActive(false);
    };

    el("backFromBasicBtn").onclick = ()=> showPage("pageHome");
    el("basicSearchBtn").onclick = ()=> basicSearch();

    el("backFromPremiumMenuBtn").onclick = ()=> showPage("pageHome");

    el("goPremFilmBtn").onclick = ()=> showPage("pagePremFilm");
    el("goPremTvBtn").onclick = ()=> showPage("pagePremTv");
    el("goTrendingBtn").onclick = ()=> showPage("pageTrending");
    el("goSocialBtn").onclick = ()=> showPage("pageSocial");
    el("goLastBtn").onclick = ()=>{
      state.listMode = "last";
      el("listsTitle").textContent = "Ultimi visti";
      el("listsClearBtn").onclick = ()=> { localStorage.removeItem(LS.lastViewed); renderList(LS.lastViewed); };
      renderList(LS.lastViewed);
      showPage("pageLists");
    };
    el("goWatchBtn").onclick = ()=>{
      state.listMode = "watch";
      el("listsTitle").textContent = "Watchlist";
      el("listsClearBtn").onclick = ()=> { localStorage.removeItem(LS.watchlist); renderList(LS.watchlist); };
      renderList(LS.watchlist);
      showPage("pageLists");
    };

    el("backFromPremFilmBtn").onclick = ()=> showPage("pagePremiumMenu");
    el("backFromPremTvBtn").onclick = ()=> showPage("pagePremiumMenu");

    el("toggleAllGenresFilmBtn").onclick = async ()=>{
      state.showAllGenresFilm = !state.showAllGenresFilm;
      el("toggleAllGenresFilmBtn").textContent = state.showAllGenresFilm ? "Mostra meno generi" : "Mostra tutti i generi";
      await ensureGenresLoaded("movie");
    };
    el("toggleAllGenresTvBtn").onclick = async ()=>{
      state.showAllGenresTv = !state.showAllGenresTv;
      el("toggleAllGenresTvBtn").textContent = state.showAllGenresTv ? "Mostra meno generi" : "Mostra tutti i generi";
      await ensureGenresLoaded("tv");
    };

    el("goProvidersFilmBtn").onclick = async ()=>{
      await ensurePremiumDataLoaded();
      state.providersMode = "movie";
      renderProvidersPage();
      showPage("pageProviders");
    };
    el("goProvidersTvBtn").onclick = async ()=>{
      await ensurePremiumDataLoaded();
      state.providersMode = "tv";
      renderProvidersPage();
      showPage("pageProviders");
    };

    el("provAllBtn").onclick = ()=>{
      if(state.providersMode==="movie"){
        state.selProvMovie = [];
        saveIntArray(LS.selectedProvMovie, []);
      }else{
        state.selProvTv = [];
        saveIntArray(LS.selectedProvTv, []);
      }
      renderProvidersPage();
    };

    el("provClearBtn").onclick = ()=>{
      if(state.providersMode==="movie"){
        state.selProvMovie = [];
        saveIntArray(LS.selectedProvMovie, []);
      }else{
        state.selProvTv = [];
        saveIntArray(LS.selectedProvTv, []);
      }
      renderProvidersPage();
    };

    el("provToggleMoreBtn").onclick = ()=>{
      const more = el("provMoreList");
      const open = !more.classList.contains("hidden");
      more.classList.toggle("hidden", open);
      el("provToggleMoreBtn").textContent = open ? "Mostra altri" : "Nascondi altri";
    };

    el("provDoneBtn").onclick = ()=>{
      showPage(state.providersMode==="movie" ? "pagePremFilm" : "pagePremTv");
    };

    el("backFromProvidersBtn").onclick = ()=>{
      showPage(state.providersMode==="movie" ? "pagePremFilm" : "pagePremTv");
    };

    el("premFilmSearchBtn").onclick = ()=> premiumSearch("movie");
    el("premTvSearchBtn").onclick = ()=> premiumSearch("tv");

    el("backFromResultsBtn").onclick = ()=>{
      if(state.plan==="basic") showPage("pageBasic");
      else showPage("pagePremiumMenu");
    };

    el("backFromTrendingBtn").onclick = ()=> showPage("pagePremiumMenu");
    el("loadTrendingBtn").onclick = ()=> loadTrending();
    el("toggleTrendingBtn").onclick = ()=>{
      state.trendingType = state.trendingType === "movie" ? "tv" : "movie";
      el("toggleTrendingBtn").textContent = state.trendingType === "movie" ? "Mostra: Film" : "Mostra: Serie TV";
    };

    el("backFromSocialBtn").onclick = ()=> showPage("pagePremiumMenu");
    el("shareLastBtn").onclick = ()=> shareLastViewed();
    el("shareAppBtn").onclick = ()=> shareApp();

    el("backFromListsBtn").onclick = ()=> showPage("pagePremiumMenu");

    el("saveKeyBtn").onclick = async ()=>{
      state.apiKey = (el("apiKeyInput").value || "").trim();
      localStorage.setItem(LS.apiKey, state.apiKey);
      renderKeyStatus();
      if(state.premiumActive) await ensurePremiumDataLoaded();
    };

    el("clearKeyBtn").onclick = ()=>{
      state.apiKey = "";
      localStorage.removeItem(LS.apiKey);
      renderKeyStatus();
    };

    el("resetBtn").onclick = ()=> resetApp();

    buildBasicGenres();
    renderKeyStatus();
    el("planInfo").innerHTML = planInfoHtml(state.plan);
    setPlan(state.plan);

    if(state.premiumActive){
      setPlan("premium");
    }
  }

  init();
</script>
</body>
</html>
