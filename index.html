<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Finder</title>
  <style>
    :root{
      --bg:#0b0720;
      --text:#f3f1ff;
      --muted:#b9b2e6;
      --violet:#7c3aed;
      --violet2:#5b21b6;
      --yellow:#ffd400;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;

      --devBlue:#4aa3ff;
      --devBlueBg: rgba(74,163,255,.10);
      --devBlueBorder: rgba(74,163,255,.22);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 500px at 10% 30%, rgba(255,212,0,.10), transparent 55%),
                  linear-gradient(180deg, #070516, var(--bg));
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width:1040px;margin:0 auto;padding:18px 14px 80px}
    .topbar{
      position:sticky;top:0;z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(7,5,22,.70);
      border-bottom:1px solid var(--border);
    }
    .topbar .wrap{padding:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, var(--yellow), #fff0 55%),
                  linear-gradient(135deg, var(--violet), var(--violet2));
      box-shadow: 0 10px 24px rgba(124,58,237,.35);
    }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .screen{display:none;animation:fade .35s ease forwards}
    .screen.active{display:block}
    @keyframes fade{from{opacity:0;transform: translateY(6px)}to{opacity:1;transform:none}}

    .hero{
      margin-top:18px;
      padding:18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(124,58,237,.22), rgba(255,212,0,.06));
      box-shadow: var(--shadow);
    }
    .hero h2{margin:0 0 8px;font-size:18px}
    .hero .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.04);
    }

    .grid2{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:860px){ .grid2{grid-template-columns:1fr 1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h3{margin:0 0 6px;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:12px 14px;border-radius:14px;
      color:#0b0720;font-weight:700;
      background: var(--yellow);
      box-shadow: 0 12px 26px rgba(255,212,0,.22);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    button.danger{
      background: rgba(255,70,70,.18);
      color: #ffd6d6;
      border:1px solid rgba(255,70,70,.25);
      box-shadow:none;
    }
    button:disabled{opacity:.45;cursor:not-allowed}

    .sectionTitle{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
      margin:18px 2px 10px;
    }
    .sectionTitle h2{margin:0;font-size:16px}
    .sectionTitle .small{color:var(--muted);font-size:12px}

    .modeBar{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(255,255,255,.03);
      padding:10px;
    }
    .toggle{
      display:flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .toggle input{accent-color: var(--yellow);}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size:13px;
    }
    .chip input{accent-color: var(--yellow);}

    .sliders{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:860px){ .sliders{grid-template-columns:1fr 1fr} }
    .sliderRow{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    .sliderRow .hdr{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:6px;
    }
    .sliderRow .hdr span{font-size:13px;color:var(--muted)}
    .sliderRow .hdr strong{font-size:13px}
    input[type="range"]{width:100%;accent-color: var(--yellow)}

    .results{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .resultCard{
      display:grid;
      grid-template-columns:92px 1fr;
      gap:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .poster{
      width:92px;height:138px;border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color: var(--muted);font-size:11px;text-align:center;padding:8px;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .resultCard h4{margin:0 0 6px;font-size:15px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-bottom:8px}
    .plot{margin:0;color:var(--text);opacity:.92;font-size:13px;line-height:1.35}

    .providers{margin-top:10px;display:grid;gap:10px}
    .provGroup{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px;
      background: rgba(0,0,0,.10);
    }
    .provGroup .t{font-size:12px;color:var(--muted);margin:0 0 8px}
    .provList{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .provItem{display:flex;gap:8px;align-items:center}
    .provItem img{
      width:22px;height:22px;border-radius:6px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .provItem span{font-size:12px;color:var(--text)}
    .note{color:var(--muted);font-size:12px;margin-top:10px}
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:14px 0}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid var(--border);
      color: var(--text);
      padding:10px 12px;border-radius:14px;
      max-width:92vw;
      display:none;
      z-index:80;
      font-size:13px;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block;animation:fade .25s ease forwards}

    a.link{color:var(--yellow);text-decoration:none}

    .actionRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .watchBtn{
      background: var(--yellow);
      color:#0b0720;
      font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(255,212,0,.22);
    }
    .openBtn{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }

    /* =======================
       CINEMA EXIT 2.0
    ======================= */
    .cinemaOverlay{
      position:fixed;inset:0;
      background:#000;
      display:none;
      z-index:9999;
      overflow:hidden;
      touch-action:none;
    }
    .cinemaOverlay.show{display:block}

    .flash{
      position:absolute;inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
    }
    .cinemaOverlay.flashOn .flash{
      animation: flash 240ms ease forwards;
    }
    @keyframes flash{
      0%{opacity:0}
      20%{opacity:.85}
      100%{opacity:0}
    }

    .curtain{
      position:absolute;top:0;bottom:0;
      width:55%;
      background:
        radial-gradient(circle at 50% 20%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(90deg, rgba(140,0,0,.65), rgba(45,0,0,.80));
      filter: saturate(115%);
      box-shadow: 0 0 80px rgba(0,0,0,.7) inset;
    }
    .curtain.left{left:-55%}
    .curtain.right{right:-55%}
    .cinemaOverlay.curtainsOn .curtain.left{animation: curtainL 720ms cubic-bezier(.16,.9,.14,1) forwards}
    .cinemaOverlay.curtainsOn .curtain.right{animation: curtainR 720ms cubic-bezier(.16,.9,.14,1) forwards}
    @keyframes curtainL{to{transform: translateX(55%)}}
    @keyframes curtainR{to{transform: translateX(-55%)}}

    .filmGrain{
      position:absolute;inset:-30%;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.05), transparent 45%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,.035), transparent 50%),
        radial-gradient(circle at 35% 80%, rgba(255,255,255,.03), transparent 55%);
      opacity:.34;
      mix-blend-mode: screen;
      animation: grainMove 900ms steps(2) infinite;
      transform: rotate(7deg);
      pointer-events:none;
      filter: contrast(125%);
    }
    @keyframes grainMove{
      0%{transform:translate(0,0) rotate(7deg)}
      25%{transform:translate(-2%,1%) rotate(7deg)}
      50%{transform:translate(1%,-2%) rotate(7deg)}
      75%{transform:translate(2%,2%) rotate(7deg)}
      100%{transform:translate(0,0) rotate(7deg)}
    }

    .scanlines{
      position:absolute;inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.035),
        rgba(255,255,255,.035) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      opacity:.085;
      pointer-events:none;
    }

    .vignette{
      position:absolute;inset:0;
      background: radial-gradient(circle at 50% 45%, rgba(0,0,0,0) 33%, rgba(0,0,0,.58) 78%, rgba(0,0,0,.95) 100%);
      pointer-events:none;
      opacity:1;
    }

    .projectorFlicker{
      position:absolute;inset:0;
      background: rgba(255,255,255,.03);
      opacity:0;
      animation: flicker 160ms infinite;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    @keyframes flicker{
      0%{opacity:0}
      10%{opacity:.22}
      20%{opacity:.02}
      30%{opacity:.18}
      40%{opacity:.04}
      50%{opacity:.26}
      60%{opacity:.03}
      70%{opacity:.16}
      80%{opacity:.05}
      90%{opacity:.20}
      100%{opacity:.00}
    }

    .cinemaCenter{
      position:absolute;inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      text-align:center;
    }

    .cinemaCard{
      width:min(560px, 92vw);
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      padding:18px 16px 16px;
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 60px rgba(0,0,0,.7);
      backdrop-filter: blur(8px);
      transform: translateZ(0);
    }

    .cinemaTitle{
      margin:0;
      font-size:18px;
      color:#fff;
      letter-spacing:.2px;
      line-height:1.25;
      text-shadow: 0 10px 22px rgba(0,0,0,.45);
      min-height: 24px;
    }

    .subtitle{
      margin:8px 0 0;
      color: rgba(255,255,255,.75);
      font-size:12px;
      line-height:1.35;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .cinemaOverlay.ready .subtitle{
      opacity:1;
      transform:none;
    }

    .dots{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:12px;
      opacity:.9;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.55);
      animation: dotPulse 900ms infinite;
    }
    .dot:nth-child(2){animation-delay:150ms}
    .dot:nth-child(3){animation-delay:300ms}
    @keyframes dotPulse{
      0%{transform:translateY(0);opacity:.45}
      30%{transform:translateY(-3px);opacity:1}
      60%{transform:translateY(0);opacity:.55}
      100%{transform:translateY(0);opacity:.45}
    }

    .cinemaBtns{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    .cinemaOverlay.showButtons .cinemaBtns{
      opacity:1;
      transform:none;
    }

    .cinemaBtnExit{
      background: rgba(255,70,70,.20);
      color:#ffd6d6;
      border:1px solid rgba(255,70,70,.28);
      box-shadow:none;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    .cinemaBtnCancel{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }

    .shakeHard{
      animation: shakeHard 120ms infinite linear;
    }
    @keyframes shakeHard{
      0%{transform:translate(0,0)}
      25%{transform:translate(2px,-2px)}
      50%{transform:translate(-2px,2px)}
      75%{transform:translate(2px,2px)}
      100%{transform:translate(-2px,-2px)}
    }

    /* DEV NOTES */
    .devNote{
      display:none;
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--devBlueBorder);
      background: var(--devBlueBg);
      color: var(--devBlue);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    body.dev .devNote{display:block}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Movie Finder</h1>
          <p>Solo titoli disponibili in Italia</p>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="screenStart" class="screen active">
      <div class="hero">
        <h2>Trova cosa guardare in pochi secondi</h2>
        <div class="row">
          <div class="pill">Solo disponibili in Italia</div>
          <div class="pill">Basic, test senza limiti</div>
          <div class="pill">Trama breve in Basic</div>
          <div class="pill">Trama più lunga in Premium</div>
          <div class="pill">Ricerca migliorata, più varietà</div>
        </div>
        <div class="devNote" id="devStartNote"></div>
      </div>

      <div class="grid2">
        <div class="card">
          <h3>Basic</h3>
          <p>Film. 4 generi. Trama breve. Esclude VM18.</p>
          <div class="btnRow">
            <button id="btnGoBasic">Entra in Basic</button>
            <button class="secondary" id="btnInfoBasic">Dettagli</button>
          </div>
          <div class="devNote" id="devBasicHomeNote"></div>
        </div>

        <div class="card">
          <h3>Premium</h3>
          <p>Film e serie. Slider intensità. Trama più lunga.</p>
          <div class="btnRow">
            <button id="btnGoPremium">Entra in Premium</button>
            <button class="secondary" id="btnBuyPremium">Sblocca Premium</button>
          </div>
          <div class="note" id="premiumStatus"></div>
          <div class="devNote" id="devPremiumHomeNote"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Uscita</h3>
        <p>Premi Esci per chiudere con effetto cinematografico.</p>
        <div class="btnRow">
          <button class="danger" id="btnExitFromStart">Esci</button>
        </div>
        <div class="devNote" id="devExitNote"></div>
      </div>
    </div>

    <div id="screenBasic" class="screen">
      <div class="sectionTitle">
        <h2>Basic</h2>
        <div class="small">Test senza limiti, solo film disponibili in Italia</div>
      </div>

      <div class="modeBar">
        <div class="toggle">
          <input type="radio" name="basicType" checked />
          <div>
            <div style="font-weight:800">Film</div>
            <div class="tiny">Esclude VM18</div>
          </div>
        </div>

        <div style="flex:1"></div>

        <button class="secondary" id="btnBackFromBasic">Indietro</button>
        <button class="danger" id="btnExitFromBasic">Esci</button>
      </div>

      <div class="devNote" id="devBasicScreenNote"></div>

      <div class="sectionTitle">
        <h2>Seleziona generi</h2>
        <div class="small">Scegli 1 o più</div>
      </div>

      <div class="chips" id="basicGenres">
        <label class="chip"><input type="checkbox" value="azione" /> Azione</label>
        <label class="chip"><input type="checkbox" value="comico" /> Comico</label>
        <label class="chip"><input type="checkbox" value="thriller" /> Thriller</label>
        <label class="chip"><input type="checkbox" value="animazione" /> Animazione</label>
      </div>

      <div class="sectionTitle">
        <h2>Piattaforme</h2>
        <div class="small">Filtra facoltativo</div>
      </div>

      <div class="card">
        <div class="chips" id="basicProvidersPick"></div>
        <p class="note">Se non selezioni piattaforme, la app cerca comunque solo titoli disponibili in Italia.</p>
        <div class="devNote" id="devProvidersNote"></div>
      </div>

      <div class="btnRow" style="margin-top:12px">
        <button id="btnBasicSearch">Cerca</button>
        <button class="secondary" id="btnBasicResetShown">Reset risultati mostrati</button>
      </div>

      <div class="note" id="basicLimitInfo"></div>
      <div class="devNote" id="devBasicSearchNote"></div>

      <div id="basicResults" class="results"></div>
    </div>

    <div id="screenPremium" class="screen">
      <div class="sectionTitle">
        <h2>Premium</h2>
        <div class="small">Ricerche illimitate, 5 risultati, solo disponibili in Italia</div>
      </div>

      <div class="modeBar">
        <label class="toggle">
          <input id="premiumPickMovie" type="radio" name="premiumType" value="movie" checked />
          <div>
            <div style="font-weight:800">Film</div>
            <div class="tiny">Disponibili in Italia</div>
          </div>
        </label>

        <label class="toggle">
          <input id="premiumPickTv" type="radio" name="premiumType" value="tv" />
          <div>
            <div style="font-weight:800">Serie TV</div>
            <div class="tiny">Disponibili in Italia</div>
          </div>
        </label>

        <div style="flex:1"></div>

        <button class="secondary" id="btnBackFromPremium">Indietro</button>
        <button class="danger" id="btnExitFromPremium">Esci</button>
      </div>

      <div class="devNote" id="devPremiumScreenNote"></div>

      <div class="sectionTitle">
        <h2>Intensità generi</h2>
        <div class="small">0, 5</div>
      </div>

      <div class="sliders" id="premiumSliders"></div>

      <div class="sectionTitle">
        <h2>Piattaforme</h2>
        <div class="small">Filtra facoltativo</div>
      </div>

      <div class="card">
        <div class="chips" id="premiumProvidersPick"></div>
        <p class="note">La app non distingue noleggio o abbonamento. Mostra solo dove è disponibile.</p>
      </div>

      <div class="btnRow" style="margin-top:12px">
        <button id="btnPremiumSearch">Cerca</button>
        <button class="secondary" id="btnPremiumResetShown">Reset risultati mostrati</button>
        <button class="danger" id="btnLockPremium">Blocca Premium</button>
      </div>

      <div class="note" id="premiumGateInfo"></div>
      <div class="devNote" id="devPremiumSearchNote"></div>

      <div id="premiumResults" class="results"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- CINEMA EXIT OVERLAY -->
  <div id="cinemaOverlay" class="cinemaOverlay" aria-hidden="true">
    <div class="flash" aria-hidden="true"></div>

    <div class="curtain left" aria-hidden="true"></div>
    <div class="curtain right" aria-hidden="true"></div>

    <div class="filmGrain" aria-hidden="true"></div>
    <div class="scanlines" aria-hidden="true"></div>
    <div class="projectorFlicker" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>

    <div class="cinemaCenter">
      <div id="cinemaCard" class="cinemaCard">
        <p id="cinemaTitle" class="cinemaTitle"></p>
        <p class="subtitle" id="cinemaSub">Sto preparando lo schermo</p>
        <div class="dots" aria-hidden="true">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <div class="cinemaBtns" id="cinemaBtns">
          <button class="cinemaBtnExit" id="btnForceExit" type="button">Esci</button>
          <button class="cinemaBtnCancel" id="btnCancelExit" type="button">Annulla</button>
        </div>
        <div class="devNote" id="devCinemaExitNote"></div>
      </div>
    </div>
  </div>

<script>
const DEV_NOTES_ENABLED = true;

const TMDB_API_KEY = "f8ecb75282e8dcea2d4845598cc7d030";
const TMDB_LANG = "it-IT";
const TMDB_REGION = "IT";

const POSTER_W342 = "https://image.tmdb.org/t/p/w342";
const LOGO_W45 = "https://image.tmdb.org/t/p/w45";

const BASIC_TEST_MODE_UNLIMITED = true;

const BASIC_BLOCK_VM18 = true;
const BASIC_CERT_COUNTRY = "IT";
const BASIC_CERT_LTE = "14";

const LS = {
  premium: "mf_premium_purchased",
  lastBasicSearchDate: "mf_basic_last_search_date",
  shownMovies: "mf_shown_movies",
  shownTv: "mf_shown_tv",
  picked: "mf_picked_to_watch"
};

const GENRE_MAP_MOVIE = {
  azione: 28,
  comico: 35,
  thriller: 53,
  animazione: 16,
  romantico: 10749,
  dramma: 18,
  horror: 27,
  fantascienza: 878,
  avventura: 12,
  crime: 80
};

const GENRE_MAP_TV = {
  azione: 10759,
  comico: 35,
  thriller: 9648,
  animazione: 16,
  romantico: 10749,
  dramma: 18,
  fantascienza: 10765,
  avventura: 10759,
  crime: 80
};

const PROVIDERS = [
  { id: 8,   name: "Netflix" },
  { id: 119, name: "Prime Video" },
  { id: 337, name: "Disney+" },
  { id: 350, name: "Apple TV" },
  { id: 39,  name: "NOW" },
  { id: 2,   name: "Apple iTunes" },
  { id: 35,  name: "Rakuten TV" },
  { id: 283, name: "Crunchyroll" }
];

const PLOT_MAX_BASIC = 220;
const PLOT_MAX_PREMIUM = 650;

const el = (id) => document.getElementById(id);

/* =======================
   DEV NOTES
======================= */
function setDevMode(){
  if(DEV_NOTES_ENABLED){
    document.body.classList.add("dev");
  }else{
    document.body.classList.remove("dev");
  }
}
function devSet(id, text){
  const n = el(id);
  if(!n) return;
  if(!DEV_NOTES_ENABLED){
    n.textContent = "";
    return;
  }
  n.textContent = text;
}

/* =======================
   UI
======================= */
function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), 2400);
}

function showScreen(name){
  const screens = ["screenStart","screenBasic","screenPremium"];
  screens.forEach(s => el(s).classList.remove("active"));
  el(name).classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
}

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

function randInt(min, max){
  const range = max - min + 1;
  const buf = new Uint32Array(1);
  crypto.getRandomValues(buf);
  return min + (buf[0] % range);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = randInt(0,i);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function tmdbFetch(url){
  const res = await fetch(url, {
    method: "GET",
    cache: "no-store",
    headers: { "Accept": "application/json" }
  });
  if(!res.ok) throw new Error("TMDB HTTP " + res.status);
  return res.json();
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =======================
   PREMIUM
======================= */
function isPremiumPurchased(){
  return localStorage.getItem(LS.premium) === "1";
}
function setPremiumPurchased(v){
  localStorage.setItem(LS.premium, v ? "1" : "0");
  refreshPremiumStatus();
}
function refreshPremiumStatus(){
  const st = el("premiumStatus");
  st.textContent = isPremiumPurchased()
    ? "Premium attivo su questo dispositivo."
    : "Premium non attivo. Premi Sblocca Premium per simulare l'acquisto.";
}
function refreshPremiumGateInfo(){
  const info = el("premiumGateInfo");
  info.textContent = isPremiumPurchased()
    ? "Ok. Premi Cerca per ottenere 5 risultati più pertinenti e vari."
    : "Premium bloccato. Premi Sblocca Premium nella home, oppure usa Basic.";
}

/* =======================
   BASIC LIMIT
======================= */
function canBasicSearch(){
  if(BASIC_TEST_MODE_UNLIMITED) return true;
  const last = localStorage.getItem(LS.lastBasicSearchDate) || "";
  return last !== todayISO();
}
function markBasicSearched(){
  if(BASIC_TEST_MODE_UNLIMITED) return;
  localStorage.setItem(LS.lastBasicSearchDate, todayISO());
}
function refreshBasicLimitInfo(){
  const info = el("basicLimitInfo");
  if(BASIC_TEST_MODE_UNLIMITED){
    info.textContent = "Test attivo. Ricerche Basic senza limiti.";
    return;
  }
  info.textContent = canBasicSearch()
    ? "Puoi fare 1 ricerca oggi."
    : "Hai già fatto la ricerca oggi. Riprova domani.";
}

/* =======================
   SHOWN SETS
======================= */
function loadShownSet(kind){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return new Set();
    return new Set(arr);
  }catch{
    return new Set();
  }
}
function saveShownSet(kind, set){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  const arr = Array.from(set).slice(0, 2200);
  localStorage.setItem(key, JSON.stringify(arr));
}
function resetShown(kind){
  const key = kind === "movie" ? LS.shownMovies : LS.shownTv;
  localStorage.removeItem(key);
}

/* =======================
   PROVIDERS PICK
======================= */
function buildProviderPick(containerId){
  const box = el(containerId);
  box.innerHTML = "";
  PROVIDERS.forEach(p => {
    const lab = document.createElement("label");
    lab.className = "chip";
    lab.innerHTML = `<input type="checkbox" value="${p.id}"> ${p.name}`;
    box.appendChild(lab);
  });
}
function readPickedProviders(containerId){
  const box = el(containerId);
  const ids = [];
  box.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if(cb.checked) ids.push(cb.value);
  });
  return ids.join("|");
}

/* =======================
   PREMIUM SLIDERS
======================= */
const PREMIUM_GENRES = [
  { key:"azione", label:"Azione" },
  { key:"comico", label:"Comico" },
  { key:"thriller", label:"Thriller" },
  { key:"animazione", label:"Animazione" },
  { key:"romantico", label:"Romantico" },
  { key:"dramma", label:"Dramma" },
  { key:"fantascienza", label:"Fantascienza" },
  { key:"avventura", label:"Avventura" },
  { key:"crime", label:"Crime" }
];

function buildPremiumSliders(){
  const root = el("premiumSliders");
  root.innerHTML = "";
  PREMIUM_GENRES.forEach(g => {
    const row = document.createElement("div");
    row.className = "sliderRow";
    row.innerHTML = `
      <div class="hdr">
        <strong>${g.label}</strong>
        <span id="val_${g.key}">0</span>
      </div>
      <input id="s_${g.key}" type="range" min="0" max="5" step="1" value="0" />
    `;
    root.appendChild(row);
    const inp = row.querySelector("input");
    inp.addEventListener("input", () => {
      el("val_"+g.key).textContent = inp.value;
    });
  });
}

function readPremiumWeights(){
  const weights = {};
  PREMIUM_GENRES.forEach(g => {
    weights[g.key] = Number(el("s_"+g.key).value || 0);
  });
  return weights;
}

/* =======================
   SEARCH IMPROVEMENTS
   Obiettivi:
   1 più varietà, meno ripetizioni
   2 risultati più pertinenti agli slider
   3 meno dipendenza da una sola pagina o un solo sort
======================= */
function buildGenreSelectionFromWeights(weights){
  const entries = Object.keys(weights).map(k => ({ k, v: weights[k] })).filter(x => x.v > 0);
  if(entries.length === 0) return { chosenKeys: [], chosenIds: [] };

  entries.sort((a,b) => b.v - a.v);

  const hard = entries.filter(x => x.v >= 4).map(x => x.k);
  const mid = entries.filter(x => x.v === 3).map(x => x.k);
  const soft = entries.filter(x => x.v <= 2).map(x => x.k);

  const chosen = [];
  hard.forEach(k => chosen.push(k));
  if(chosen.length < 3){
    shuffle(mid);
    mid.forEach(k => { if(chosen.length < 3) chosen.push(k); });
  }
  if(chosen.length < 2){
    shuffle(soft);
    soft.forEach(k => { if(chosen.length < 2) chosen.push(k); });
  }
  if(chosen.length > 4){
    chosen.length = 4;
  }

  return { chosenKeys: chosen, chosenIds: [] };
}

function buildDiscoverParams({ kind, genreCsv, providerCsv, isBasicMovie, loosen }){
  const params = new URLSearchParams();
  params.set("api_key", TMDB_API_KEY);
  params.set("language", TMDB_LANG);
  params.set("region", TMDB_REGION);
  params.set("watch_region", TMDB_REGION);

  params.set("include_adult", "false");
  params.set("include_video", "false");

  if(loosen){
    params.set("vote_count.gte", "40");
    params.set("vote_average.gte", "5.8");
  }else{
    params.set("vote_count.gte", "110");
    params.set("vote_average.gte", "6.0");
  }

  if(kind === "movie"){
    params.set("primary_release_date.gte", "1980-01-01");
  }else{
    params.set("first_air_date.gte", "1980-01-01");
  }

  if(genreCsv) params.set("with_genres", genreCsv);

  if(providerCsv){
    params.set("with_watch_providers", providerCsv);
  }

  if(isBasicMovie && BASIC_BLOCK_VM18){
    params.set("certification_country", BASIC_CERT_COUNTRY);
    params.set("certification.lte", BASIC_CERT_LTE);
  }

  const sortPool = loosen
    ? ["popularity.desc","vote_average.desc","primary_release_date.desc","revenue.desc"]
    : ["popularity.desc","vote_average.desc","revenue.desc"];

  params.set("sort_by", sortPool[randInt(0, sortPool.length-1)]);
  return params;
}

async function fetchDiscover({ kind, params, page }){
  params.set("page", String(page));
  const endpoint = kind === "movie" ? "discover/movie" : "discover/tv";
  const url = `https://api.themoviedb.org/3/${endpoint}?` + params.toString();
  return tmdbFetch(url);
}

async function getProvidersForItem(kind, id){
  const endpoint = kind === "movie" ? `movie/${id}/watch/providers` : `tv/${id}/watch/providers`;
  const url = `https://api.themoviedb.org/3/${endpoint}?api_key=${encodeURIComponent(TMDB_API_KEY)}`;
  const data = await tmdbFetch(url);
  const it = data && data.results ? data.results[TMDB_REGION] : null;
  if(!it) return null;

  return {
    link: it.link || "",
    flatrate: Array.isArray(it.flatrate) ? it.flatrate : [],
    rent: Array.isArray(it.rent) ? it.rent : [],
    buy: Array.isArray(it.buy) ? it.buy : []
  };
}

function mergeProviders(p){
  if(!p) return [];
  const map = new Map();
  const add = (arr) => {
    (arr || []).forEach(x => {
      if(!x || !x.provider_id) return;
      if(!map.has(x.provider_id)) map.set(x.provider_id, x);
    });
  };
  add(p.flatrate);
  add(p.rent);
  add(p.buy);
  return Array.from(map.values());
}

function hasAnyProviderInIT(p){
  return mergeProviders(p).length > 0;
}

async function fetchDetails(kind, id, language){
  const endpoint = kind === "movie" ? `movie/${id}` : `tv/${id}`;
  const url = `https://api.themoviedb.org/3/${endpoint}?api_key=${encodeURIComponent(TMDB_API_KEY)}&language=${encodeURIComponent(language)}`;
  return tmdbFetch(url);
}

async function ensureOverview(kind, item){
  const current = (item && item.overview) ? String(item.overview).trim() : "";
  if(current && current.length >= 30) return item;

  try{
    const it = await fetchDetails(kind, item.id, TMDB_LANG);
    const itOv = it && it.overview ? String(it.overview).trim() : "";
    if(itOv && itOv.length >= 30){
      item.overview = itOv;
      return item;
    }
  }catch{}

  try{
    const en = await fetchDetails(kind, item.id, "en-US");
    const enOv = en && en.overview ? String(en.overview).trim() : "";
    if(enOv && enOv.length >= 30){
      item.overview = enOv;
      return item;
    }
  }catch{}

  item.overview = item.overview || "";
  return item;
}

function scoreCandidate(item, targetGenreIds, weightSum){
  const pop = typeof item.popularity === "number" ? item.popularity : 0;
  const voteAvg = typeof item.vote_average === "number" ? item.vote_average : 0;
  const voteCnt = typeof item.vote_count === "number" ? item.vote_count : 0;

  const g = Array.isArray(item.genre_ids) ? item.genre_ids : [];
  let match = 0;
  targetGenreIds.forEach(id => { if(g.includes(id)) match++; });

  const s =
    (pop * 1.0) +
    (voteAvg * 45) +
    (Math.min(voteCnt, 4500) * 0.018) +
    (match * 220) +
    (weightSum * 18);

  return { score: s, match };
}

async function getBetterItems({
  kind,
  targetGenreIds,
  providerCsv,
  count,
  isBasicMovie
}){
  const shown = loadShownSet(kind);

  const genreCsv = targetGenreIds.join(",");
  const loosen = false;
  const loosen2 = true;

  const paramsA = buildDiscoverParams({ kind, genreCsv, providerCsv, isBasicMovie, loosen });
  const paramsB = buildDiscoverParams({ kind, genreCsv, providerCsv, isBasicMovie, loosen: loosen2 });

  const weightSum = Math.max(1, targetGenreIds.length);

  const candidates = new Map();

  async function pull(params){
    let first;
    try{
      first = await fetchDiscover({ kind, params: new URLSearchParams(params.toString()), page: 1 });
    }catch{
      return;
    }
    const totalPages = Math.max(1, Math.min(500, Number(first.total_pages || 1)));

    const pagesToTry = [];
    pagesToTry.push(1);

    for(let i=0;i<7;i++){
      const p = randInt(1, totalPages);
      pagesToTry.push(p);
    }

    shuffle(pagesToTry);

    for(const p of pagesToTry){
      let data;
      try{
        data = (p === 1) ? first : await fetchDiscover({ kind, params: new URLSearchParams(params.toString()), page: p });
      }catch{
        continue;
      }

      const results = Array.isArray(data.results) ? data.results.slice() : [];
      shuffle(results);

      for(const raw of results){
        const id = raw && raw.id ? String(raw.id) : "";
        if(!id) continue;
        if(shown.has(id)) continue;
        if(candidates.has(id)) continue;

        if(!raw.poster_path) continue;

        const sc = scoreCandidate(raw, targetGenreIds, weightSum);
        candidates.set(id, { item: raw, score: sc.score, match: sc.match });
        if(candidates.size >= 70) return;
      }
      if(candidates.size >= 70) return;
    }
  }

  await pull(paramsA);
  if(candidates.size < 26){
    await pull(paramsB);
  }

  const list = Array.from(candidates.values());
  list.sort((a,b) => b.score - a.score);

  const pickPool = list.slice(0, Math.max(14, count * 6));
  shuffle(pickPool);

  const picked = [];

  for(const c of pickPool){
    if(picked.length >= count) break;

    let providers = null;
    try{
      providers = await getProvidersForItem(kind, c.item.id);
    }catch{
      providers = null;
    }
    if(!hasAnyProviderInIT(providers)) continue;

    let item = c.item;
    try{
      item = await ensureOverview(kind, item);
    }catch{}

    const id = String(item.id);
    shown.add(id);
    picked.push({ item, providers, score: c.score, match: c.match });
  }

  saveShownSet(kind, shown);
  return picked;
}

/* =======================
   RENDER
======================= */
function formatYear(kind, item){
  const d = kind === "movie" ? item.release_date : item.first_air_date;
  if(!d) return "";
  return String(d).slice(0,4);
}

function formatRating(item){
  const v = typeof item.vote_average === "number" ? item.vote_average.toFixed(1) : "-";
  const c = typeof item.vote_count === "number" ? item.vote_count : "-";
  return `Voto ${v}, voti ${c}`;
}

function clipText(text, maxLen){
  if(!text) return "Trama non disponibile.";
  const t = String(text).trim();
  if(t.length <= maxLen) return t;
  return t.slice(0, maxLen) + "...";
}

function renderProvidersBlock(p){
  if(!p) return `<div class="note">Non trovato in Italia.</div>`;

  const merged = mergeProviders(p);
  if(!merged.length){
    return `<div class="note">Non trovato in Italia.</div>`;
  }

  const items = merged.slice(0, 12).map(x => {
    const logo = x.logo_path ? (LOGO_W45 + x.logo_path) : "";
    const img = logo ? `<img src="${logo}" alt="">` : `<img alt="">`;
    const nm = x.provider_name ? x.provider_name : "";
    return `<div class="provItem">${img}<span>${escapeHtml(nm)}</span></div>`;
  }).join("");

  const link = p.link ? `<div class="note">Link: <a class="link" href="${p.link}" target="_blank" rel="noopener">Apri</a></div>` : "";

  return `
    <div class="providers">
      <div class="provGroup">
        <p class="t">Disponibile su</p>
        <div class="provList">${items}</div>
      </div>
    </div>
    ${link}
  `;
}

function savePicked(kind, item, providers){
  const payload = {
    ts: Date.now(),
    kind,
    id: item && item.id ? item.id : null,
    title: kind === "movie" ? (item.title || "") : (item.name || ""),
    year: formatYear(kind, item),
    providerLink: providers && providers.link ? providers.link : ""
  };
  localStorage.setItem(LS.picked, JSON.stringify(payload));
}

function renderResults(containerId, kind, entries, titleSuffix, plotMaxLen){
  const root = el(containerId);
  if(!entries || !entries.length){
    root.innerHTML = `<div class="card"><h3>Nessun risultato</h3><p>Allarga i filtri o resetta i risultati mostrati.</p></div>`;
    return;
  }

  const html = entries.map((e, idx) => {
    const item = e.item;
    const providers = e.providers;

    const name = kind === "movie" ? item.title : item.name;
    const year = formatYear(kind, item);
    const rating = formatRating(item);
    const pop = typeof item.popularity === "number" ? item.popularity.toFixed(0) : "-";

    const posterUrl = POSTER_W342 + item.poster_path;
    const btnId = `watch_${containerId}_${idx}`;
    const openId = `open_${containerId}_${idx}`;

    const openBtn = providers && providers.link
      ? `<button class="openBtn" id="${openId}" type="button">Apri piattaforme</button>`
      : "";

    const devBlock = DEV_NOTES_ENABLED ? `
      <div class="devNote">
DEV INFO
kind: ${kind}
tmdb_id: ${escapeHtml(String(item.id))}
providers_it: ${mergeProviders(providers).length}
score: ${escapeHtml(String(Math.round(e.score || 0)))}
match_genres: ${escapeHtml(String(e.match || 0))}
note: in app ufficiale queste note spariscono
      </div>
    ` : "";

    return `
      <div class="resultCard">
        <div class="poster"><img src="${posterUrl}" alt=""></div>
        <div>
          <h4>${escapeHtml(name || "Titolo")}</h4>
          <div class="meta">
            <div>${year ? "Anno " + escapeHtml(year) : "Anno -"}</div>
            <div>${escapeHtml(rating)}</div>
            <div>Pop ${escapeHtml(pop)}</div>
            <div>${escapeHtml(titleSuffix)}</div>
          </div>
          <p class="plot">${escapeHtml(clipText(item.overview, plotMaxLen))}</p>
          ${renderProvidersBlock(providers)}
          <div class="actionRow">
            <button class="watchBtn" id="${btnId}" type="button">Guarda</button>
            ${openBtn}
          </div>
          ${devBlock}
        </div>
      </div>
    `;
  }).join("");

  root.innerHTML = html;

  entries.forEach((e, idx) => {
    const btnId = `watch_${containerId}_${idx}`;
    const openId = `open_${containerId}_${idx}`;
    const item = e.item;
    const providers = e.providers;

    const watchBtn = document.getElementById(btnId);
    if(watchBtn){
      watchBtn.addEventListener("click", () => {
        savePicked(kind, item, providers);
        startCinemaExit();
      });
    }

    const openBtn = document.getElementById(openId);
    if(openBtn && providers && providers.link){
      openBtn.addEventListener("click", () => {
        try{ window.open(providers.link, "_blank", "noopener"); }catch{}
      });
    }
  });
}

/* =======================
   BASIC
======================= */
function readBasicSelectedGenres(){
  const ids = [];
  document.querySelectorAll("#basicGenres input[type='checkbox']").forEach(cb => {
    if(cb.checked){
      const key = cb.value;
      const id = GENRE_MAP_MOVIE[key];
      if(id) ids.push(id);
    }
  });
  return ids;
}

async function runBasic(){
  if(!canBasicSearch()){
    toast("Hai già fatto la ricerca oggi.");
    refreshBasicLimitInfo();
    return;
  }

  const genreIds = readBasicSelectedGenres();
  if(!genreIds.length){
    toast("Seleziona almeno 1 genere.");
    return;
  }

  const providerCsv = readPickedProviders("basicProvidersPick");

  el("btnBasicSearch").disabled = true;
  el("basicResults").innerHTML = `<div class="card"><h3>Ricerca in corso</h3><p>Sto cercando film disponibili in Italia.</p></div>`;

  try{
    const entries = await getBetterItems({
      kind: "movie",
      targetGenreIds: genreIds,
      providerCsv,
      count: 3,
      isBasicMovie: true
    });
    renderResults("basicResults", "movie", entries, "Basic", PLOT_MAX_BASIC);
    markBasicSearched();
    refreshBasicLimitInfo();
    toast("Fatto.");
  }catch(err){
    el("basicResults").innerHTML = `<div class="card"><h3>Errore</h3><p>Controlla rete e riprova.</p><p class="note">${escapeHtml(String(err || ""))}</p></div>`;
    toast("Errore TMDB.");
  }finally{
    el("btnBasicSearch").disabled = false;
  }
}

/* =======================
   PREMIUM
======================= */
function getPremiumKind(){
  const v = document.querySelector('input[name="premiumType"]:checked');
  return v ? v.value : "movie";
}

function mapGenreIdsForKind(kind, keys){
  const map = kind === "movie" ? GENRE_MAP_MOVIE : GENRE_MAP_TV;
  return keys.map(k => map[k]).filter(Boolean);
}

async function runPremium(){
  if(!isPremiumPurchased()){
    toast("Premium bloccato.");
    refreshPremiumGateInfo();
    return;
  }

  const kind = getPremiumKind();
  const weights = readPremiumWeights();
  const sel = buildGenreSelectionFromWeights(weights);

  if(!sel.chosenKeys.length){
    toast("Alza almeno 1 slider.");
    return;
  }

  const targetGenreIds = mapGenreIdsForKind(kind, sel.chosenKeys);
  if(!targetGenreIds.length){
    toast("Generi non validi.");
    return;
  }

  const providerCsv = readPickedProviders("premiumProvidersPick");

  el("btnPremiumSearch").disabled = true;
  el("premiumResults").innerHTML = `<div class="card"><h3>Ricerca in corso</h3><p>Sto cercando titoli disponibili in Italia.</p></div>`;

  try{
    const entries = await getBetterItems({
      kind,
      targetGenreIds,
      providerCsv,
      count: 5,
      isBasicMovie: false
    });
    renderResults("premiumResults", kind, entries, "Premium", PLOT_MAX_PREMIUM);
    toast("Fatto.");
  }catch(err){
    el("premiumResults").innerHTML = `<div class="card"><h3>Errore</h3><p>Controlla rete e riprova.</p><p class="note">${escapeHtml(String(err || ""))}</p></div>`;
    toast("Errore TMDB.");
  }finally{
    el("btnPremiumSearch").disabled = false;
  }
}

/* =======================
   CINEMA EXIT 2.0
======================= */
let audioCtx = null;

function audioEnsure(){
  if(audioCtx) return audioCtx;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return null;
  audioCtx = new Ctx();
  return audioCtx;
}

function audioClick(atMs, gainValue, freq){
  const ctx = audioEnsure();
  if(!ctx) return;

  const t0 = ctx.currentTime + (atMs / 1000);

  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = "square";
  o.frequency.setValueAtTime(freq, t0);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gainValue), t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.06);

  o.connect(g);
  g.connect(ctx.destination);

  o.start(t0);
  o.stop(t0 + 0.07);
}

function audioProjectorSequence(){
  const ctx = audioEnsure();
  if(!ctx) return;

  try{
    if(ctx.state === "suspended") ctx.resume();
  }catch{}

  audioClick(0,   0.07, 120);
  audioClick(90,  0.06, 150);
  audioClick(210, 0.06, 110);
  audioClick(340, 0.05, 170);
}

function vibratePattern(){
  try{
    if(navigator.vibrate){
      navigator.vibrate([50,30,70,40,90,50,120,60,160]);
    }
  }catch{}
}

function typeText(elm, text, speedMs){
  elm.textContent = "";
  let i = 0;
  const t = setInterval(() => {
    i++;
    elm.textContent = text.slice(0, i);
    if(i >= text.length) clearInterval(t);
  }, speedMs);
}

function tryClose(){
  try{ history.back(); }catch{}
  try{ window.close(); }catch{}
}

function startCinemaExit(){
  const overlay = el("cinemaOverlay");
  const card = el("cinemaCard");
  const title = el("cinemaTitle");

  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");
  overlay.classList.remove("showButtons");
  overlay.classList.remove("ready");
  overlay.classList.remove("curtainsOn");
  overlay.classList.remove("flashOn");

  typeText(title, "Mettiti comodo inizia lo spettacolo", 18);

  audioProjectorSequence();
  vibratePattern();

  card.classList.add("shakeHard");

  setTimeout(() => {
    overlay.classList.add("flashOn");
  }, 70);

  setTimeout(() => {
    overlay.classList.add("curtainsOn");
  }, 160);

  setTimeout(() => {
    card.classList.remove("shakeHard");
    overlay.classList.add("ready");
  }, 950);

  setTimeout(() => {
    tryClose();
    setTimeout(() => {
      overlay.classList.add("showButtons");
    }, 380);
  }, 1200);
}

function cancelCinemaExit(){
  const overlay = el("cinemaOverlay");
  const card = el("cinemaCard");

  overlay.classList.remove("show");
  overlay.classList.remove("showButtons");
  overlay.classList.remove("ready");
  overlay.classList.remove("curtainsOn");
  overlay.classList.remove("flashOn");
  overlay.setAttribute("aria-hidden","true");

  card.classList.remove("shakeHard");
  try{ if(navigator.vibrate) navigator.vibrate(0); }catch{}

  toast("Ok. Resta in app.");
}

function forceCinemaExit(){
  tryClose();
}

/* =======================
   INIT
======================= */
function init(){
  setDevMode();

  refreshPremiumStatus();
  refreshBasicLimitInfo();
  refreshPremiumGateInfo();

  buildProviderPick("basicProvidersPick");
  buildProviderPick("premiumProvidersPick");
  buildPremiumSliders();

  devSet("devStartNote",
`DEV INFO
DEV_NOTES_ENABLED: ${DEV_NOTES_ENABLED}
Ricerca migliorata: campionamento multi pagina, punteggio, più varietà
Chiusura cinema 2.0: flash, tendine, suono, typewriter`);

  devSet("devBasicHomeNote",
`DEV INFO BASIC
Esclusione VM18: certification_country=${BASIC_CERT_COUNTRY}, certification.lte=${BASIC_CERT_LTE}
Limite giornaliero: ${BASIC_TEST_MODE_UNLIMITED ? "disattivo per test" : "attivo 1 al giorno"}`);

  devSet("devPremiumHomeNote",
`DEV INFO PREMIUM
Selezione generi: prende 2 a 4 generi in base agli slider
Ricerca: punteggio con match generi e qualità, poi verifica provider IT`);

  devSet("devExitNote",
`DEV INFO USCITA
Flash bianco, tendine laterali, grana, flicker, scanlines
Suono stile proiettore via WebAudio
Vibrazione se supportata
Poi prova history.back e window.close, se non chiude mostra i bottoni`);

  devSet("devBasicScreenNote","DEV INFO BASIC. Campionamento multi pagina e anti ripetizione.");
  devSet("devProvidersNote","DEV INFO. La app mostra provider IT unificati, senza distinguere noleggio o abbonamento.");
  devSet("devBasicSearchNote",`DEV INFO. Trama breve max ${PLOT_MAX_BASIC}. Risultati 3.`);
  devSet("devPremiumScreenNote","DEV INFO PREMIUM. Generi selezionati da slider e ricerca con punteggio.");
  devSet("devPremiumSearchNote",`DEV INFO. Trama lunga max ${PLOT_MAX_PREMIUM}. Risultati 5.`);
  devSet("devCinemaExitNote","DEV INFO. Se non si chiude, usa Esci o Annulla.");

  el("btnGoBasic").addEventListener("click", () => {
    showScreen("screenBasic");
    refreshBasicLimitInfo();
  });

  el("btnGoPremium").addEventListener("click", () => {
    showScreen("screenPremium");
    refreshPremiumGateInfo();
  });

  el("btnBuyPremium").addEventListener("click", () => {
    setPremiumPurchased(true);
    toast("Premium attivato su questo dispositivo.");
    refreshPremiumGateInfo();
  });

  el("btnInfoBasic").addEventListener("click", () => {
    toast("Basic: film disponibili in Italia, trame brevi, escluso VM18.");
  });

  el("btnBackFromBasic").addEventListener("click", () => showScreen("screenStart"));
  el("btnBackFromPremium").addEventListener("click", () => showScreen("screenStart"));

  el("btnBasicSearch").addEventListener("click", runBasic);
  el("btnPremiumSearch").addEventListener("click", runPremium);

  el("btnBasicResetShown").addEventListener("click", () => {
    resetShown("movie");
    el("basicResults").innerHTML = "";
    toast("Reset fatto.");
  });

  el("btnPremiumResetShown").addEventListener("click", () => {
    const kind = getPremiumKind();
    resetShown(kind);
    el("premiumResults").innerHTML = "";
    toast("Reset fatto.");
  });

  el("btnLockPremium").addEventListener("click", () => {
    setPremiumPurchased(false);
    el("premiumResults").innerHTML = "";
    refreshPremiumGateInfo();
    toast("Premium bloccato.");
  });

  document.querySelectorAll('input[name="premiumType"]').forEach(r => {
    r.addEventListener("change", () => {
      el("premiumResults").innerHTML = "";
      toast(getPremiumKind() === "movie" ? "Modalità Film" : "Modalità Serie TV");
    });
  });

  el("btnExitFromStart").addEventListener("click", startCinemaExit);
  el("btnExitFromBasic").addEventListener("click", startCinemaExit);
  el("btnExitFromPremium").addEventListener("click", startCinemaExit);

  el("btnCancelExit").addEventListener("click", cancelCinemaExit);
  el("btnForceExit").addEventListener("click", forceCinemaExit);
}

init();
</script>
</body>
</html>
