<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Movie Finder</title>

<!-- MANIFEST PWA -->
<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#050816;
  --card:#0b1020;
  --accent-yellow:#d9ff2f;
  --accent-green:#39ff6b;
  --accent-blue:#0f172a;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#1f2937;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}

.app{
  max-width:480px;
  margin:0 auto;
}

/* CARD BASE */
.card{
  background:var(--card);
  border-radius:22px;
  padding:18px 18px 20px;
  margin-bottom:16px;
  border:1px solid var(--border);
}

h1,h2,h3{
  margin:0 0 10px;
}

.small{
  color:var(--muted);
  font-size:13px;
}

.btn{
  padding:13px 18px;
  border-radius:999px;
  border:none;
  font-weight:800;
  cursor:pointer;
  font-size:14px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}

.btn:disabled{
  opacity:0.5;
  cursor:default;
}

.btn-primary{
  background:linear-gradient(90deg,var(--accent-yellow),var(--accent-green));
  color:var(--accent-blue);
}

.btn-secondary{
  background:transparent;
  border:1px solid #374151;
  color:#f9fafb;
}

.btn-ghost{
  background:transparent;
  color:#f9fafb;
}

/* TOGGLE VISIBILITY */
.hidden{display:none}

/* SPLASH */
#splashScreen{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,var(--accent-green)10%,#020617 55%,#000 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:50;
  color:#0b1120;
  text-align:center;
  animation:fadeIn 0.5s ease-out;
}

#splashLogo{
  font-size:32px;
  font-weight:900;
  letter-spacing:1px;
  margin-bottom:10px;
}

#splashText{
  font-size:16px;
}

.fade-out{
  animation:fadeOut 0.6s ease-out forwards;
}

@keyframes fadeOut{
  to{opacity:0;transform:translateY(-6px);pointer-events:none;}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:translateY(0);}
}

/* HOME */
.home-title{
  font-size:24px;
  font-weight:800;
  margin-bottom:6px;
}

.badge{
  display:inline-flex;
  align-items:center;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  background:rgba(17,24,39,0.9);
  border:1px solid #111827;
  color:var(--muted);
}

/* LAYOUT BOTTONI HOME */
.home-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:14px;
}

/* SEZIONE BASIC */
.genre-list{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}

.genre{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid #111827;
  background:#020617;
}

.genre label{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
}

.genre input[type=checkbox]{
  width:18px;
  height:18px;
  accent-color:var(--accent-green);
}

.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

/* RISULTATI BASIC */
.results{
  margin-top:10px;
}

.result{
  border:1px solid #374151;
  border-radius:18px;
  padding:10px;
  display:grid;
  grid-template-columns:85px 1fr;
  gap:10px;
  margin-bottom:12px;
  background:#020617;
}

.poster{
  width:85px;
  height:125px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

.poster img{width:100%;height:100%;object-fit:cover}

.result-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:4px;
}

.result-overview{
  font-size:13px;
  color:var(--muted);
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.platforms{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}

.platform-tag{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  background:#020617;
  border:1px solid #1f2937;
  display:inline-flex;
  align-items:center;
  gap:4px;
}

.platform-dot{
  width:6px;
  height:6px;
  border-radius:999px;
}

.platform-netflix{background:#e50914;}
.platform-prime{background:#00a8e1;}
.platform-disney{background:#113ccf;}
.platform-apple{background:#9ca3af;}
.platform-now{background:#00ffb2;}

/* FOOTER BASIC */
.basic-footer{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:8px;
}

/* OVERLAY USCITA */
#exitOverlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:99;
  color:#f9fafb;
}

#exitOverlay.show{display:flex}

#exitOverlay h2{
  margin-bottom:10px;
}

/* LOGIN PREMIUM */
.input-group{
  margin-top:10px;
}

.input-group label{
  display:block;
  font-size:13px;
  color:var(--muted);
  margin-bottom:4px;
}

.input-group input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #111827;
  background:#020617;
  color:#f9fafb;
  font-size:14px;
}

/* PREMIUM LAYOUT BASE */
.tabs{
  display:flex;
  gap:6px;
  overflow-x:auto;
  padding-bottom:4px;
}

.tab{
  padding:7px 11px;
  border-radius:999px;
  border:1px solid #111827;
  background:#020617;
  font-size:12px;
  cursor:pointer;
  white-space:nowrap;
}

.tab.active{
  background:linear-gradient(90deg,var(--accent-yellow),var(--accent-green));
  color:var(--accent-blue);
  border:none;
}

/* SCHERMATE STEP PREMIUM */
.step{
  margin-top:10px;
}

/* SLIDER GENERI PREMIUM */
.premium-genres{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:6px;
  max-height:260px;
  overflow-y:auto;
}

.slider-row{
  background:#020617;
  border-radius:14px;
  padding:8px 10px;
  border:1px solid #111827;
}

.slider-row-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  margin-bottom:4px;
}

.slider-row input[type=range]{
  width:100%;
}

/* PIATTAFORME PREMIUM */
.platform-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:8px;
}

.platform-pill{
  padding:8px 10px;
  border-radius:14px;
  border:1px solid #111827;
  background:#020617;
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
}

.platform-pill.selected{
  border-color:var(--accent-green);
  box-shadow:0 0 0 1px rgba(57,255,107,0.4);
}

/* RISULTATI PREMIUM */
.premium-result{
  border-radius:18px;
  border:1px solid #374151;
  background:#020617;
  padding:10px;
  display:grid;
  grid-template-columns:95px 1fr;
  gap:10px;
  margin-bottom:12px;
}

.premium-poster{
  width:95px;
  height:140px;
  border-radius:12px;
  overflow:hidden;
  background:#000;
}

.premium-poster img{width:100%;height:100%;object-fit:cover}

.premium-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:4px;
}

.premium-overview{
  font-size:13px;
  color:var(--muted);
  margin-bottom:6px;
  max-height:72px;
  overflow:hidden;
}

.stats{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  font-size:11px;
  margin-bottom:6px;
}

.stat-pill{
  padding:3px 8px;
  border-radius:999px;
  background:#020617;
  border:1px solid #1f2937;
}

/* LISTE (WATCHLIST, ULTIMI VISTI) */
.simple-list{
  margin-top:8px;
}

.simple-item{
  padding:8px 10px;
  border-radius:14px;
  border:1px solid #111827;
  background:#020617;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

/* SOCIAL */
.share-btn{
  font-size:13px;
}

/* MESSAGGI */
.message{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
}
.message.error{
  color:#f97373;
}

/* INSTALL PROMPT BANNER */
#installBanner{
  position:fixed;
  left:16px;
  right:16px;
  bottom:16px;
  background:#020617;
  border-radius:16px;
  border:1px solid #111827;
  padding:10px 12px;
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  z-index:40;
}
#installBanner.show{display:flex}
#installBannerText{
  font-size:12px;
  color:var(--muted);
}

/* SCROLLBARS MOBILE-FRIENDLY */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px;}
</style>
</head>
<body>
<div class="app">

  <!-- SPLASH -->
  <div id="splashScreen">
    <div id="splashLogo">Movie Finder</div>
    <div id="splashText">Cosa vuoi guardare oggi?</div>
  </div>

  <!-- HOME -->
  <div class="card" id="homeCard">
    <div class="badge">PWA · Nessuna configurazione</div>
    <div class="home-title" style="margin-top:8px;">Movie Finder</div>
    <p class="small">Scegli la modalità di utilizzo.</p>

    <div class="home-actions">
      <button class="btn btn-primary" id="basicModeBtn">BASIC</button>
      <button class="btn btn-secondary" id="premiumModeBtn">PREMIUM</button>
    </div>
  </div>

  <!-- BASIC: FILTRI -->
  <div class="card hidden" id="basicFiltersCard">
    <div class="section-header">
      <div>
        <h2>Modalità BASIC</h2>
        <p class="small">Scegli i generi per la serata.</p>
      </div>
      <button class="btn btn-ghost" id="backToHomeFromBasic">Indietro</button>
    </div>

    <p class="small" style="margin-top:6px;">Regola AND: i film devono rispettare tutti i generi selezionati.</p>

    <div class="genre-list" id="basicGenres">
      <div class="genre">
        <label><input type="checkbox" value="35"> Comico</label>
      </div>
      <div class="genre">
        <label><input type="checkbox" value="28"> Azione</label>
      </div>
      <div class="genre">
        <label><input type="checkbox" value="10749"> Romantico</label>
      </div>
      <div class="genre">
        <label><input type="checkbox" value="16"> Cartoni animati</label>
      </div>
    </div>

    <div class="basic-footer">
      <button class="btn btn-secondary" id="basicSearchBtn">Trova film</button>
      <span class="small">1 ricerca al giorno · 3 risultati</span>
    </div>

    <div class="message" id="basicInfoMsg">Contenuti VM18 esclusi automaticamente.</div>
    <div class="message error hidden" id="basicErrorMsg"></div>
  </div>

  <!-- BASIC: RISULTATI -->
  <div class="card hidden" id="basicResultsCard">
    <div class="section-header">
      <div>
        <h2>Risultati BASIC</h2>
        <p class="small">Ecco le proposte per stasera.</p>
      </div>
      <button class="btn btn-ghost" id="basicCloseBtn">Chiudi</button>
    </div>

    <div class="results" id="basicResultsBox"></div>

    <div class="basic-footer">
      <button class="btn btn-secondary" id="basicSearchAgainBtn">Nuova ricerca</button>
      <span class="small">Limite: 1 ricerca al giorno</span>
    </div>
  </div>

  <!-- PREMIUM: LOGIN -->
  <div class="card hidden" id="premiumLoginCard">
    <div class="section-header">
      <div>
        <h2>Area PREMIUM</h2>
        <p class="small">Accesso riservato per funzionalità avanzate.</p>
      </div>
      <button class="btn btn-ghost" id="backToHomeFromPremium">Indietro</button>
    </div>

    <div class="input-group">
      <label for="loginEmail">Email</label>
      <input id="loginEmail" type="email" autocomplete="off" placeholder="Inserisci email">
    </div>

    <div class="input-group">
      <label for="loginPassword">Password</label>
      <input id="loginPassword" type="password" autocomplete="off" placeholder="Inserisci password">
    </div>

    <button class="btn btn-primary" id="loginBtn" style="margin-top:12px;width:100%;">Entra in PREMIUM</button>
    <p class="small" style="margin-top:8px;">Demo: email <b>maprexx@gmail.com</b>, password <b>1234</b>.</p>
    <div class="message error hidden" id="loginErrorMsg"></div>
  </div>

  <!-- PREMIUM: MAIN AREA -->
  <div class="card hidden" id="premiumMainCard">
    <div class="section-header">
      <div>
        <h2>Premium</h2>
        <p class="small">Ricerca avanzata senza limiti.</p>
      </div>
      <button class="btn btn-ghost" id="premiumLogoutBtn">Esci</button>
    </div>

    <!-- MENU PREMIUM -->
    <div class="tabs" style="margin-top:10px;" id="premiumTabs">
      <button class="tab active" data-tab="film">Film</button>
      <button class="tab" data-tab="serie">Serie TV</button>
      <button class="tab" data-tab="trending">Trending</button>
      <button class="tab" data-tab="watchlist">Watchlist</button>
      <button class="tab" data-tab="social">Social</button>
      <button class="tab" data-tab="recenti">Ultimi visti</button>
    </div>

    <!-- CONTENUTO PREMIUM: FILM / SERIE -->
    <div id="premiumContent">

      <!-- FILM / SERIE: STEP -->
      <div id="tab-film" class="premium-tab">
        <div class="step" id="stepTipoContenuto">
          <h3>Cosa vuoi cercare?</h3>
          <p class="small">Scegli tra film e serie TV.</p>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn btn-secondary" id="premiumFilmBtn">Film</button>
            <button class="btn btn-secondary" id="premiumSerieBtn">Serie TV</button>
          </div>
        </div>

        <div class="step hidden" id="stepGeneri">
          <h3>Preferenze generi</h3>
          <p class="small">Imposta l’intensità da 0 a 5 per ogni genere.</p>
          <div class="premium-genres" id="premiumGenreSliders"></div>
          <button class="btn btn-primary" id="stepGeneriNextBtn" style="margin-top:10px;width:100%;">Procedi</button>
        </div>

        <div class="step hidden" id="stepPiattaforme">
          <h3>Piattaforme streaming</h3>
          <p class="small">Seleziona dove vuoi guardare. Puoi scegliere anche “Tutte”.</p>
          <div class="platform-grid" id="premiumPlatformGrid">
            <div class="platform-pill" data-provider="all">
              <span>Tutte</span>
              <span class="small">Consigliati ovunque</span>
            </div>
            <div class="platform-pill" data-provider="netflix">
              <span>Netflix</span>
            </div>
            <div class="platform-pill" data-provider="prime">
              <span>Prime Video</span>
            </div>
            <div class="platform-pill" data-provider="disney">
              <span>Disney+</span>
            </div>
            <div class="platform-pill" data-provider="apple">
              <span>Apple TV</span>
            </div>
            <div class="platform-pill" data-provider="now">
              <span>NOW</span>
            </div>
          </div>
          <button class="btn btn-primary" id="stepPiattaformeSearchBtn" style="margin-top:10px;width:100%;">Cerca contenuti</button>
        </div>

        <div class="step hidden" id="stepRisultatiPremium">
          <h3>Risultati</h3>
          <p class="small">Ricerca illimitata con dettagli completi.</p>
          <div class="results" id="premiumResultsBox"></div>
          <button class="btn btn-secondary" id="premiumNewSearchBtn" style="margin-top:8px;width:100%;">Nuova ricerca</button>
        </div>
      </div>

      <!-- TAB SERIE: reindirizza a flusso FILM/Serie -->
      <div id="tab-serie" class="premium-tab hidden">
        <p class="small">La ricerca serie TV usa lo stesso flusso di preferenze. Seleziona “Serie TV” nella prima schermata del flusso.</p>
      </div>

      <!-- TAB TRENDING -->
      <div id="tab-trending" class="premium-tab hidden">
        <h3>Titoli in tendenza</h3>
        <p class="small">I contenuti più visti della settimana su TMDB.</p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn btn-secondary" id="trendingFilmBtn">Trending Film</button>
          <button class="btn btn-secondary" id="trendingTvBtn">Trending Serie</button>
        </div>
        <div class="results" id="trendingResultsBox" style="margin-top:10px;"></div>
      </div>

      <!-- TAB WATCHLIST -->
      <div id="tab-watchlist" class="premium-tab hidden">
        <h3>Watchlist</h3>
        <p class="small">Titoli salvati da rivedere con calma.</p>
        <div class="simple-list" id="watchlistBox"></div>
      </div>

      <!-- TAB SOCIAL -->
      <div id="tab-social" class="premium-tab hidden">
        <h3>Social</h3>
        <p class="small">Condividi il titolo che stai per guardare.</p>
        <button class="btn btn-primary share-btn" id="shareBtn" style="margin-top:10px;">Condividi contenuto</button>
        <div class="message" id="shareMsg" style="margin-top:6px;"></div>
      </div>

      <!-- TAB ULTIMI VISTI -->
      <div id="tab-recenti" class="premium-tab hidden">
        <h3>Ultimi visti</h3>
        <p class="small">Cronologia locale degli ultimi contenuti aperti.</p>
        <div class="simple-list" id="recentBox"></div>
      </div>

    </div>
  </div>

</div>

<!-- OVERLAY USCITA -->
<div id="exitOverlay">
  <h2>Sta iniziando il film…</h2>
  <p class="small">Puoi chiudere l’app dal tuo dispositivo.</p>
</div>

<!-- BANNER INSTALL PWA -->
<div id="installBanner">
  <div id="installBannerText">Installa Movie Finder sul tuo dispositivo per un accesso rapido.</div>
  <button class="btn btn-primary" id="installBtn" style="padding:8px 12px;font-size:12px;">Installa</button>
</div>

<script>
// =======================
// CONFIG TMDB E PWA
// =======================

// IMPORTANTE: Sostituisci con un endpoint backend che protegga la chiave TMDB.
// Questo file non mostra alcuna API key all'utente.
const API_BASE = "/tmdb-proxy"; // es. endpoint backend che inoltra le richieste a TMDB con chiave protetta.[web:28]

// provider_id TMDB per Italia (esempi comuni).[web:21][web:24][web:29]
const WATCH_PROVIDERS = {
  netflix: 8,
  prime: 119,
  disney: 337,
  apple: 2,
  now: 326 // NOW Italia (Sky / Now)
};

const REGION = "IT";
const LANGUAGE = "it-IT";

// =======================
// ELEMENTI BASE
// =======================
const splashScreen = document.getElementById("splashScreen");
const homeCard = document.getElementById("homeCard");
const basicFiltersCard = document.getElementById("basicFiltersCard");
const basicResultsCard = document.getElementById("basicResultsCard");
const premiumLoginCard = document.getElementById("premiumLoginCard");
const premiumMainCard = document.getElementById("premiumMainCard");
const exitOverlay = document.getElementById("exitOverlay");

const basicModeBtn = document.getElementById("basicModeBtn");
const premiumModeBtn = document.getElementById("premiumModeBtn");
const backToHomeFromBasic = document.getElementById("backToHomeFromBasic");
const backToHomeFromPremium = document.getElementById("backToHomeFromPremium");

// BASIC
const basicSearchBtn = document.getElementById("basicSearchBtn");
const basicSearchAgainBtn = document.getElementById("basicSearchAgainBtn");
const basicCloseBtn = document.getElementById("basicCloseBtn");
const basicResultsBox = document.getElementById("basicResultsBox");
const basicErrorMsg = document.getElementById("basicErrorMsg");

// PREMIUM LOGIN
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginBtn = document.getElementById("loginBtn");
const loginErrorMsg = document.getElementById("loginErrorMsg");
const premiumLogoutBtn = document.getElementById("premiumLogoutBtn");

// PREMIUM MENU
const premiumTabs = document.getElementById("premiumTabs");
const premiumGenreSliders = document.getElementById("premiumGenreSliders");
const premiumPlatformGrid = document.getElementById("premiumPlatformGrid");
const premiumResultsBox = document.getElementById("premiumResultsBox");
const watchlistBox = document.getElementById("watchlistBox");
const recentBox = document.getElementById("recentBox");
const trendingResultsBox = document.getElementById("trendingResultsBox");
const shareBtn = document.getElementById("shareBtn");
const shareMsg = document.getElementById("shareMsg");

// PREMIUM STEPS
const stepTipoContenuto = document.getElementById("stepTipoContenuto");
const stepGeneri = document.getElementById("stepGeneri");
const stepPiattaforme = document.getElementById("stepPiattaforme");
const stepRisultatiPremium = document.getElementById("stepRisultatiPremium");

const premiumFilmBtn = document.getElementById("premiumFilmBtn");
const premiumSerieBtn = document.getElementById("premiumSerieBtn");
const stepGeneriNextBtn = document.getElementById("stepGeneriNextBtn");
const stepPiattaformeSearchBtn = document.getElementById("stepPiattaformeSearchBtn");
const premiumNewSearchBtn = document.getElementById("premiumNewSearchBtn");

// TRENDING
const trendingFilmBtn = document.getElementById("trendingFilmBtn");
const trendingTvBtn = document.getElementById("trendingTvBtn");

// INSTALL BANNER
const installBanner = document.getElementById("installBanner");
const installBtn = document.getElementById("installBtn");
let deferredPrompt = null;

// =======================
// SPLASH SCREEN
// =======================
setTimeout(()=>{
  splashScreen.classList.add("fade-out");
  setTimeout(()=>{ splashScreen.style.display="none"; },600);
},2000);

// =======================
// NAVIGAZIONE VIEW
// =======================
function showCard(card){
  [homeCard,basicFiltersCard,basicResultsCard,premiumLoginCard,premiumMainCard].forEach(c=>{
    c.classList.add("hidden");
  });
  card.classList.remove("hidden");
}

basicModeBtn.addEventListener("click",()=>{
  showCard(basicFiltersCard);
});

premiumModeBtn.addEventListener("click",()=>{
  showCard(premiumLoginCard);
});

backToHomeFromBasic.addEventListener("click",()=>{
  showCard(homeCard);
});

backToHomeFromPremium.addEventListener("click",()=>{
  showCard(homeCard);
});

// =======================
// BASIC MODE LOGICA
// =======================
const BASIC_SEARCH_KEY = "movieFinder_basic_search_date";

function canDoBasicSearchToday(){
  const today = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem(BASIC_SEARCH_KEY);
  return last !== today;
}

function markBasicSearchDone(){
  const today = new Date().toISOString().slice(0,10);
  localStorage.setItem(BASIC_SEARCH_KEY,today);
}

basicSearchBtn.addEventListener("click", async ()=>{
  basicErrorMsg.classList.add("hidden");
  basicErrorMsg.textContent="";

  if(!canDoBasicSearchToday()){
    basicErrorMsg.textContent="Hai già effettuato una ricerca oggi. Riprova domani.";
    basicErrorMsg.classList.remove("hidden");
    return;
  }

  const checked = Array.from(document.querySelectorAll("#basicGenres input:checked")).map(c=>c.value);
  if(!checked.length){
    basicErrorMsg.textContent="Seleziona almeno un genere.";
    basicErrorMsg.classList.remove("hidden");
    return;
  }

  // Regola AND: con discover, la combinazione è di base AND per i generi specificati.[web:32][web:38]
  const genreParam = checked.join(",");
  basicResultsBox.innerHTML = "<div class='message'>Carico i film per te…</div>";
  showCard(basicResultsCard);

  try{
    const url = `${API_BASE}/discover/movie?language=${encodeURIComponent(LANGUAGE)}&region=${encodeURIComponent(REGION)}&sort_by=popularity.desc&include_adult=false&with_genres=${encodeURIComponent(genreParam)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Errore rete");
    const data = await res.json();

    const results = (data.results || []).slice(0,3);
    if(!results.length){
      basicResultsBox.innerHTML = "<div class='message'>Nessun risultato trovato con questi generi.</div>";
      return;
    }

    markBasicSearchDone();
    basicResultsBox.innerHTML = "";
    for(const m of results){
      const platforms = await loadWatchProviders(m.id,"movie");
      const card = createBasicResultCard(m,platforms);
      basicResultsBox.appendChild(card);
    }
  }catch(e){
    basicResultsBox.innerHTML = "<div class='message error'>Errore nel caricamento dei contenuti.</div>";
  }
});

basicSearchAgainBtn.addEventListener("click",()=>{
  showCard(basicFiltersCard);
});

basicCloseBtn.addEventListener("click",()=>{
  exitOverlay.classList.add("show");
});

// =======================
// BASIC: HELPERS
// =======================
function createBasicResultCard(movie,platforms){
  const div = document.createElement("div");
  div.className = "result";

  const imgUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : "";
  const overview = (movie.overview || "").trim();

  div.innerHTML = `
    <div class="poster">
      ${imgUrl ? `<img src="${imgUrl}" alt="">` : ""}
    </div>
    <div>
      <div class="result-title">${movie.title || movie.name || "Titolo non disponibile"}</div>
      <div class="result-overview">${overview}</div>
      <div class="platforms"></div>
    </div>
  `;

  const platformsBox = div.querySelector(".platforms");
  if(platforms && platforms.length){
    platforms.forEach(p=>{
      const tag = document.createElement("div");
      tag.className = "platform-tag";
      const dot = document.createElement("span");
      dot.className = "platform-dot platform-"+p.key;
      tag.appendChild(dot);
      const label = document.createElement("span");
      label.textContent = p.label;
      tag.appendChild(label);
      platformsBox.appendChild(tag);
    });
  }else{
    const tag = document.createElement("div");
    tag.className = "platform-tag";
    const label = document.createElement("span");
    label.textContent = "Piattaforme non disponibili";
    tag.appendChild(label);
    platformsBox.appendChild(tag);
  }

  return div;
}

// =======================
// WATCH PROVIDERS TMDB
// =======================
async function loadWatchProviders(id,type){
  try{
    const url = `${API_BASE}/${type}/${id}/watch/providers`;
    const res = await fetch(url);
    if(!res.ok) return [];
    const data = await res.json();
    const results = data.results || {};
    const it = results[REGION] || {};
    const flatrate = it.flatrate || [];
    const ids = new Set(flatrate.map(p=>p.provider_id));

    const platforms = [];
    if(ids.has(WATCH_PROVIDERS.netflix)) platforms.push({key:"netflix",label:"Netflix"});
    if(ids.has(WATCH_PROVIDERS.prime)) platforms.push({key:"prime",label:"Prime Video"});
    if(ids.has(WATCH_PROVIDERS.disney)) platforms.push({key:"disney",label:"Disney+"});
    if(ids.has(WATCH_PROVIDERS.apple)) platforms.push({key:"apple",label:"Apple TV"});
    if(ids.has(WATCH_PROVIDERS.now)) platforms.push({key:"now",label:"NOW"});

    return platforms;
  }catch(e){
    return [];
  }
}

// =======================
// PREMIUM LOGIN
// =======================
function isPremiumLogged(){
  return localStorage.getItem("movieFinder_premium_logged")==="1";
}

function setPremiumLogged(v){
  if(v){
    localStorage.setItem("movieFinder_premium_logged","1");
  }else{
    localStorage.removeItem("movieFinder_premium_logged");
  }
}

if(isPremiumLogged()){
  showCard(premiumMainCard);
}else{
  // resta su home
}

loginBtn.addEventListener("click",()=>{
  loginErrorMsg.classList.add("hidden");
  loginErrorMsg.textContent = "";

  const email = (loginEmail.value || "").trim();
  const pwd = (loginPassword.value || "").trim();

  if(email==="maprexx@gmail.com" && pwd==="1234"){
    setPremiumLogged(true);
    resetPremiumFlow();
    showCard(premiumMainCard);
  }else{
    loginErrorMsg.textContent = "Credenziali non valide per l’area PREMIUM.";
    loginErrorMsg.classList.remove("hidden");
  }
});

premiumLogoutBtn.addEventListener("click",()=>{
  setPremiumLogged(false);
  resetPremiumFlow();
  showCard(homeCard);
});

// =======================
// PREMIUM: MENU TABS
// =======================
premiumTabs.addEventListener("click",(e)=>{
  const btn = e.target.closest(".tab");
  if(!btn) return;
  const tab = btn.dataset.tab;
  if(!tab) return;

  Array.from(premiumTabs.querySelectorAll(".tab")).forEach(t=>t.classList.remove("active"));
  btn.classList.add("active");

  const all = document.querySelectorAll(".premium-tab");
  all.forEach(c=>c.classList.add("hidden"));
  document.getElementById("tab-"+tab).classList.remove("hidden");

  if(tab==="watchlist") renderWatchlist();
  if(tab==="recenti") renderRecent();
});

// =======================
// PREMIUM: FLOW FILM/SERIE
// =======================
let premiumCurrentType = "movie"; // "movie" o "tv"

const PREMIUM_GENRES = [
  {id:28,name:"Azione"},
  {id:12,name:"Avventura"},
  {id:35,name:"Commedia"},
  {id:18,name:"Dramma"},
  {id:10749,name:"Romantico"},
  {id:27,name:"Horror"},
  {id:16,name:"Animazione"},
  {id:878,name:"Fantascienza"},
  {id:53,name:"Thriller"},
  {id:10751,name:"Famiglia"}
]; // massimo 10

function buildGenreSliders(){
  premiumGenreSliders.innerHTML = "";
  PREMIUM_GENRES.forEach(g=>{
    const row = document.createElement("div");
    row.className = "slider-row";
    row.dataset.genreId = g.id;
    row.innerHTML = `
      <div class="slider-row-header">
        <span>${g.name}</span>
        <span class="small">0</span>
      </div>
      <input type="range" min="0" max="5" value="0">
    `;
    const slider = row.querySelector("input");
    const labelValue = row.querySelector(".slider-row-header span.small");
    slider.addEventListener("input",()=>{
      labelValue.textContent = slider.value;
    });
    premiumGenreSliders.appendChild(row);
  });
}

buildGenreSliders();

function resetPremiumFlow(){
  premiumCurrentType = "movie";
  stepTipoContenuto.classList.remove("hidden");
  stepGeneri.classList.add("hidden");
  stepPiattaforme.classList.add("hidden");
  stepRisultatiPremium.classList.add("hidden");
  premiumResultsBox.innerHTML = "";
  premiumPlatformGrid.querySelectorAll(".platform-pill").forEach(p=>p.classList.remove("selected"));
}

// scelta tipo
premiumFilmBtn.addEventListener("click",()=>{
  premiumCurrentType = "movie";
  stepTipoContenuto.classList.add("hidden");
  stepGeneri.classList.remove("hidden");
});

premiumSerieBtn.addEventListener("click",()=>{
  premiumCurrentType = "tv";
  stepTipoContenuto.classList.add("hidden");
  stepGeneri.classList.remove("hidden");
});

// procedi generi
stepGeneriNextBtn.addEventListener("click",()=>{
  stepGeneri.classList.add("hidden");
  stepPiattaforme.classList.remove("hidden");
});

// selezione piattaforme
premiumPlatformGrid.addEventListener("click",(e)=>{
  const pill = e.target.closest(".platform-pill");
  if(!pill) return;
  const key = pill.dataset.provider;
  if(key==="all"){
    // toggle tutte
    const selected = pill.classList.toggle("selected");
    premiumPlatformGrid.querySelectorAll(".platform-pill").forEach(p=>{
      if(p!==pill) p.classList.remove("selected");
    });
  }else{
    pill.classList.toggle("selected");
    const allPill = premiumPlatformGrid.querySelector('[data-provider="all"]');
    if(allPill) allPill.classList.remove("selected");
  }
});

// ricerca premium
stepPiattaformeSearchBtn.addEventListener("click", async ()=>{
  premiumResultsBox.innerHTML = "<div class='message'>Sto cercando contenuti per te…</div>";
  stepRisultatiPremium.classList.remove("hidden");

  // calcolo generi con peso >0
  const rows = Array.from(premiumGenreSliders.querySelectorAll(".slider-row"));
  const preferredGenres = rows
    .map(row=>{
      const id = row.dataset.genreId;
      const val = parseInt(row.querySelector("input").value,10);
      return {id,val};
    })
    .filter(g=>g.val>0)
    .sort((a,b)=>b.val-a.val);

  // prendo i primi generi con peso maggiore per costruire la query
  const genreIds = preferredGenres.map(g=>g.id).join(",");

  // piattaforme selezionate
  const selected = Array.from(premiumPlatformGrid.querySelectorAll(".platform-pill.selected"));
  let withProviders = "";
  if(selected.length){
    if(selected.some(p=>p.dataset.provider==="all")){
      withProviders = ""; // tutte
    }else{
      const ids = [];
      selected.forEach(p=>{
        const k = p.dataset.provider;
        if(WATCH_PROVIDERS[k]) ids.push(WATCH_PROVIDERS[k]);
      });
      if(ids.length){
        withProviders = ids.join("|");
      }
    }
  }

  try{
    let url;
    if(premiumCurrentType==="movie"){
      url = `${API_BASE}/discover/movie?language=${encodeURIComponent(LANGUAGE)}&region=${encodeURIComponent(REGION)}&sort_by=popularity.desc&include_adult=true`;
      if(genreIds) url += `&with_genres=${encodeURIComponent(genreIds)}`;
      if(withProviders) url += `&with_watch_providers=${encodeURIComponent(withProviders)}&watch_region=${encodeURIComponent(REGION)}&with_watch_monetization_types=flatrate`;[web:29][web:32][web:38]
    }else{
      url = `${API_BASE}/discover/tv?language=${encodeURIComponent(LANGUAGE)}&region=${encodeURIComponent(REGION)}&sort_by=popularity.desc&include_adult=true`;
      if(genreIds) url += `&with_genres=${encodeURIComponent(genreIds)}`;
      if(withProviders) url += `&with_watch_providers=${encodeURIComponent(withProviders)}&watch_region=${encodeURIComponent(REGION)}&with_watch_monetization_types=flatrate`;[web:29][web:35][web:38]
    }

    const res = await fetch(url);
    if(!res.ok) throw new Error("Errore rete");
    const data = await res.json();
    const results = (data.results || []).slice(0,5);

    if(!results.length){
      premiumResultsBox.innerHTML = "<div class='message'>Nessun contenuto trovato con queste preferenze.</div>";
      return;
    }

    premiumResultsBox.innerHTML = "";
    for(const item of results){
      const platforms = await loadWatchProviders(item.id,premiumCurrentType==="movie"?"movie":"tv");
      const node = createPremiumResultCard(item,platforms,premiumCurrentType);
      premiumResultsBox.appendChild(node);
    }
  }catch(e){
    premiumResultsBox.innerHTML = "<div class='message error'>Errore nel caricamento dei contenuti.</div>";
  }
});

premiumNewSearchBtn.addEventListener("click",()=>{
  resetPremiumFlow();
});

// =======================
// PREMIUM: CARD RISULTATI
// =======================
function addToWatchlist(item,type){
  const key = "movieFinder_watchlist";
  const current = JSON.parse(localStorage.getItem(key) || "[]");
  const exists = current.some(c=>c.id===item.id && c.type===type);
  if(!exists){
    current.push({id:item.id,type,title:item.title||item.name||"",poster:item.poster_path||""});
    localStorage.setItem(key,JSON.stringify(current));
  }
  renderWatchlist();
}

function addToRecent(item,type){
  const key = "movieFinder_recent";
  let current = JSON.parse(localStorage.getItem(key) || "[]");
  current = current.filter(c=>!(c.id===item.id && c.type===type));
  current.unshift({id:item.id,type,title:item.title||item.name||"",poster:item.poster_path||""});
  if(current.length>20) current = current.slice(0,20);
  localStorage.setItem(key,JSON.stringify(current));
}

function createPremiumResultCard(item,platforms,type){
  const div = document.createElement("div");
  div.className = "premium-result";

  const imgUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : "";
  const overview = (item.overview || "").trim();
  const title = item.title || item.name || "Titolo non disponibile";
  const dateField = type==="movie" ? item.release_date : item.first_air_date;
  const year = dateField ? String(dateField).slice(0,4) : "N/D";
  const vote = typeof item.vote_average==="number" ? item.vote_average.toFixed(1) : "N/D";
  const popularity = item.popularity!=null ? Math.round(item.popularity) : "N/D";

  div.innerHTML = `
    <div class="premium-poster">
      ${imgUrl ? `<img src="${imgUrl}" alt="">` : ""}
    </div>
    <div>
      <div class="premium-title">${title}</div>
      <div class="premium-overview">${overview}</div>
      <div class="stats">
        <div class="stat-pill">Voto TMDB: ${vote}</div>
        <div class="stat-pill">Anno: ${year}</div>
        <div class="stat-pill">Popolarità: ${popularity}</div>
      </div>
      <div class="platforms"></div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button class="btn btn-secondary" style="flex:1;">Aggiungi a Watchlist</button>
        <button class="btn btn-secondary" style="flex:1;">Segna come visto</button>
      </div>
    </div>
  `;

  const platformsBox = div.querySelector(".platforms");
  if(platforms && platforms.length){
    platforms.forEach(p=>{
      const tag = document.createElement("div");
      tag.className = "platform-tag";
      const dot = document.createElement("span");
      dot.className = "platform-dot platform-"+p.key;
      tag.appendChild(dot);
      const label = document.createElement("span");
      label.textContent = p.label;
      tag.appendChild(label);
      platformsBox.appendChild(tag);
    });
  }

  const [watchBtn, seenBtn] = div.querySelectorAll("button");
  watchBtn.addEventListener("click",()=>{
    addToWatchlist(item,type);
  });
  seenBtn.addEventListener("click",()=>{
    addToRecent(item,type);
  });

  // clic ovunque per registrare come "aperto"
  div.addEventListener("click",()=>{
    addToRecent(item,type);
  });

  return div;
}

// =======================
// WATCHLIST / RECENTI
// =======================
function renderWatchlist(){
  const key = "movieFinder_watchlist";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  watchlistBox.innerHTML = "";
  if(!list.length){
    watchlistBox.innerHTML = "<div class='message'>Nessun titolo in watchlist.</div>";
    return;
  }

  list.forEach(item=>{
    const div = document.createElement("div");
    div.className = "simple-item";
    div.innerHTML = `
      <span>${item.title || "Titolo non disponibile"}</span>
      <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;">Rimuovi</button>
    `;
    const btn = div.querySelector("button");
    btn.addEventListener("click",()=>{
      const current = JSON.parse(localStorage.getItem(key) || "[]");
      const next = current.filter(c=>!(c.id===item.id && c.type===item.type));
      localStorage.setItem(key,JSON.stringify(next));
      renderWatchlist();
    });
    watchlistBox.appendChild(div);
  });
}

function renderRecent(){
  const key = "movieFinder_recent";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  recentBox.innerHTML = "";
  if(!list.length){
    recentBox.innerHTML = "<div class='message'>Nessun contenuto visto di recente.</div>";
    return;
  }

  list.forEach(item=>{
    const div = document.createElement("div");
    div.className = "simple-item";
    div.innerHTML = `
      <span>${item.title || "Titolo non disponibile"}</span>
      <span class="small">${item.type==="movie"?"Film":"Serie"}</span>
    `;
    recentBox.appendChild(div);
  });
}

// =======================
// TRENDING
// =======================
async function loadTrending(type){
  trendingResultsBox.innerHTML = "<div class='message'>Carico i contenuti in tendenza…</div>";
  try{
    const url = `${API_BASE}/trending/${type}/week?language=${encodeURIComponent(LANGUAGE)}`;[web:30][web:36][web:39]
    const res = await fetch(url);
    if(!res.ok) throw new Error("Errore rete");
    const data = await res.json();
    const list = (data.results || []).slice(0,5);

    trendingResultsBox.innerHTML = "";
    if(!list.length){
      trendingResultsBox.innerHTML = "<div class='message'>Nessun contenuto in tendenza disponibile.</div>";
      return;
    }

    list.forEach(item=>{
      const div = document.createElement("div");
      div.className = "result";
      const imgUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : "";
      const title = item.title || item.name || "Titolo non disponibile";
      const overview = (item.overview || "").trim();
      div.innerHTML = `
        <div class="poster">
          ${imgUrl ? `<img src="${imgUrl}" alt="">` : ""}
        </div>
        <div>
          <div class="result-title">${title}</div>
          <div class="result-overview">${overview}</div>
        </div>
      `;
      trendingResultsBox.appendChild(div);
    });
  }catch(e){
    trendingResultsBox.innerHTML = "<div class='message error'>Errore nel caricamento dei contenuti in tendenza.</div>";
  }
}

trendingFilmBtn.addEventListener("click",()=>loadTrending("movie"));
trendingTvBtn.addEventListener("click",()=>loadTrending("tv"));

// =======================
// SOCIAL SHARE
// =======================
shareBtn.addEventListener("click",async ()=>{
  shareMsg.textContent = "";
  const key = "movieFinder_recent";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  if(!list.length){
    shareMsg.textContent = "Apri prima un contenuto per poterlo condividere.";
    return;
  }
  const last = list[0];
  const text = `Sto per guardare "${last.title}" su Movie Finder!`;

  if(navigator.share){
    try{
      await navigator.share({title:"Movie Finder",text});
      shareMsg.textContent = "Condivisione completata.";
    }catch(e){
      shareMsg.textContent = "Condivisione annullata.";
    }
  }else{
    shareMsg.textContent = "Condivisione non supportata su questo dispositivo.";
  }
});

// =======================
// PWA INSTALL
// =======================
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt = e;
  installBanner.classList.add("show");
});

installBtn.addEventListener("click",async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBanner.classList.remove("show");
});

// registrazione service worker di base
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
