<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Finder</title>
  <style>
    :root{
      --bg:#050607;
      --panel:#0c0f10;
      --panel2:#0a0c0d;
      --text:#e9eef2;
      --muted:#9aa6b2;
      --line:#1d2427;

      --acidY:#e6ff00;
      --acidG:#00ff7a;

      --danger:#ff3b30;
      --ok:#00ff7a;

      --r:18px;
      --pad:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, #0e1416 0%, var(--bg) 55%);
      color:var(--text);
    }

    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      position:sticky;top:0;background:rgba(5,6,7,.86);backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);z-index:50;padding:12px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(145deg, var(--acidY), #9cff00);
      box-shadow: 0 10px 24px rgba(230,255,0,.15);
    }
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:1px}

    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, #11181b 0%, #0b0f11 100%);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;box-shadow: var(--shadow);
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(230,255,0,.35);
      background: linear-gradient(180deg, rgba(230,255,0,.18) 0%, rgba(230,255,0,.06) 100%);
    }
    .btn.green{
      border-color: rgba(0,255,122,.35);
      background: linear-gradient(180deg, rgba(0,255,122,.18) 0%, rgba(0,255,122,.06) 100%);
    }
    .btn.danger{
      border-color: rgba(255,59,48,.35);
      background: linear-gradient(180deg, rgba(255,59,48,.18) 0%, rgba(255,59,48,.06) 100%);
    }
    .btn.ghost{
      box-shadow:none;background:transparent;border-color: var(--line);
    }
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .btn:disabled{
      opacity:.45;cursor:not-allowed;box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      padding:18px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,122,.35);
      box-shadow: 0 0 0 4px rgba(0,255,122,.08);
    }
    .pill .dot{
      width:9px;height:9px;border-radius:99px;background:#3a464d;
    }
    .pill.on .dot{background: var(--acidG)}
    .pill.yellow.on{
      border-color: rgba(230,255,0,.35);
      box-shadow: 0 0 0 4px rgba(230,255,0,.08);
    }
    .pill.yellow.on .dot{background: var(--acidY)}

    .badge{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:5px 8px;border-radius:999px;
      background:rgba(255,255,255,.02);
    }

    .results{display:grid;grid-template-columns:1fr;gap:12px}
    .result{
      display:grid;grid-template-columns: 92px 1fr;gap:12px;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background: rgba(0,0,0,.22);
    }
    .poster{
      width:92px;height:138px;border-radius:14px;
      background: linear-gradient(180deg, rgba(230,255,0,.12) 0%, rgba(0,255,122,.08) 100%);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .rtitle{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .rtitle h3{margin:0;font-size:15px;line-height:1.25}
    .rmeta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .rmeta .badge{font-size:11px}
    .rov{margin:8px 0 10px 0;color:#cdd6de;font-size:13px;line-height:1.35}
    .providers{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .prov{
      display:flex;align-items:center;gap:8px;
      padding:6px 8px;border:1px solid var(--line);
      border-radius:999px;background:rgba(255,255,255,.02);
      font-size:12px;color:#dbe4ec;
    }
    .prov img{width:18px;height:18px;border-radius:4px}
    .prov .muted{font-size:11px}

    .section{display:none}
    .section.on{display:block}

    .splash{
      min-height: calc(100vh - 62px);
      display:grid;place-items:center;padding:18px;
    }
    .splash .box{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      padding:20px;
      background: radial-gradient(700px 300px at 40% 0%, rgba(230,255,0,.10) 0%, rgba(0,255,122,.06) 45%, rgba(0,0,0,.0) 70%);
      box-shadow: var(--shadow);
      text-align:center;
      animation: fadeIn .55s ease forwards;
    }
    .bigLogo{
      width:74px;height:74px;border-radius:22px;margin:0 auto 12px auto;
      background: linear-gradient(145deg, var(--acidY), #9cff00);
      box-shadow: 0 18px 40px rgba(230,255,0,.12);
    }
    .splash h2{margin:0 0 6px 0}
    .splash p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    @keyframes fadeIn{
      from{opacity:0;transform: translateY(10px)}
      to{opacity:1;transform: translateY(0)}
    }

    .modalBack{
      position:fixed;inset:0;background: rgba(0,0,0,.62);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:99;
    }
    .modalBack.on{display:flex}
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:0;color:var(--muted);line-height:1.35}

    .sliderRow{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;align-items:center;
      padding:10px;border:1px solid var(--line);border-radius:16px;
      background: rgba(0,0,0,.18);
      margin:8px 0;
    }
    input[type="range"]{width:100%}

    .flicker{
      min-height: calc(100vh - 62px);
      display:grid;place-items:center;text-align:center;padding:18px;
      background: radial-gradient(800px 340px at 50% 30%, rgba(255,255,255,.05) 0%, rgba(0,0,0,.0) 70%);
    }
    .flicker .text{
      font-size:20px;letter-spacing:.3px;line-height:1.35;
      padding:18px;border-radius:18px;border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.35);
      text-shadow: 0 0 10px rgba(255,255,255,.10);
      animation: proj 1.2s infinite;
    }
    @keyframes proj{
      0%{opacity:1;transform: translateX(0)}
      12%{opacity:.92;transform: translateX(-.5px)}
      24%{opacity:1;transform: translateX(.6px)}
      38%{opacity:.88;transform: translateX(-.2px)}
      55%{opacity:1;transform: translateX(.4px)}
      70%{opacity:.93;transform: translateX(-.4px)}
      100%{opacity:1;transform: translateX(0)}
    }

    .hint{
      font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px;
    }

    .copyHint{
      display:none;
      margin-left:10px;color:var(--muted);font-size:12px;
    }
    .copyHint.on{display:inline}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Movie Finder</h1>
        <small>TMDB, consigli rapidi e piattaforme in IT</small>
      </div>
    </div>

    <div class="row">
      <button class="btn small ghost" id="btnHome">Home</button>
      <button class="btn small primary" id="btnCopy">Copia index.html</button>
      <span class="copyHint" id="copyHint">Copiato</span>
    </div>
  </div>

  <main class="wrap">

    <!-- SPLASH -->
    <section class="section on" id="secSplash">
      <div class="splash">
        <div class="box">
          <div class="bigLogo" aria-hidden="true"></div>
          <h2>Movie Finder</h2>
          <p>Trova cosa guardare in pochi tocchi. Poster, trama, statistiche, piattaforme.</p>
          <div class="sep"></div>
          <div class="row" style="justify-content:center">
            <button class="btn primary" id="btnGoProfiles">Inizia</button>
          </div>
          <div class="hint">Suggerimento. In Basic hai una sola scelta al giorno. In Premium hai ricerche illimitate, slider e Serie TV.</div>
        </div>
      </div>
    </section>

    <!-- PROFILI -->
    <section class="section" id="secProfiles">
      <div class="grid">
        <div class="card">
          <h2>Scegli il profilo</h2>
          <p class="muted">Seleziona Basic o Premium. Puoi cambiare quando vuoi.</p>
          <div class="sep"></div>

          <div class="card" style="background:rgba(0,0,0,.22)">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:650">Basic</div>
                <div class="muted" style="font-size:13px;margin-top:2px">3 film consigliati al giorno. Zero distrazioni.</div>
              </div>
              <button class="btn green" id="btnBasic">Entra in Basic</button>
            </div>
            <div class="sep"></div>
            <div class="muted" style="font-size:13px;line-height:1.4">
              Solo film. Serie TV non selezionabile.<br/>
              Una ricerca al giorno. 3 risultati.<br/>
              Generi: Azione, Comico, Thriller, Animazione.
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="background:rgba(0,0,0,.22)">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:650">Premium</div>
                <div class="muted" style="font-size:13px;margin-top:2px">Suggerimenti avanzati. Film e serie su misura.</div>
              </div>
              <button class="btn primary" id="btnPremium">Entra in Premium</button>
            </div>
            <div class="sep"></div>
            <div class="muted" style="font-size:13px;line-height:1.4">
              Film e Serie TV sbloccate.<br/>
              Ricerche illimitate. 5 risultati.<br/>
              Slider intensità 0 a 5 per i generi.<br/>
              Piattaforme complete: gratis, noleggio, acquisto.
            </div>
          </div>

          <div class="sep"></div>
          <div class="muted" style="font-size:12px;line-height:1.35">
            Nota tecnica. Questo index.html è una demo web. Il pagamento Play Store va integrato nell’app Android con Google Play Billing. Qui lo simulo con un tasto.
          </div>
        </div>

        <div class="card">
          <h2>Impostazioni TMDB</h2>
          <p class="muted">Inserisci la tua API key TMDB e la regione.</p>
          <div class="sep"></div>

          <div class="row">
            <span class="badge">watch_region: IT</span>
            <span class="badge">providers: TMDB watch/providers</span>
            <span class="badge">monetization: flatrate, rent, buy</span>
          </div>

          <div class="sep"></div>

          <div class="muted" style="font-size:13px;line-height:1.4">
            1) Trova la riga: const TMDB_API_KEY = "INSERISCI_LA_TUA_KEY"<br/>
            2) Incolla la key.<br/>
            3) Salva e ripubblica.
          </div>

          <div class="sep"></div>
          <button class="btn ghost" id="btnResetLocal">Reset demo</button>
        </div>
      </div>
    </section>

    <!-- BASIC -->
    <section class="section" id="secBasic">
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 style="margin-bottom:4px">Basic</h2>
              <div class="muted" style="font-size:13px">Una scelta al giorno. 3 risultati. Film soltanto.</div>
            </div>
            <span class="badge" id="basicLimitBadge">Controllo limite</span>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn small" id="basicTabFilm">Film</button>
            <button class="btn small" id="basicTabTv" disabled>Serie TV</button>
            <span class="badge">Serie TV bloccate</span>
          </div>

          <div class="sep"></div>

          <h2 style="font-size:14px;margin:0 0 10px 0">Generi</h2>
          <div class="row" id="basicGenres">
            <div class="pill on yellow" data-genre="28"><span class="dot"></span>Azione</div>
            <div class="pill" data-genre="35"><span class="dot"></span>Comico</div>
            <div class="pill" data-genre="53"><span class="dot"></span>Thriller</div>
            <div class="pill" data-genre="16"><span class="dot"></span>Animazione</div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn green" id="btnBasicSearch">Cerca oggi</button>
            <button class="btn ghost" id="btnBasicClear">Azzera selezione</button>
          </div>

          <div class="hint" id="basicHint"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Risultati</h2>
            <span class="badge">3 titoli</span>
          </div>
          <div class="sep"></div>

          <div class="results" id="basicResults"></div>

          <div class="sep"></div>
          <div class="muted" style="font-size:12px;line-height:1.35">
            Ordine suggerito: 1 più disponibile gratis, 2 miglior voto, 3 scelta alternativa.
          </div>
        </div>
      </div>
    </section>

    <!-- PREMIUM -->
    <section class="section" id="secPremium">
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 style="margin-bottom:4px">Premium</h2>
              <div class="muted" style="font-size:13px">Ricerche illimitate. 5 risultati. Film e Serie TV.</div>
            </div>
            <span class="badge" id="premiumStatus">Stato pagamento</span>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn small" id="premTabFilm">Film</button>
            <button class="btn small" id="premTabTv">Serie TV</button>
            <button class="btn small ghost" id="premTabSocial">Social</button>
          </div>

          <div class="sep"></div>

          <div id="premFilmTvBox">
            <h2 style="font-size:14px;margin:0 0 6px 0">Generi con intensità</h2>
            <div class="muted" style="font-size:12px;line-height:1.35">
              Metti 0 se non vuoi quel genere. Metti 5 se lo vuoi molto.
            </div>

            <div class="sep"></div>

            <div class="sliderRow">
              <div>
                <div style="font-weight:650">Azione</div>
                <div class="muted" style="font-size:12px">Più ritmo, più adrenalina</div>
              </div>
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="valAction">3</span>
              </div>
              <div style="grid-column:1 / -1">
                <input type="range" min="0" max="5" value="3" id="slAction" />
              </div>
            </div>

            <div class="sliderRow">
              <div>
                <div style="font-weight:650">Comico</div>
                <div class="muted" style="font-size:12px">Leggero, divertente</div>
              </div>
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="valComedy">2</span>
              </div>
              <div style="grid-column:1 / -1">
                <input type="range" min="0" max="5" value="2" id="slComedy" />
              </div>
            </div>

            <div class="sliderRow">
              <div>
                <div style="font-weight:650">Thriller</div>
                <div class="muted" style="font-size:12px">Tensione, mistero</div>
              </div>
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="valThriller">3</span>
              </div>
              <div style="grid-column:1 / -1">
                <input type="range" min="0" max="5" value="3" id="slThriller" />
              </div>
            </div>

            <div class="sliderRow">
              <div>
                <div style="font-weight:650">Romantico</div>
                <div class="muted" style="font-size:12px">Relazioni, emozioni</div>
              </div>
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="valRomance">1</span>
              </div>
              <div style="grid-column:1 / -1">
                <input type="range" min="0" max="5" value="1" id="slRomance" />
              </div>
            </div>

            <div class="sliderRow">
              <div>
                <div style="font-weight:650">Dramma</div>
                <div class="muted" style="font-size:12px">Storie intense</div>
              </div>
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="valDrama">2</span>
              </div>
              <div style="grid-column:1 / -1">
                <input type="range" min="0" max="5" value="2" id="slDrama" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn primary" id="btnPremSearch">Cerca</button>
              <button class="btn ghost" id="btnPremSurprise">Sorprendimi</button>
            </div>

            <div class="hint" id="premExplain"></div>
          </div>

          <div id="premSocialBox" style="display:none">
            <h2 style="font-size:14px;margin:0 0 8px 0">Social</h2>
            <div class="muted" style="font-size:13px;line-height:1.4">
              Condividi cosa stai guardando. Il link invita a scaricare la app.
            </div>
            <div class="sep"></div>

            <div class="row">
              <button class="btn green" id="btnShareNow">Sto guardando questo</button>
              <button class="btn" id="btnShareRec">Consigliato</button>
              <button class="btn ghost" id="btnCopyLink">Copia link app</button>
            </div>

            <div class="sep"></div>

            <div class="muted" style="font-size:12px;line-height:1.35">
              Nota. In produzione userai un deep link. Qui metto un link demo.
            </div>
          </div>

          <div class="sep"></div>

          <h2 style="font-size:14px;margin:0 0 8px 0">Ultimi visti e Top settimana</h2>
          <div class="row">
            <span class="badge">Ultimi visti</span>
            <span class="badge">Top 5 settimana</span>
          </div>

          <div class="sep"></div>

          <div class="results" id="premHistory"></div>
          <div class="sep"></div>
          <div class="results" id="premTopWeek"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Risultati</h2>
            <span class="badge">5 titoli</span>
          </div>
          <div class="sep"></div>

          <div class="results" id="premResults"></div>

          <div class="sep"></div>
          <div class="muted" style="font-size:12px;line-height:1.35">
            Piattaforme. Mostro gratis, noleggio, acquisto, con logo e nome.
          </div>
        </div>
      </div>
    </section>

    <!-- FINALE CINEMA -->
    <section class="section" id="secFinal">
      <div class="flicker">
        <div>
          <div class="text">Mettiti comodo, lo spettacolo sta per iniziare</div>
          <div class="hint">Se il browser non può chiudere la scheda, chiudila tu.</div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL PAY -->
  <div class="modalBack" id="payModal">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3>Attiva Premium</h3>
          <p>In app userai il pagamento Play Store. Qui lo simulo per la demo.</p>
        </div>
        <button class="btn small ghost" id="btnPayClose">Chiudi</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn primary" id="btnPayNow">Paga con Play Store</button>
        <button class="btn ghost" id="btnPayLater">Non ora</button>
      </div>
      <div class="hint">Dopo il pagamento sblocco Film e Serie TV, slider, ricerche illimitate, social, top settimana.</div>
    </div>
  </div>

  <!-- MODAL BASIC LIMIT -->
  <div class="modalBack" id="limitModal">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3>Hai già usato la scelta di oggi</h3>
          <p>In Basic puoi fare una sola ricerca al giorno.</p>
        </div>
        <button class="btn small ghost" id="btnLimitClose">Chiudi</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn ghost" id="btnComeBack">Torna domani</button>
        <button class="btn primary" id="btnUpgrade">Passa a Premium</button>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /* ===========================
       CONFIG TMDB
       =========================== */
    const TMDB_API_KEY = "INSERISCI_LA_TUA_KEY";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const IMG = "https://image.tmdb.org/t/p/w342";
    const LOGO = "https://image.tmdb.org/t/p/w45";
    const REGION = "IT";
    const APP_DEEPLINK = "https://example.com/movie-finder"; // qui metterai lo store link

    /* Generi TMDB */
    const G = {
      action: 28,
      comedy: 35,
      thriller: 53,
      animation: 16,
      romance: 10749,
      drama: 18
    };

    /* ===========================
       STATE E STORAGE
       =========================== */
    const S = {
      profile: localStorage.getItem("mf_profile") || "none",
      premium: localStorage.getItem("mf_premium") === "true",
      basicLastDate: localStorage.getItem("mf_basic_last_date") || "",
      premTab: "film",
      premType: "movie" // "movie" o "tv"
    };

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function setProfile(p){
      S.profile = p;
      localStorage.setItem("mf_profile", p);
    }

    function setPremium(on){
      S.premium = !!on;
      localStorage.setItem("mf_premium", String(!!on));
      updatePremiumStatus();
    }

    /* ===========================
       ROUTER UI
       =========================== */
    const secSplash = byId("secSplash");
    const secProfiles = byId("secProfiles");
    const secBasic = byId("secBasic");
    const secPremium = byId("secPremium");
    const secFinal = byId("secFinal");

    function show(sectionId){
      [secSplash, secProfiles, secBasic, secPremium, secFinal].forEach(x => x.classList.remove("on"));
      byId(sectionId).classList.add("on");
      window.scrollTo({top:0, behavior:"instant"});
    }

    byId("btnHome").addEventListener("click", () => {
      show("secProfiles");
    });

    byId("btnGoProfiles").addEventListener("click", () => {
      fadeToProfiles();
    });

    function fadeToProfiles(){
      show("secSplash");
      setTimeout(() => show("secProfiles"), 420);
    }

    /* ===========================
       COPY BUTTON
       =========================== */
    byId("btnCopy").addEventListener("click", async () => {
      const hint = byId("copyHint");
      try{
        const html = "<!doctype html>\\n" + document.documentElement.outerHTML;
        await navigator.clipboard.writeText(html);
        hint.classList.add("on");
        setTimeout(() => hint.classList.remove("on"), 1200);
      }catch(e){
        alert("Copia non riuscita. Copia questo file dal repository o dal messaggio in chat.");
      }
    });

    /* ===========================
       RESET DEMO
       =========================== */
    byId("btnResetLocal").addEventListener("click", () => {
      localStorage.removeItem("mf_profile");
      localStorage.removeItem("mf_premium");
      localStorage.removeItem("mf_basic_last_date");
      localStorage.removeItem("mf_history");
      localStorage.removeItem("mf_last_shared");
      location.reload();
    });

    /* ===========================
       PROFILI
       =========================== */
    byId("btnBasic").addEventListener("click", () => {
      setProfile("basic");
      show("secBasic");
      refreshBasicLimitUI();
      byId("basicResults").innerHTML = "";
      byId("basicHint").textContent = "";
    });

    byId("btnPremium").addEventListener("click", () => {
      setProfile("premium");
      if(!S.premium){
        openPayModal();
        return;
      }
      show("secPremium");
      loadPremiumPanels();
    });

    /* ===========================
       MODAL PAY
       =========================== */
    const payModal = byId("payModal");
    byId("btnPayClose").addEventListener("click", closePayModal);
    byId("btnPayLater").addEventListener("click", closePayModal);

    byId("btnPayNow").addEventListener("click", () => {
      setPremium(true);
      closePayModal();
      show("secPremium");
      loadPremiumPanels();
    });

    function openPayModal(){ payModal.classList.add("on"); }
    function closePayModal(){ payModal.classList.remove("on"); }

    function updatePremiumStatus(){
      byId("premiumStatus").textContent = S.premium ? "Premium attivo" : "Non attivo";
    }

    /* ===========================
       BASIC: SELEZIONE GENERI
       =========================== */
    const basicGenresBox = byId("basicGenres");
    let basicSelected = new Set([G.action]);

    basicGenresBox.addEventListener("click", (ev) => {
      const el = ev.target.closest(".pill");
      if(!el) return;
      const id = Number(el.getAttribute("data-genre"));
      if(basicSelected.has(id)){
        basicSelected.delete(id);
        el.classList.remove("on","yellow");
      }else{
        basicSelected.add(id);
        el.classList.add("on","yellow");
      }
    });

    byId("btnBasicClear").addEventListener("click", () => {
      basicSelected.clear();
      [...basicGenresBox.querySelectorAll(".pill")].forEach(p => p.classList.remove("on","yellow"));
      byId("basicHint").textContent = "Seleziona almeno un genere.";
    });

    /* Limitazione 1 volta al giorno */
    function basicCanSearch(){
      return (localStorage.getItem("mf_basic_last_date") || "") !== todayKey();
    }

    function refreshBasicLimitUI(){
      const badge = byId("basicLimitBadge");
      if(basicCanSearch()){
        badge.textContent = "Ricerca disponibile oggi";
      }else{
        badge.textContent = "Già usata oggi";
      }
    }

    /* MODAL LIMIT */
    const limitModal = byId("limitModal");
    byId("btnLimitClose").addEventListener("click", () => limitModal.classList.remove("on"));
    byId("btnComeBack").addEventListener("click", () => limitModal.classList.remove("on"));
    byId("btnUpgrade").addEventListener("click", () => {
      limitModal.classList.remove("on");
      setProfile("premium");
      openPayModal();
    });

    byId("btnBasicSearch").addEventListener("click", async () => {
      refreshBasicLimitUI();

      if(!basicCanSearch()){
        limitModal.classList.add("on");
        return;
      }

      if(basicSelected.size === 0){
        byId("basicHint").textContent = "Seleziona almeno un genere.";
        return;
      }

      if(!hasApiKey()){
        byId("basicHint").textContent = "Inserisci la tua TMDB API key nel codice. Cerca TMDB_API_KEY.";
        return;
      }

      byId("basicHint").textContent = "Sto cercando 3 titoli...";
      byId("basicResults").innerHTML = "";

      try{
        const ids = [...basicSelected].join(",");
        const list = await discoverTitles("movie", {
          with_genres: ids,
          sort_by: "popularity.desc",
          include_adult: "false"
        });

        const picked = pickUnique(list, 12, 3);

        const enriched = await Promise.all(picked.map(async (m) => {
          const providers = await getProviders("movie", m.id);
          return { ...m, providers };
        }));

        renderResults(byId("basicResults"), enriched, { mode:"basic", type:"movie" });

        localStorage.setItem("mf_basic_last_date", todayKey());
        refreshBasicLimitUI();
        byId("basicHint").textContent = "Fatto. 3 scelte per oggi.";

      }catch(e){
        byId("basicHint").textContent = "Errore. Controlla API key e rete.";
      }
    });

    /* ===========================
       PREMIUM: TAB E SLIDER
       =========================== */
    updatePremiumStatus();

    const premFilmTvBox = byId("premFilmTvBox");
    const premSocialBox = byId("premSocialBox");

    byId("premTabFilm").addEventListener("click", () => {
      S.premType = "movie";
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      byId("premExplain").textContent = "Film. Regola gli slider e cerca.";
      loadPremiumHistory();
    });

    byId("premTabTv").addEventListener("click", () => {
      S.premType = "tv";
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      byId("premExplain").textContent = "Serie TV. Regola gli slider e cerca.";
      loadPremiumHistory();
    });

    byId("premTabSocial").addEventListener("click", () => {
      premFilmTvBox.style.display = "none";
      premSocialBox.style.display = "block";
      byId("premExplain").textContent = "";
    });

    const sliders = [
      { sl:"slAction", out:"valAction" },
      { sl:"slComedy", out:"valComedy" },
      { sl:"slThriller", out:"valThriller" },
      { sl:"slRomance", out:"valRomance" },
      { sl:"slDrama", out:"valDrama" }
    ];

    sliders.forEach(s => {
      byId(s.sl).addEventListener("input", (ev) => {
        byId(s.out).textContent = ev.target.value;
      });
    });

    byId("btnPremSurprise").addEventListener("click", () => {
      byId("slAction").value = "0";
      byId("slComedy").value = "0";
      byId("slThriller").value = "0";
      byId("slRomance").value = "0";
      byId("slDrama").value = "0";
      sliders.forEach(s => byId(s.out).textContent = byId(s.sl).value);
      byId("premExplain").textContent = "Sorprendimi. Scelgo senza preferenze.";
      premiumSearch(true);
    });

    byId("btnPremSearch").addEventListener("click", () => premiumSearch(false));

    async function premiumSearch(isSurprise){
      if(!S.premium){
        openPayModal();
        return;
      }
      if(!hasApiKey()){
        byId("premExplain").textContent = "Inserisci la tua TMDB API key nel codice. Cerca TMDB_API_KEY.";
        return;
      }

      byId("premResults").innerHTML = "";
      byId("premExplain").textContent = "Sto cercando 5 titoli...";

      try{
        const weights = getPremiumWeights();
        const withGenres = buildGenreListForPremium(weights, isSurprise);
        const explain = explainWeights(weights, isSurprise);

        const list = await discoverTitles(S.premType, {
          with_genres: withGenres,
          sort_by: "popularity.desc",
          include_adult: "true"
        });

        const picked = pickUnique(list, 18, 5);

        const enriched = await Promise.all(picked.map(async (m) => {
          const providers = await getProviders(S.premType, m.id);
          return { ...m, providers };
        }));

        renderResults(byId("premResults"), enriched, { mode:"premium", type:S.premType });

        byId("premExplain").textContent = explain;

      }catch(e){
        byId("premExplain").textContent = "Errore. Controlla API key e rete.";
      }
    }

    function getPremiumWeights(){
      return {
        action: Number(byId("slAction").value),
        comedy: Number(byId("slComedy").value),
        thriller: Number(byId("slThriller").value),
        romance: Number(byId("slRomance").value),
        drama: Number(byId("slDrama").value)
      };
    }

    function buildGenreListForPremium(w, isSurprise){
      if(isSurprise) return "";
      const map = [
        ["action", G.action],
        ["comedy", G.comedy],
        ["thriller", G.thriller],
        ["romance", G.romance],
        ["drama", G.drama]
      ];

      const chosen = map
        .filter(([k]) => w[k] > 0)
        .sort((a,b) => w[b[0]] - w[a[0]])
        .slice(0, 3)
        .map(([,id]) => id);

      return chosen.join(",");
    }

    function explainWeights(w, isSurprise){
      if(isSurprise) return "Questi titoli sono stati scelti senza preferenze.";
      const pairs = Object.entries(w).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
      if(pairs.length === 0) return "Metti almeno un genere sopra 0, oppure usa Sorprendimi.";
      const top = pairs.slice(0,2).map(p => p[0]).join(" e ");
      const nice = top.replace("action","Azione").replace("comedy","Comico").replace("thriller","Thriller").replace("romance","Romantico").replace("drama","Dramma");
      return "Questi titoli sono stati scelti perché hai dato più peso a " + nice + ".";
    }

    /* ===========================
       SOCIAL
       =========================== */
    byId("btnCopyLink").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(APP_DEEPLINK);
        alert("Link copiato.");
      }catch(e){
        alert("Non riesco a copiare. Copia manualmente: " + APP_DEEPLINK);
      }
    });

    byId("btnShareNow").addEventListener("click", () => shareText("Sto guardando questo su Movie Finder", APP_DEEPLINK));
    byId("btnShareRec").addEventListener("click", () => shareText("Consigliato su Movie Finder", APP_DEEPLINK));

    async function shareText(title, url){
      try{
        if(navigator.share){
          await navigator.share({ title, text: title, url });
        }else{
          await navigator.clipboard.writeText(url);
          alert("Condivisione non disponibile. Ho copiato il link.");
        }
      }catch(e){}
    }

    /* ===========================
       HISTORY E TOP WEEK
       =========================== */
    function getHistory(){
      try{
        return JSON.parse(localStorage.getItem("mf_history") || "[]");
      }catch(e){
        return [];
      }
    }
    function pushHistory(item){
      const h = getHistory();
      const key = item.media_type + ":" + item.id;
      const filtered = h.filter(x => (x.media_type + ":" + x.id) !== key);
      filtered.unshift(item);
      localStorage.setItem("mf_history", JSON.stringify(filtered.slice(0, 8)));
    }

    async function loadTopWeek(){
      if(!hasApiKey()){
        byId("premTopWeek").innerHTML = "";
        return;
      }
      try{
        const list = await tmdb("/trending/all/week");
        const picked = (list.results || []).filter(x => x.media_type === "movie" || x.media_type === "tv").slice(0, 5);

        const enriched = await Promise.all(picked.map(async (m) => {
          const providers = await getProviders(m.media_type, m.id);
          return { ...m, providers };
        }));

        renderResults(byId("premTopWeek"), enriched, { mode:"premium", type:"all", compact:true, label:"Top settimana" });
      }catch(e){
        byId("premTopWeek").innerHTML = "";
      }
    }

    function loadPremiumHistory(){
      const h = getHistory();
      if(h.length === 0){
        byId("premHistory").innerHTML = '<div class="muted" style="font-size:13px">Nessun titolo visto di recente.</div>';
        return;
      }
      renderResults(byId("premHistory"), h.slice(0, 5), { mode:"premium", type:"all", compact:true, label:"Ultimi visti" });
    }

    async function loadPremiumPanels(){
      updatePremiumStatus();
      byId("premExplain").textContent = "Film. Regola gli slider e cerca.";
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      S.premType = "movie";
      loadPremiumHistory();
      await loadTopWeek();
    }

    /* ===========================
       TMDB HELPERS
       =========================== */
    function hasApiKey(){
      return TMDB_API_KEY && TMDB_API_KEY !== "INSERISCI_LA_TUA_KEY";
    }

    async function tmdb(path, params){
      const url = new URL(TMDB_BASE + path);
      url.searchParams.set("api_key", TMDB_API_KEY);
      url.searchParams.set("language", "it-IT");
      if(params){
        Object.entries(params).forEach(([k,v]) => {
          if(v === undefined || v === null || v === "") return;
          url.searchParams.set(k, String(v));
        });
      }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error("TMDB error");
      return await res.json();
    }

    async function discoverTitles(type, opts){
      const path = type === "tv" ? "/discover/tv" : "/discover/movie";
      const base = {
        watch_region: REGION,
        with_watch_monetization_types: "flatrate|rent|buy",
        "vote_count.gte": 120
      };
      const data = await tmdb(path, { ...base, ...opts });
      return data.results || [];
    }

    async function getProviders(type, id){
      const data = await tmdb("/" + type + "/" + id + "/watch/providers", {});
      const it = (data.results && data.results[REGION]) ? data.results[REGION] : null;
      if(!it) return { flatrate:[], rent:[], buy:[] };

      return {
        flatrate: it.flatrate || [],
        rent: it.rent || [],
        buy: it.buy || []
      };
    }

    function pickUnique(list, pool, take){
      const clean = (list || []).filter(x => x && x.id && (x.poster_path || x.backdrop_path));
      const slice = clean.slice(0, pool);
      // piccolo shuffle stabile
      for(let i=slice.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [slice[i], slice[j]] = [slice[j], slice[i]];
      }
      return slice.slice(0, take);
    }

    /* ===========================
       RENDER RESULTS
       =========================== */
    function renderResults(container, items, opts){
      const mode = opts.mode;
      const type = opts.type;
      const compact = !!opts.compact;

      if(!items || items.length === 0){
        container.innerHTML = '<div class="muted" style="font-size:13px">Nessun risultato.</div>';
        return;
      }

      container.innerHTML = "";

      items.forEach((m, idx) => {
        const title = m.title || m.name || "Titolo";
        const date = m.release_date || m.first_air_date || "";
        const year = date ? date.slice(0,4) : "----";
        const vote = (typeof m.vote_average === "number") ? m.vote_average.toFixed(1) : "n.d.";
        const overview = (m.overview || "").trim();
        const shortOv = overview ? clamp(overview, compact ? 90 : (mode==="basic" ? 120 : 220)) : "Trama non disponibile.";

        const poster = m.poster_path ? (IMG + m.poster_path) : "";
        const mediaType = m.media_type || (type === "all" ? "movie" : type);

        const box = document.createElement("div");
        box.className = "result";

        box.innerHTML = `
          <div class="poster">${poster ? `<img alt="" src="${poster}">` : ""}</div>
          <div>
            <div class="rtitle">
              <h3>${escapeHtml(title)}</h3>
              <span class="badge">${year}</span>
            </div>

            <div class="rmeta">
              <span class="badge">Voto ${vote}</span>
              <span class="badge">${mediaType === "tv" ? "Serie TV" : "Film"}</span>
              ${mode==="premium" ? `<span class="badge">Pop ${Math.round(m.popularity || 0)}</span>` : `<span class="badge">Scelta ${idx+1}</span>`}
            </div>

            <div class="rov">${escapeHtml(shortOv)}</div>

            ${renderProvidersLine(m.providers, mode)}

            <div class="row" style="margin-top:10px">
              <button class="btn small ${mode==="basic" ? "green" : "primary"}" data-act="open" data-id="${m.id}" data-type="${mediaType}">Dettagli</button>
              <button class="btn small ghost" data-act="start" data-id="${m.id}" data-type="${mediaType}">Avvia</button>
            </div>
          </div>
        `;

        box.addEventListener("click", (ev) => {
          const b = ev.target.closest("button");
          if(!b) return;
          const act = b.getAttribute("data-act");
          const id = Number(b.getAttribute("data-id"));
          const t = b.getAttribute("data-type");

          if(act === "open"){
            // salva in cronologia
            pushHistory({
              id: m.id,
              media_type: t,
              title: m.title || undefined,
              name: m.name || undefined,
              poster_path: m.poster_path || null,
              overview: m.overview || "",
              vote_average: m.vote_average,
              release_date: m.release_date,
              first_air_date: m.first_air_date,
              popularity: m.popularity,
              providers: m.providers
            });
            if(S.profile === "premium"){
              loadPremiumHistory();
            }
            alert("Demo. Qui apri una pagina dettagli con trama estesa e statistiche complete.");
          }

          if(act === "start"){
            try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}
            show("secFinal");
            setTimeout(() => {
              try{ window.close(); }catch(e){}
            }, 900);
          }
        });

        container.appendChild(box);
      });
    }

    function renderProvidersLine(p, mode){
      if(!p) return '<div class="providers"><span class="muted">Piattaforme non disponibili.</span></div>';

      const fl = (p.flatrate || []).slice(0, 4);
      const rent = (p.rent || []).slice(0, 4);
      const buy = (p.buy || []).slice(0, 4);

      if(mode === "basic"){
        // Basic: mostra solo presenza online, 2 o 3 provider max
        const list = fl.length ? fl : (rent.length ? rent : buy);
        if(list.length === 0){
          return '<div class="providers"><span class="muted">Non ho trovato piattaforme in IT.</span></div>';
        }
        const shown = list.slice(0, 3).map(x => provChip(x, fl.length ? "Gratis" : (rent.length ? "Noleggio" : "Acquisto"))).join("");
        return `<div class="providers">${shown}</div>`;
      }

      // Premium: mostra tutte le categorie
      const parts = [];
      if(fl.length) parts.push(`<span class="badge">Gratis</span>` + fl.slice(0,4).map(x => provChip(x,"")).join(""));
      if(rent.length) parts.push(`<span class="badge">Noleggio</span>` + rent.slice(0,4).map(x => provChip(x,"")).join(""));
      if(buy.length) parts.push(`<span class="badge">Acquisto</span>` + buy.slice(0,4).map(x => provChip(x,"")).join(""));

      if(parts.length === 0){
        return '<div class="providers"><span class="muted">Non ho trovato piattaforme in IT.</span></div>';
      }

      return `<div class="providers">${parts.join("")}</div>`;
    }

    function provChip(x, tag){
      const logo = x.logo_path ? (LOGO + x.logo_path) : "";
      const name = x.provider_name || "Provider";
      const t = tag ? `<span class="muted">${tag}</span>` : "";
      return `
        <span class="prov">
          ${logo ? `<img alt="" src="${logo}">` : ""}
          <span>${escapeHtml(name)}</span>
          ${t}
        </span>
      `;
    }

    function clamp(s, n){
      if(s.length <= n) return s;
      return s.slice(0, n).trim() + "...";
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function byId(id){ return document.getElementById(id); }

    /* ===========================
       BOOT
       =========================== */
    (function boot(){
      // Splash breve, poi profili
      show("secSplash");
      setTimeout(() => show("secProfiles"), 900);

      // Stato
      refreshBasicLimitUI();
      updatePremiumStatus();

      // Se l’utente aveva già scelto profilo
      if(S.profile === "basic"){
        show("secBasic");
        refreshBasicLimitUI();
      }
      if(S.profile === "premium"){
        if(S.premium){
          show("secPremium");
          loadPremiumPanels();
        }
      }
    })();
  </script>
</body>
</html>
```0
