<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Finder</title>

  <style>
    :root{
      --bg:#050607;
      --text:#e9eef2;
      --muted:#9aa6b2;
      --line:#1d2427;
      --acidY:#e6ff00;
      --acidG:#00ff7a;
      --serviceBlue:#3aa0ff;
      --r:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, #0e1416 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      position:sticky;top:0;background:rgba(5,6,7,.86);backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);z-index:50;padding:12px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(145deg, var(--acidY), #9cff00);
      box-shadow: 0 10px 24px rgba(230,255,0,.15);
    }
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:1px}

    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, #11181b 0%, #0b0f11 100%);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;box-shadow: var(--shadow);
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(230,255,0,.35);
      background: linear-gradient(180deg, rgba(230,255,0,.18) 0%, rgba(230,255,0,.06) 100%);
    }
    .btn.green{
      border-color: rgba(0,255,122,.35);
      background: linear-gradient(180deg, rgba(0,255,122,.18) 0%, rgba(0,255,122,.06) 100%);
    }
    .btn.ghost{box-shadow:none;background:transparent;border-color: var(--line)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none}
    .btn.active{
      border-color: rgba(58,160,255,.45);
      box-shadow: 0 0 0 4px rgba(58,160,255,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      padding:18px;
    }
    @media (max-width:900px){ .grid{grid-template-columns: 1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .service{
      color: var(--serviceBlue);
      font-size: 13px;
      line-height: 1.35;
    }
    .serviceBadge{
      color: var(--serviceBlue);
      border-color: rgba(58,160,255,.35);
      background: rgba(58,160,255,.06);
    }

    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,122,.35);
      box-shadow: 0 0 0 4px rgba(0,255,122,.08);
    }
    .pill .dot{width:9px;height:9px;border-radius:99px;background:#3a464d}
    .pill.on .dot{background: var(--acidG)}
    .pill.yellow.on{
      border-color: rgba(230,255,0,.35);
      box-shadow: 0 0 0 4px rgba(230,255,0,.08);
    }
    .pill.yellow.on .dot{background: var(--acidY)}

    .badge{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:5px 8px;border-radius:999px;
      background:rgba(255,255,255,.02);
    }

    .results{display:grid;grid-template-columns:1fr;gap:12px}
    .result{
      display:grid;grid-template-columns: 92px 1fr;gap:12px;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background: rgba(0,0,0,.22);
    }
    .poster{
      width:92px;height:138px;border-radius:14px;
      background: linear-gradient(180deg, rgba(230,255,0,.12) 0%, rgba(0,255,122,.08) 100%);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .rtitle{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .rtitle h3{margin:0;font-size:15px;line-height:1.25}
    .rmeta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .rmeta .badge{font-size:11px}
    .rov{margin:8px 0 10px 0;color:#cdd6de;font-size:13px;line-height:1.35}
    .providers{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .prov{
      display:flex;align-items:center;gap:8px;
      padding:6px 8px;border:1px solid var(--line);
      border-radius:999px;background:rgba(255,255,255,.02);
      font-size:12px;color:#dbe4ec;
    }
    .prov img{width:18px;height:18px;border-radius:4px}

    .section{display:none}
    .section.on{display:block}

    .splash{
      min-height: calc(100vh - 62px);
      display:grid;place-items:center;padding:18px;
    }
    .splash .box{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      padding:20px;
      background: radial-gradient(700px 300px at 40% 0%, rgba(230,255,0,.10) 0%, rgba(0,255,122,.06) 45%, rgba(0,0,0,.0) 70%);
      box-shadow: var(--shadow);
      text-align:center;
      animation: fadeIn .55s ease forwards;
    }
    .bigLogo{
      width:74px;height:74px;border-radius:22px;margin:0 auto 12px auto;
      background: linear-gradient(145deg, var(--acidY), #9cff00);
      box-shadow: 0 18px 40px rgba(230,255,0,.12);
    }
    .splash h2{margin:0 0 6px 0}
    .splash p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    @keyframes fadeIn{
      from{opacity:0;transform: translateY(10px)}
      to{opacity:1;transform: translateY(0)}
    }

    .modalBack{
      position:fixed;inset:0;background: rgba(0,0,0,.62);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:99;
    }
    .modalBack.on{display:flex}
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:0;line-height:1.35}

    .sliderRow{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;align-items:center;
      padding:10px;border:1px solid var(--line);border-radius:16px;
      background: rgba(0,0,0,.18);
      margin:8px 0;
    }
    input[type="range"]{width:100%}

    .copyHint{display:none;margin-left:10px;font-size:12px}
    .copyHint.on{display:inline}

    .cinema{
      position:fixed;inset:0;
      background:#000;
      opacity:0;
      pointer-events:none;
      z-index:200;
      transition: opacity 900ms ease;
      display:flex;align-items:center;justify-content:center;
      padding:18px;text-align:center;
    }
    .cinema.on{
      opacity:1;
      pointer-events:auto;
    }
    .cinema .box{
      width:min(640px, 100%);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 16px;
      background: rgba(0,0,0,.35);
      box-shadow: 0 20px 60px rgba(0,0,0,.65);
      position:relative;
      overflow:hidden;
    }
    .cinema .filmtext{
      font-size:20px;letter-spacing:.3px;line-height:1.35;
      text-shadow: 0 0 10px rgba(255,255,255,.10);
      animation: proj 1.2s infinite;
    }
    .cinema .sub{
      margin-top:10px;
      font-size:12px;
      line-height:1.35;
    }
    .cinema .actions{
      margin-top:14px;
      display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
    }
    .grain{
      position:absolute;inset:-40px;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.06) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 80%, rgba(255,255,255,.05) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 60%, rgba(255,255,255,.04) 0 1px, transparent 2px);
      background-size: 120px 120px;
      opacity:.25;
      mix-blend-mode: overlay;
      animation: grainMove 600ms steps(2) infinite;
      pointer-events:none;
    }
    @keyframes grainMove{
      0%{transform: translate3d(0,0,0)}
      50%{transform: translate3d(-12px, 8px,0)}
      100%{transform: translate3d(10px,-10px,0)}
    }
    @keyframes proj{
      0%{opacity:1;transform: translateX(0)}
      12%{opacity:.92;transform: translateX(-.5px)}
      24%{opacity:1;transform: translateX(.6px)}
      38%{opacity:.88;transform: translateX(-.2px)}
      55%{opacity:1;transform: translateX(.4px)}
      70%{opacity:.93;transform: translateX(-.4px)}
      100%{opacity:1;transform: translateX(0)}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Movie Finder</h1>
        <small>TMDB, solo titoli disponibili online in IT</small>
      </div>
    </div>

    <div class="row">
      <button class="btn small ghost" id="btnHome">Home</button>
      <button class="btn small primary" id="btnCopy">Copia index.html</button>
      <span class="copyHint service" id="copyHint">Copiato</span>
    </div>
  </div>

  <main class="wrap">

    <section class="section on" id="secSplash">
      <div class="splash">
        <div class="box">
          <div class="bigLogo" aria-hidden="true"></div>
          <h2>Movie Finder</h2>
          <p>Poster, trama, statistiche, piattaforme.</p>
          <div class="service">Avvio app.</div>
        </div>
      </div>
    </section>

    <section class="section" id="secProfiles">
      <div class="grid">
        <div class="card">
          <h2>Scegli il profilo</h2>
          <p class="muted">Basic per semplicità. Premium per slider e Serie TV.</p>
          <div class="sep"></div>

          <div class="card" style="background:rgba(0,0,0,.22)">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:650">Basic</div>
                <div class="muted" style="font-size:13px;margin-top:2px">Una ricerca al giorno. 3 risultati. Solo disponibili.</div>
              </div>
              <button class="btn green" id="btnBasic">Entra in Basic</button>
            </div>
            <div class="sep"></div>
            <div class="muted" style="font-size:13px;line-height:1.4">
              Film e Serie TV nel menu, ma Serie TV bloccate.
              Generi: Azione, Comico, Thriller, Animazione.
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="background:rgba(0,0,0,.22)">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:650">Premium</div>
                <div class="muted" style="font-size:13px;margin-top:2px">Illimitato. 5 risultati. Coerenza massima.</div>
              </div>
              <button class="btn primary" id="btnPremium">Entra in Premium</button>
            </div>
            <div class="sep"></div>
            <div class="muted" style="font-size:13px;line-height:1.4">
              Uno slider domina. Io obbligo quel genere.
              Gli altri slider rifiniscono solo l’ordine.
              Film e Serie TV sbloccate.
            </div>
          </div>

          <div class="sep"></div>
          <div class="service">Nota. Il pagamento Play Store qui è simulato.</div>
        </div>

        <div class="card">
          <h2>Stato</h2>
          <div class="row">
            <span class="badge">Regione: IT</span>
            <span class="badge">Solo disponibili</span>
            <span class="badge">flatrate, rent, buy</span>
          </div>
          <div class="sep"></div>
          <button class="btn ghost" id="btnResetLocal">Reset demo</button>
          <div class="sep"></div>
          <div class="service" id="netHint"></div>
        </div>
      </div>
    </section>

    <section class="section" id="secBasic">
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 style="margin-bottom:4px">Basic</h2>
              <div class="muted" style="font-size:13px">Una scelta al giorno. Solo film. Solo disponibili.</div>
            </div>
            <span class="badge serviceBadge" id="basicLimitBadge">Controllo limite</span>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn small active" disabled>Film</button>
            <button class="btn small" disabled>Serie TV</button>
            <span class="badge serviceBadge">Serie TV bloccate</span>
          </div>

          <div class="sep"></div>

          <h2 style="font-size:14px;margin:0 0 10px 0">Generi</h2>
          <div class="row" id="basicGenres">
            <div class="pill on yellow" data-genre="28"><span class="dot"></span>Azione</div>
            <div class="pill" data-genre="35"><span class="dot"></span>Comico</div>
            <div class="pill" data-genre="53"><span class="dot"></span>Thriller</div>
            <div class="pill" data-genre="16"><span class="dot"></span>Animazione</div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn green" id="btnBasicSearch">Cerca oggi</button>
            <button class="btn ghost" id="btnBasicClear">Azzera selezione</button>
          </div>

          <div class="service" id="basicHint"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Risultati</h2>
            <span class="badge">3 titoli</span>
          </div>
          <div class="sep"></div>
          <div class="results" id="basicResults"></div>
          <div class="sep"></div>
          <div class="service" id="basicServiceNote"></div>
        </div>
      </div>
    </section>

    <section class="section" id="secPremium">
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 style="margin-bottom:4px">Premium</h2>
              <div class="muted" style="font-size:13px">Coerenza massima. Anche se pochi risultati.</div>
            </div>
            <span class="badge serviceBadge" id="premiumStatus">Stato pagamento</span>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn small active" id="premTabFilm">Film</button>
            <button class="btn small" id="premTabTv">Serie TV</button>
            <button class="btn small ghost" id="premTabSocial">Social</button>
          </div>

          <div class="sep"></div>

          <div id="premFilmTvBox">
            <h2 style="font-size:14px;margin:0 0 6px 0">Generi con intensità</h2>
            <div class="service">Io obbligo il genere più alto. Gli altri ordinano soltanto.</div>

            <div class="sep"></div>

            <div class="sliderRow">
              <div><div style="font-weight:650">Azione</div><div class="muted" style="font-size:12px">Ritmo</div></div>
              <div class="row" style="justify-content:flex-end"><span class="badge serviceBadge" id="valAction">3</span></div>
              <div style="grid-column:1 / -1"><input type="range" min="0" max="5" value="3" id="slAction" /></div>
            </div>

            <div class="sliderRow">
              <div><div style="font-weight:650">Comico</div><div class="muted" style="font-size:12px">Leggero</div></div>
              <div class="row" style="justify-content:flex-end"><span class="badge serviceBadge" id="valComedy">2</span></div>
              <div style="grid-column:1 / -1"><input type="range" min="0" max="5" value="2" id="slComedy" /></div>
            </div>

            <div class="sliderRow">
              <div><div style="font-weight:650">Thriller</div><div class="muted" style="font-size:12px">Tensione</div></div>
              <div class="row" style="justify-content:flex-end"><span class="badge serviceBadge" id="valThriller">3</span></div>
              <div style="grid-column:1 / -1"><input type="range" min="0" max="5" value="3" id="slThriller" /></div>
            </div>

            <div class="sliderRow">
              <div><div style="font-weight:650">Romantico</div><div class="muted" style="font-size:12px">Emozioni</div></div>
              <div class="row" style="justify-content:flex-end"><span class="badge serviceBadge" id="valRomance">1</span></div>
              <div style="grid-column:1 / -1"><input type="range" min="0" max="5" value="1" id="slRomance" /></div>
            </div>

            <div class="sliderRow">
              <div><div style="font-weight:650">Dramma</div><div class="muted" style="font-size:12px">Intenso</div></div>
              <div class="row" style="justify-content:flex-end"><span class="badge serviceBadge" id="valDrama">2</span></div>
              <div style="grid-column:1 / -1"><input type="range" min="0" max="5" value="2" id="slDrama" /></div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn primary" id="btnPremSearch">Cerca</button>
              <button class="btn ghost" id="btnPremSurprise">Sorprendimi</button>
            </div>

            <div class="service" id="premExplain"></div>
          </div>

          <div id="premSocialBox" style="display:none">
            <h2 style="font-size:14px;margin:0 0 8px 0">Social</h2>
            <div class="service">Condividi cosa stai guardando. Il link invita a scaricare la app.</div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn green" id="btnShareNow">Sto guardando questo</button>
              <button class="btn" id="btnShareRec">Consigliato</button>
              <button class="btn ghost" id="btnCopyLink">Copia link app</button>
            </div>
          </div>

          <div class="sep"></div>

          <h2 style="font-size:14px;margin:0 0 8px 0">Ultimi visti e Top settimana</h2>
          <div class="sep"></div>
          <div class="results" id="premHistory"></div>
          <div class="sep"></div>
          <div class="results" id="premTopWeek"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Risultati</h2>
            <span class="badge">5 titoli</span>
          </div>
          <div class="sep"></div>
          <div class="results" id="premResults"></div>
          <div class="sep"></div>
          <div class="service" id="premServiceNote"></div>
        </div>
      </div>
    </section>

  </main>

  <div class="modalBack" id="payModal">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3>Attiva Premium</h3>
          <p class="service">In app userai Play Store. Qui lo simulo per la demo.</p>
        </div>
        <button class="btn small ghost" id="btnPayClose">Chiudi</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn primary" id="btnPayNow">Paga con Play Store</button>
        <button class="btn ghost" id="btnPayLater">Non ora</button>
      </div>
    </div>
  </div>

  <div class="modalBack" id="limitModal">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3>Hai già usato la scelta di oggi</h3>
          <p class="service">In Basic puoi fare una sola ricerca al giorno.</p>
        </div>
        <button class="btn small ghost" id="btnLimitClose">Chiudi</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn ghost" id="btnComeBack">Torna domani</button>
        <button class="btn primary" id="btnUpgrade">Passa a Premium</button>
      </div>
    </div>
  </div>

  <div class="cinema" id="cinema">
    <div class="box">
      <div class="grain" aria-hidden="true"></div>
      <div class="filmtext">Mettiti comodo, lo spettacolo sta per iniziare</div>
      <div class="sub service" id="cinemaSub">Sto chiudendo la app...</div>
      <div class="actions" id="cinemaActions" style="display:none">
        <button class="btn primary" id="btnCloseTab">Chiudi</button>
        <button class="btn ghost" id="btnBack">Torna indietro</button>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // Nota tecnica: in un file statico la key resta nel sorgente.
    // Qui non la mostro nella UI. In app vera la sposti lato server o usi un proxy.
    const TMDB_API_KEY = ("f8ecb7" + "5282e8dcea" + "2d4845598cc7d030");
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const IMG = "https://image.tmdb.org/t/p/w342";
    const LOGO = "https://image.tmdb.org/t/p/w45";
    const REGION = "IT";
    const APP_DEEPLINK = "https://example.com/movie-finder";

    const G = { action:28, comedy:35, thriller:53, animation:16, romance:10749, drama:18 };

    const S = {
      premium: localStorage.getItem("mf_premium") === "true",
      premType: "movie"
    };

    function byId(id){ return document.getElementById(id); }

    const secSplash = byId("secSplash");
    const secProfiles = byId("secProfiles");
    const secBasic = byId("secBasic");
    const secPremium = byId("secPremium");

    function show(sectionId){
      [secSplash, secProfiles, secBasic, secPremium].forEach(x => x.classList.remove("on"));
      byId(sectionId).classList.add("on");
      window.scrollTo({top:0, behavior:"instant"});
    }

    function setService(elId, msg){
      const el = byId(elId);
      if(!el) return;
      el.textContent = msg || "";
    }

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function setPremium(on){
      S.premium = !!on;
      localStorage.setItem("mf_premium", String(!!on));
      updatePremiumStatus();
    }

    function updatePremiumStatus(){
      byId("premiumStatus").textContent = S.premium ? "Premium attivo" : "Non attivo";
    }
    updatePremiumStatus();

    const netHint = byId("netHint");
    function setNetHint(msg){ if(netHint) netHint.textContent = msg || ""; }

    byId("btnHome").addEventListener("click", () => show("secProfiles"));

    byId("btnResetLocal").addEventListener("click", () => {
      localStorage.removeItem("mf_premium");
      localStorage.removeItem("mf_basic_last_date");
      localStorage.removeItem("mf_history");
      location.reload();
    });

    byId("btnCopy").addEventListener("click", async () => {
      const hint = byId("copyHint");
      try{
        const html = "<!doctype html>\n" + document.documentElement.outerHTML;
        await navigator.clipboard.writeText(html);
        hint.classList.add("on");
        setTimeout(() => hint.classList.remove("on"), 1200);
      }catch(e){
        alert("Copia non riuscita. Prova da Chrome.");
      }
    });

    const payModal = byId("payModal");
    function openPayModal(){ payModal.classList.add("on"); }
    function closePayModal(){ payModal.classList.remove("on"); }

    byId("btnPayClose").addEventListener("click", closePayModal);
    byId("btnPayLater").addEventListener("click", closePayModal);
    byId("btnPayNow").addEventListener("click", () => {
      setPremium(true);
      closePayModal();
      show("secPremium");
      initPremiumView();
    });

    byId("btnBasic").addEventListener("click", () => {
      show("secBasic");
      refreshBasicLimitUI();
      byId("basicResults").innerHTML = "";
      setService("basicHint", "Seleziona un genere. Io uso il genere selezionato per primo.");
      setService("basicServiceNote", "");
    });

    byId("btnPremium").addEventListener("click", () => {
      if(!S.premium){ openPayModal(); return; }
      show("secPremium");
      initPremiumView();
    });

    const limitModal = byId("limitModal");
    byId("btnLimitClose").addEventListener("click", () => limitModal.classList.remove("on"));
    byId("btnComeBack").addEventListener("click", () => limitModal.classList.remove("on"));
    byId("btnUpgrade").addEventListener("click", () => {
      limitModal.classList.remove("on");
      if(!S.premium){ openPayModal(); }
      else{ show("secPremium"); initPremiumView(); }
    });

    function basicCanSearch(){
      return (localStorage.getItem("mf_basic_last_date") || "") !== todayKey();
    }
    function refreshBasicLimitUI(){
      byId("basicLimitBadge").textContent = basicCanSearch() ? "Ricerca disponibile oggi" : "Già usata oggi";
    }

    const basicGenresBox = byId("basicGenres");
    let basicSelected = [];
    function basicHas(gid){ return basicSelected.indexOf(gid) >= 0; }
    function basicAdd(gid){ if(!basicHas(gid)) basicSelected.push(gid); }
    function basicRemove(gid){ basicSelected = basicSelected.filter(x => x !== gid); }

    basicAdd(G.action);

    basicGenresBox.addEventListener("click", (ev) => {
      const el = ev.target.closest(".pill");
      if(!el) return;
      const id = Number(el.getAttribute("data-genre"));
      if(basicHas(id)){
        basicRemove(id);
        el.classList.remove("on","yellow");
      }else{
        basicAdd(id);
        el.classList.add("on","yellow");
      }
    });

    byId("btnBasicClear").addEventListener("click", () => {
      basicSelected = [];
      [...basicGenresBox.querySelectorAll(".pill")].forEach(p => p.classList.remove("on","yellow"));
      setService("basicHint", "Seleziona almeno un genere.");
    });

    byId("btnBasicSearch").addEventListener("click", async () => {
      refreshBasicLimitUI();

      if(!basicCanSearch()){
        limitModal.classList.add("on");
        return;
      }
      if(basicSelected.length === 0){
        setService("basicHint", "Seleziona almeno un genere.");
        return;
      }

      const dominant = basicSelected[0];
      setService("basicHint", "Sto cercando 3 film. Genere obbligatorio: " + genreName(dominant) + ".");
      setService("basicServiceNote", "");
      byId("basicResults").innerHTML = "";

      try{
        const final = await strictSearch({
          type: "movie",
          dominantGenreId: dominant,
          refineWeightsByGenreId: {},
          take: 3,
          poolPages: 3,
          maxCandidates: 80,
          maxProviderChecks: 140,
          minVoteCount: 150
        });

        renderResults(byId("basicResults"), final, { mode:"basic", type:"movie" });

        localStorage.setItem("mf_basic_last_date", todayKey());
        refreshBasicLimitUI();

        if(final.length === 0){
          setService("basicServiceNote", "Non ho trovato titoli disponibili in IT per questo genere.");
        }else if(final.length < 3){
          setService("basicServiceNote", "Ho trovato pochi titoli disponibili. Il filtro è molto rigido.");
        }else{
          setService("basicServiceNote", "Ok. Risultati coerenti e disponibili.");
        }
      }catch(e){
        setService("basicHint", "Errore di rete o TMDB.");
      }
    });

    const premFilmTvBox = byId("premFilmTvBox");
    const premSocialBox = byId("premSocialBox");
    const btnTabFilm = byId("premTabFilm");
    const btnTabTv = byId("premTabTv");
    const btnTabSocial = byId("premTabSocial");

    function setActiveTab(which){
      btnTabFilm.classList.remove("active");
      btnTabTv.classList.remove("active");
      if(which === "movie") btnTabFilm.classList.add("active");
      if(which === "tv") btnTabTv.classList.add("active");
    }

    btnTabFilm.addEventListener("click", () => {
      S.premType = "movie";
      setActiveTab("movie");
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      byId("premResults").innerHTML = "";
      setService("premServiceNote", "");
      setService("premExplain", "Film. Alza uno slider sopra gli altri.");
    });

    btnTabTv.addEventListener("click", () => {
      S.premType = "tv";
      setActiveTab("tv");
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      byId("premResults").innerHTML = "";
      setService("premServiceNote", "");
      setService("premExplain", "Serie TV. Alza uno slider sopra gli altri.");
    });

    btnTabSocial.addEventListener("click", () => {
      premFilmTvBox.style.display = "none";
      premSocialBox.style.display = "block";
      setService("premExplain", "");
      setService("premServiceNote", "");
    });

    const sliders = [
      { sl:"slAction", out:"valAction" },
      { sl:"slComedy", out:"valComedy" },
      { sl:"slThriller", out:"valThriller" },
      { sl:"slRomance", out:"valRomance" },
      { sl:"slDrama", out:"valDrama" }
    ];
    sliders.forEach(s => {
      byId(s.sl).addEventListener("input", (ev) => byId(s.out).textContent = ev.target.value);
    });

    byId("btnPremSearch").addEventListener("click", () => premiumSearch(false));
    byId("btnPremSurprise").addEventListener("click", () => premiumSearch(true));

    function initPremiumView(){
      premFilmTvBox.style.display = "block";
      premSocialBox.style.display = "none";
      S.premType = "movie";
      setActiveTab("movie");
      byId("premResults").innerHTML = "";
      setService("premServiceNote", "");
      setService("premExplain", "Film. Alza uno slider sopra gli altri.");
      loadPremiumHistory();
      loadTopWeek();
    }

    function getPremiumWeightsRaw(){
      return {
        action: Number(byId("slAction").value),
        comedy: Number(byId("slComedy").value),
        thriller: Number(byId("slThriller").value),
        romance: Number(byId("slRomance").value),
        drama: Number(byId("slDrama").value)
      };
    }

    function weightsToGenreIdMap(w){
      const map = {};
      if(w.action) map[G.action] = w.action;
      if(w.comedy) map[G.comedy] = w.comedy;
      if(w.thriller) map[G.thriller] = w.thriller;
      if(w.romance) map[G.romance] = w.romance;
      if(w.drama) map[G.drama] = w.drama;
      return map;
    }

    function dominantFromWeights(wById){
      let bestId = null;
      let best = 0;
      for(const k in wById){
        const v = wById[k];
        if(v > best){ best = v; bestId = Number(k); }
      }
      return { id: bestId, val: best };
    }

    async function premiumSearch(isSurprise){
      if(!S.premium){ openPayModal(); return; }

      byId("premResults").innerHTML = "";
      setService("premServiceNote", "");

      try{
        if(isSurprise){
          setService("premExplain", "Sorprendimi. Cerco solo titoli disponibili in IT.");
          const final0 = await strictSurprise({
            type: S.premType,
            take: 5,
            maxProviderChecks: 220
          });
          renderResults(byId("premResults"), final0, { mode:"premium", type:S.premType });
          setService("premServiceNote", final0.length ? "Ok. Tutti disponibili." : "Non ho trovato titoli disponibili.");
          return;
        }

        const wRaw = getPremiumWeightsRaw();
        const wById = weightsToGenreIdMap(wRaw);
        const dom = dominantFromWeights(wById);

        if(!dom.id || dom.val <= 0){
          setService("premExplain", "Alza uno slider sopra 0, oppure usa Sorprendimi.");
          return;
        }

        const refine = { ...wById };
        delete refine[dom.id];

        setService("premExplain", "Genere obbligatorio: " + genreName(dom.id) + ". Sto cercando titoli disponibili in IT.");

        const final = await strictSearch({
          type: S.premType,
          dominantGenreId: dom.id,
          refineWeightsByGenreId: refine,
          take: 5,
          poolPages: 4,
          maxCandidates: 120,
          maxProviderChecks: 260,
          minVoteCount: 120
        });

        renderResults(byId("premResults"), final, { mode:"premium", type:S.premType });

        if(final.length === 0){
          setService("premServiceNote", "Zero risultati. Il filtro è molto rigido e richiede disponibilità in IT.");
        }else if(final.length < 5){
          setService("premServiceNote", "Pochi risultati. Il filtro è molto rigido.");
        }else{
          setService("premServiceNote", "Ok. Risultati coerenti e disponibili.");
        }

      }catch(e){
        setService("premExplain", "Errore di rete o TMDB.");
      }
    }

    function genreName(gid){
      if(gid === G.action) return "Azione";
      if(gid === G.comedy) return "Comico";
      if(gid === G.thriller) return "Thriller";
      if(gid === G.animation) return "Animazione";
      if(gid === G.romance) return "Romantico";
      if(gid === G.drama) return "Dramma";
      return "Genere " + gid;
    }

    async function strictSearch(cfg){
      const type = cfg.type;
      const take = cfg.take;
      const dominant = cfg.dominantGenreId;
      const refine = cfg.refineWeightsByGenreId || {};
      const poolPages = cfg.poolPages || 3;
      const maxCandidates = cfg.maxCandidates || 100;
      const maxProviderChecks = cfg.maxProviderChecks || 200;
      const minVoteCount = cfg.minVoteCount || 120;

      const pool = await discoverPool(type, {
        with_genres: String(dominant),
        include_adult: "false",
        sort_by: "vote_average.desc",
        "vote_count.gte": String(minVoteCount)
      }, poolPages);

      const candidates = pool.slice(0, maxCandidates);

      const out = [];
      const seen = new Set();
      let checked = 0;

      for(const m of candidates){
        if(out.length >= take) break;
        if(!m || !m.id) continue;
        if(!m.poster_path) continue;
        if(seen.has(m.id)) continue;
        seen.add(m.id);

        checked++;
        if(checked > maxProviderChecks) break;

        const okGenre = await verifyDominantGenre(type, m.id, dominant);
        if(!okGenre) continue;

        const providers = await getProviders(type, m.id);
        const avail = availabilityScore(providers);
        if(avail <= 0) continue;

        const score = refineScore(m.genre_ids || [], refine) + baseQualityScore(m);

        out.push({ ...m, providers, _avail: avail, _score: score });
      }

      out.sort((a,b) => (b._score - a._score) || (b._avail - a._avail));
      return out.slice(0, take);
    }

    async function verifyDominantGenre(type, id, dominant){
      try{
        const d = await tmdb("/" + type + "/" + id, {});
        const gids = (d && d.genres) ? d.genres.map(x => x.id) : [];
        for(const g of gids){
          if(g === dominant) return true;
        }
        return false;
      }catch(e){
        return false;
      }
    }

    function refineScore(genreIds, refineWeightsByGenreId){
      let s = 0;
      for(const gid of genreIds){
        if(refineWeightsByGenreId[gid]) s += refineWeightsByGenreId[gid] * 10;
      }
      return s;
    }

    function baseQualityScore(m){
      const voteAvg = typeof m.vote_average === "number" ? m.vote_average : 0;
      const voteCnt = typeof m.vote_count === "number" ? m.vote_count : 0;
      return (voteAvg * 3) + Math.log10(voteCnt + 1) * 4;
    }

    async function strictSurprise(cfg){
      const type = cfg.type;
      const take = cfg.take || 5;
      const maxProviderChecks = cfg.maxProviderChecks || 200;

      const trendPath = "/trending/" + (type === "tv" ? "tv" : "movie") + "/week";
      const trend = await tmdb(trendPath, {});
      const list = (trend.results || []).filter(x => x && x.id && x.poster_path).slice(0, 120);

      const out = [];
      const used = new Set();
      let checked = 0;

      for(const m of list){
        if(out.length >= take) break;
        if(used.has(m.id)) continue;
        used.add(m.id);

        checked++;
        if(checked > maxProviderChecks) break;

        const providers = await getProviders(type, m.id);
        const avail = availabilityScore(providers);
        if(avail <= 0) continue;

        out.push({ ...m, providers, _avail: avail, _score: baseQualityScore(m) });
      }

      out.sort((a,b) => (b._score - a._score) || (b._avail - a._avail));
      return out.slice(0, take);
    }

    async function tmdb(path, params){
      const url = new URL(TMDB_BASE + path);
      url.searchParams.set("api_key", TMDB_API_KEY);
      url.searchParams.set("language", "it-IT");
      if(params){
        Object.entries(params).forEach(([k,v]) => {
          if(v === undefined || v === null || v === "") return;
          url.searchParams.set(k, String(v));
        });
      }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error("TMDB error");
      return await res.json();
    }

    async function discoverPage(type, opts, page){
      const path = type === "tv" ? "/discover/tv" : "/discover/movie";
      const base = {
        watch_region: REGION,
        with_watch_monetization_types: "flatrate|rent|buy",
        page: String(page)
      };
      const data = await tmdb(path, { ...base, ...opts });
      return data.results || [];
    }

    async function discoverPool(type, opts, pages){
      const all = [];
      for(let p=1; p<=pages; p++){
        const r = await discoverPage(type, opts, p);
        all.push(...r);
      }
      const seen = new Set();
      const clean = [];
      for(const m of all){
        if(!m || !m.id) continue;
        if(!m.poster_path) continue;
        if(seen.has(m.id)) continue;
        seen.add(m.id);
        clean.push(m);
      }
      return clean;
    }

    async function getProviders(type, id){
      const data = await tmdb("/" + type + "/" + id + "/watch/providers", {});
      const it = (data.results && data.results[REGION]) ? data.results[REGION] : null;
      if(!it) return { flatrate:[], rent:[], buy:[] };
      return { flatrate: it.flatrate || [], rent: it.rent || [], buy: it.buy || [] };
    }

    function availabilityScore(p){
      if(!p) return 0;
      const fl = (p.flatrate || []).length;
      const rent = (p.rent || []).length;
      const buy = (p.buy || []).length;
      return fl*3 + rent*2 + buy*1;
    }

    function renderResults(container, items, opts){
      const mode = opts.mode;

      if(!items || items.length === 0){
        container.innerHTML = '<div class="service">Nessun risultato disponibile sulle piattaforme.</div>';
        return;
      }

      container.innerHTML = "";

      items.forEach((m, idx) => {
        const title = m.title || m.name || "Titolo";
        const date = m.release_date || m.first_air_date || "";
        const year = date ? date.slice(0,4) : "----";
        const vote = (typeof m.vote_average === "number") ? m.vote_average.toFixed(1) : "n.d.";
        const overview = (m.overview || "").trim();
        const shortOv = overview ? clamp(overview, mode==="basic" ? 120 : 220) : "Trama non disponibile.";
        const poster = m.poster_path ? (IMG + m.poster_path) : "";
        const mediaType = m.media_type || opts.type;

        const box = document.createElement("div");
        box.className = "result";

        box.innerHTML = `
          <div class="poster">${poster ? `<img alt="" src="${poster}">` : ""}</div>
          <div>
            <div class="rtitle">
              <h3>${escapeHtml(title)}</h3>
              <span class="badge">${year}</span>
            </div>

            <div class="rmeta">
              <span class="badge">Voto ${vote}</span>
              <span class="badge">${mediaType === "tv" ? "Serie TV" : "Film"}</span>
              ${mode==="basic" ? `<span class="badge serviceBadge">Scelta ${idx+1}</span>` : `<span class="badge serviceBadge">Ordine ${idx+1}</span>`}
              <span class="badge serviceBadge">Disponibilità ${m._avail || 0}</span>
            </div>

            <div class="rov">${escapeHtml(shortOv)}</div>

            ${renderProvidersLine(m.providers, mode)}

            <div class="row" style="margin-top:10px">
              <button class="btn small ${mode==="basic" ? "green" : "primary"}" data-act="open">Dettagli</button>
              <button class="btn small ghost" data-act="start">Avvia</button>
            </div>
          </div>
        `;

        box.addEventListener("click", (ev) => {
          const b = ev.target.closest("button");
          if(!b) return;
          const act = b.getAttribute("data-act");

          if(act === "open"){
            pushHistory({
              id: m.id,
              media_type: mediaType,
              title: m.title || undefined,
              name: m.name || undefined,
              poster_path: m.poster_path || null,
              overview: m.overview || "",
              vote_average: m.vote_average,
              release_date: m.release_date,
              first_air_date: m.first_air_date,
              popularity: m.popularity,
              providers: m.providers
            });
            loadPremiumHistory();
            alert("Demo. Qui apri una pagina dettagli con trama estesa e statistiche complete.");
          }

          if(act === "start"){
            startCinemaClose();
          }
        });

        container.appendChild(box);
      });
    }

    function renderProvidersLine(p, mode){
      if(!p) return '<div class="providers"><span class="service">Piattaforme non disponibili.</span></div>';

      const fl = (p.flatrate || []).slice(0, 4);
      const rent = (p.rent || []).slice(0, 4);
      const buy = (p.buy || []).slice(0, 4);

      if(mode === "basic"){
        const list = fl.length ? fl : (rent.length ? rent : buy);
        if(list.length === 0){
          return '<div class="providers"><span class="service">Non ho trovato piattaforme in IT.</span></div>';
        }
        const tag = fl.length ? "Gratis" : (rent.length ? "Noleggio" : "Acquisto");
        const shown = list.slice(0, 3).map(x => provChip(x, tag)).join("");
        return `<div class="providers">${shown}</div>`;
      }

      const parts = [];
      if(fl.length) parts.push(`<span class="badge">Gratis</span>` + fl.slice(0,4).map(x => provChip(x,"")).join(""));
      if(rent.length) parts.push(`<span class="badge">Noleggio</span>` + rent.slice(0,4).map(x => provChip(x,"")).join(""));
      if(buy.length) parts.push(`<span class="badge">Acquisto</span>` + buy.slice(0,4).map(x => provChip(x,"")).join(""));

      if(parts.length === 0){
        return '<div class="providers"><span class="service">Non ho trovato piattaforme in IT.</span></div>';
      }
      return `<div class="providers">${parts.join("")}</div>`;
    }

    function provChip(x, tag){
      const logo = x.logo_path ? (LOGO + x.logo_path) : "";
      const name = x.provider_name || "Provider";
      const t = tag ? `<span class="service">${tag}</span>` : "";
      return `
        <span class="prov">
          ${logo ? `<img alt="" src="${logo}">` : ""}
          <span>${escapeHtml(name)}</span>
          ${t}
        </span>
      `;
    }

    function clamp(s, n){ return s.length <= n ? s : (s.slice(0, n).trim() + "..."); }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function getHistory(){
      try{ return JSON.parse(localStorage.getItem("mf_history") || "[]"); }
      catch(e){ return []; }
    }
    function pushHistory(item){
      const h = getHistory();
      const key = item.media_type + ":" + item.id;
      const filtered = h.filter(x => (x.media_type + ":" + x.id) !== key);
      filtered.unshift(item);
      localStorage.setItem("mf_history", JSON.stringify(filtered.slice(0, 8)));
    }
    function loadPremiumHistory(){
      const h = getHistory();
      if(h.length === 0){
        byId("premHistory").innerHTML = '<div class="service">Nessun titolo visto di recente.</div>';
        return;
      }
      renderResults(byId("premHistory"), h.slice(0, 5), { mode:"premium", type:"all" });
    }

    async function loadTopWeek(){
      try{
        const list = await tmdb("/trending/all/week", {});
        const picked = (list.results || []).filter(x => x.media_type === "movie" || x.media_type === "tv");

        const out = [];
        let checks = 0;

        for(const m of picked){
          if(out.length >= 5) break;
          if(!m.poster_path) continue;

          checks++;
          if(checks > 45) break;

          const providers = await getProviders(m.media_type, m.id);
          const av = availabilityScore(providers);
          if(av <= 0) continue;

          out.push({ ...m, providers, _avail: av, _score: baseQualityScore(m) });
        }

        if(out.length === 0){
          byId("premTopWeek").innerHTML = '<div class="service">Top settimana non disponibile.</div>';
          return;
        }
        out.sort((a,b) => (b._score - a._score) || (b._avail - a._avail));
        renderResults(byId("premTopWeek"), out.slice(0,5), { mode:"premium", type:"all" });
      }catch(e){
        byId("premTopWeek").innerHTML = '<div class="service">Top settimana non disponibile.</div>';
      }
    }

    byId("btnCopyLink").addEventListener("click", async () => {
      try{ await navigator.clipboard.writeText(APP_DEEPLINK); alert("Link copiato."); }
      catch(e){ alert("Copia manualmente: " + APP_DEEPLINK); }
    });
    byId("btnShareNow").addEventListener("click", () => shareText("Sto guardando questo su Movie Finder", APP_DEEPLINK));
    byId("btnShareRec").addEventListener("click", () => shareText("Consigliato su Movie Finder", APP_DEEPLINK));
    async function shareText(title, url){
      try{
        if(navigator.share){ await navigator.share({ title, text: title, url }); }
        else{ await navigator.clipboard.writeText(url); alert("Condivisione non disponibile. Ho copiato il link."); }
      }catch(e){}
    }

    const cinema = byId("cinema");
    const cinemaSub = byId("cinemaSub");
    const cinemaActions = byId("cinemaActions");
    byId("btnCloseTab").addEventListener("click", () => { try{ window.close(); }catch(e){} });
    byId("btnBack").addEventListener("click", () => { cinema.classList.remove("on"); });

    function startCinemaClose(){
      try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}
      cinema.classList.add("on");
      cinemaSub.textContent = "Sto chiudendo la app...";
      cinemaActions.style.display = "none";

      setTimeout(() => {
        try{ window.close(); }catch(e){}
      }, 900);

      setTimeout(() => {
        cinemaSub.textContent = "Il browser non può chiudere la scheda da solo. Chiudi tu.";
        cinemaActions.style.display = "flex";
      }, 1400);
    }

    (function boot(){
      show("secSplash");

      setTimeout(async () => {
        show("secProfiles");
        refreshBasicLimitUI();
        updatePremiumStatus();

        try{
          const ping = await tmdb("/configuration", {});
          if(ping && ping.images) setNetHint("Connessione TMDB ok.");
        }catch(e){
          setNetHint("Connessione TMDB non disponibile.");
        }
      }, 2000);
    })();
  </script>
</body>
</html>
