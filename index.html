<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Movie Finder</title>

<style>
:root{
  --bg:#0f0f0f;
  --card:#1c1c1c;
  --muted:#cfcfcf;
  --muted2:#9a9a9a;
  --btn:#5b2cff;
  --btn2:#2a2a2a;
  --danger:#ff3b30;
  --ok:#34c759;
  --border:#2b2b2b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
  color:#fff;
}
.container{padding:16px; max-width:980px; margin:0 auto}
h1{margin:6px 0 14px 0; text-align:center; font-size:22px}
.row{display:flex; gap:10px; flex-wrap:wrap}
.col{flex:1; min-width:240px}
.section{
  margin-top:14px;
  padding:12px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
}
label{display:block; margin-top:10px; font-size:14px; color:var(--muted)}
select, input[type="text"], input[type="range"]{
  width:100%;
  margin-top:8px;
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#141414;
  color:#fff;
}
input[type="range"]{padding:0; height:36px; background:transparent; border:none}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  background:var(--btn);
  color:#fff;
  border:none;
  border-radius:8px;
}
button.secondary{background:var(--btn2)}
button.danger{background:var(--danger)}
.small{font-size:13px; color:var(--muted2); line-height:1.35}
.notice{
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  background:#141414;
  border:1px solid var(--border);
}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#141414;
  color:var(--muted);
  font-size:12px;
  margin-right:6px;
  margin-top:6px;
}
.badge.ok{border-color:rgba(52,199,89,.35); color:#c8f7d8}
.badge.warn{border-color:rgba(255,59,48,.35); color:#ffd2cf}
hr{border:none; border-top:1px solid var(--border); margin:12px 0}
.results{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap:12px;
  margin-top:12px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
}
.poster{
  width:100%;
  aspect-ratio: 2 / 3;
  background:#121212;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--muted2);
  font-size:13px;
}
.poster img{width:100%; height:100%; object-fit:cover; display:block}
.card-body{padding:10px}
.title{margin:0; font-size:16px}
.meta{margin:6px 0 0 0; font-size:13px; color:var(--muted)}
.overview{margin:8px 0 0 0; font-size:13px; color:#e8e8e8; line-height:1.35}
.providers{margin-top:8px}
.providers .p-row{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
.pill{
  display:flex;
  align-items:center;
  gap:6px;
  border:1px solid var(--border);
  background:#141414;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
}
.pill img{width:18px; height:18px; border-radius:4px}
.actions{display:flex; gap:8px; margin-top:10px}
.actions button{margin-top:0; padding:10px; font-size:14px}
.kpi{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:10px;
  margin-top:10px;
}
.kpi .box{
  background:#141414;
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
}
.kpi .num{font-size:20px; margin:0}
.kpi .lbl{margin:6px 0 0 0; color:var(--muted2); font-size:12px}
.hidden{display:none !important}
.inline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.chk{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:10px;
  padding:10px;
  border:1px solid var(--border);
  background:#141414;
  border-radius:10px;
}
.chk input{width:18px; height:18px; margin:0}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media(max-width:520px){
  .grid2{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="container">
  <h1>Movie Finder</h1>

  <div class="section">
    <div class="row">
      <div class="col">
        <label>TMDB API Key</label>
        <input id="apiKey" type="text" placeholder="Incolla qui la tua API key" />
        <div class="small" style="margin-top:8px">
          L’app usa TMDB. Tu inserisci la tua API key. L’app la salva in locale.
        </div>
      </div>
      <div class="col">
        <label>Tipo utente</label>
        <select id="userType">
          <option value="base">Utente base</option>
          <option value="premium">Utente premium</option>
        </select>

        <div class="chk">
          <input id="onlyOnline" type="checkbox" />
          <label for="onlyOnline" style="margin:0">Mostra solo disponibili online in Italia</label>
        </div>

        <div class="notice" id="dailyNotice"></div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col">
        <div class="inline">
          <button id="btnSearch" onclick="runSearch()">Cerca</button>
          <button class="secondary" onclick="showWatchlist()">Watchlist</button>
          <button class="secondary" onclick="clearResults()">Pulisci risultati</button>
        </div>
      </div>
    </div>
  </div>

  <div class="section" id="baseSection">
    <div class="small">Utente base. Tu fai una ricerca al giorno. Tu ottieni 3 risultati. Tu vedi locandina e trama breve.</div>

    <div class="grid2">
      <div>
        <label>Genere 1</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 2</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 3</label>
        <select class="baseGenre"></select>
      </div>
      <div>
        <label>Genere 4</label>
        <select class="baseGenre"></select>
      </div>
    </div>
  </div>

  <div class="section hidden" id="premiumSection">
    <div class="small">Utente premium. Tu scegli fino a 10 generi. Tu regoli i generi con slider. Tu cerchi film e serie TV. Tu vedi trama estesa, locandina, statistiche.</div>

    <label>Contenuti</label>
    <select id="contentType">
      <option value="movie">Film</option>
      <option value="tv">Serie TV</option>
      <option value="both">Film e serie TV</option>
    </select>

    <div class="section" style="margin-top:12px">
      <div class="small">Generi e intensità. Se imposti 0, l’app ignora il genere.</div>
      <div id="premiumGenres"></div>
    </div>

    <div class="section" style="margin-top:12px">
      <div class="small">Piattaforme. Tu scegli cosa vedere. L’app filtra i risultati in base alle piattaforme presenti in Italia.</div>
      <div id="platformsBox" class="inline"></div>
      <div class="inline" style="margin-top:10px">
        <button class="secondary" onclick="savePlatforms()">Salva piattaforme</button>
        <button class="secondary" onclick="resetPlatforms()">Reset piattaforme</button>
      </div>
    </div>

    <div class="section" style="margin-top:12px">
      <div class="small">Statistiche personali. L’app le salva in locale.</div>
      <div class="kpi" id="statsKpi"></div>
      <button class="danger" onclick="resetStats()">Reset statistiche</button>
    </div>
  </div>

  <div class="section">
    <div class="inline">
      <span class="badge" id="statusBadge">Pronto</span>
      <span class="badge" id="modeBadge">Base</span>
    </div>
    <div id="msg" class="notice small" style="margin-top:10px">Inserisci la tua API key. Seleziona i generi. Premi Cerca.</div>
    <div id="results" class="results"></div>
  </div>
</div>

<script>
const TMDB_BASE = "https://api.themoviedb.org/3";
const IMG_BASE = "https://image.tmdb.org/t/p/w500";
const LOGO_BASE = "https://image.tmdb.org/t/p/w92";

const GENRES = {
  movie: [
    {id:28, name:"Azione"},
    {id:12, name:"Avventura"},
    {id:16, name:"Animazione"},
    {id:35, name:"Commedia"},
    {id:80, name:"Crime"},
    {id:99, name:"Documentario"},
    {id:18, name:"Drammatico"},
    {id:10751, name:"Famiglia"},
    {id:14, name:"Fantasy"},
    {id:36, name:"Storia"},
    {id:27, name:"Horror"},
    {id:10402, name:"Musica"},
    {id:9648, name:"Mistero"},
    {id:10749, name:"Romantico"},
    {id:878, name:"Fantascienza"},
    {id:10770, name:"Film TV"},
    {id:53, name:"Thriller"},
    {id:10752, name:"Guerra"},
    {id:37, name:"Western"}
  ],
  tv: [
    {id:10759, name:"Azione e avventura"},
    {id:16, name:"Animazione"},
    {id:35, name:"Commedia"},
    {id:80, name:"Crime"},
    {id:99, name:"Documentario"},
    {id:18, name:"Drammatico"},
    {id:10751, name:"Famiglia"},
    {id:10762, name:"Kids"},
    {id:9648, name:"Mistero"},
    {id:10763, name:"News"},
    {id:10764, name:"Reality"},
    {id:10765, name:"Sci-Fi e fantasy"},
    {id:10766, name:"Soap"},
    {id:10767, name:"Talk"},
    {id:10768, name:"Guerra e politica"},
    {id:37, name:"Western"}
  ]
};

const PREMIUM_GENRE_SET = [
  {key:"action", name:"Azione", movieId:28, tvId:10759},
  {key:"comedy", name:"Commedia", movieId:35, tvId:35},
  {key:"drama", name:"Drammatico", movieId:18, tvId:18},
  {key:"thriller", name:"Thriller", movieId:53, tvId:9648},
  {key:"romance", name:"Romantico", movieId:10749, tvId:null},
  {key:"horror", name:"Horror", movieId:27, tvId:null},
  {key:"scifi", name:"Fantascienza", movieId:878, tvId:10765},
  {key:"crime", name:"Crime", movieId:80, tvId:80},
  {key:"family", name:"Famiglia", movieId:10751, tvId:10751},
  {key:"doc", name:"Documentario", movieId:99, tvId:99}
];

const KNOWN_PLATFORMS_IT = [
  "Netflix","Amazon Prime Video","Disney Plus","NOW","Sky Go","Apple TV","Paramount Plus",
  "Rakuten TV","Google Play Movies","YouTube","Infinity","Chili","TIMVISION","MUBI"
];

const LS = {
  apiKey:"mf_apiKey",
  userType:"mf_userType",
  daily:"mf_daily",
  watchlist:"mf_watchlist",
  stats:"mf_stats",
  platforms:"mf_platforms",
  premiumSliders:"mf_sliders"
};

function $(id){return document.getElementById(id)}
function setStatus(txt, kind){
  const b = $("statusBadge");
  b.textContent = txt;
  b.classList.remove("ok","warn");
  if(kind==="ok") b.classList.add("ok");
  if(kind==="warn") b.classList.add("warn");
}
function setMsg(txt){$("msg").textContent = txt}
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return y + "-" + m + "-" + da;
}

function loadState(){
  const api = localStorage.getItem(LS.apiKey) || "";
  $("apiKey").value = api;

  const ut = localStorage.getItem(LS.userType) || "base";
  $("userType").value = ut;

  const onlyOnline = localStorage.getItem("mf_onlyOnline") === "1";
  $("onlyOnline").checked = onlyOnline;

  initBaseGenres();
  initPremiumGenres();
  initPlatformsBox();
  refreshUI();
  refreshDailyNotice();
  renderStats();
}

function saveApiKey(){
  const k = $("apiKey").value.trim();
  localStorage.setItem(LS.apiKey, k);
}

function refreshUI(){
  const ut = $("userType").value;
  $("modeBadge").textContent = ut === "premium" ? "Premium" : "Base";
  $("baseSection").classList.toggle("hidden", ut === "premium");
  $("premiumSection").classList.toggle("hidden", ut !== "premium");
  refreshDailyNotice();
}

function refreshDailyNotice(){
  const ut = $("userType").value;
  const box = $("dailyNotice");
  if(ut === "premium"){
    box.textContent = "Premium attivo. Tu puoi cercare senza limite giornaliero.";
    return;
  }
  const daily = safeJson(localStorage.getItem(LS.daily), {});
  const t = todayKey();
  if(daily && daily.date === t){
    box.textContent = "Oggi hai già fatto la ricerca base. Torna domani per un’altra ricerca.";
  }else{
    box.textContent = "Tu puoi fare 1 ricerca al giorno. Oggi non hai ancora cercato.";
  }
}

function safeJson(s, fallback){
  try{ return s ? JSON.parse(s) : fallback; }catch(e){ return fallback; }
}

function initBaseGenres(){
  const selects = document.querySelectorAll(".baseGenre");
  const opts = GENRES.movie.slice().sort((a,b)=>a.name.localeCompare(b.name));
  selects.forEach(sel=>{
    sel.innerHTML = "";
    const none = document.createElement("option");
    none.value = "";
    none.textContent = "Nessuno";
    sel.appendChild(none);
    opts.forEach(g=>{
      const o = document.createElement("option");
      o.value = String(g.id);
      o.textContent = g.name;
      sel.appendChild(o);
    });
  });
}

function initPremiumGenres(){
  const host = $("premiumGenres");
  host.innerHTML = "";

  const saved = safeJson(localStorage.getItem(LS.premiumSliders), {});
  PREMIUM_GENRE_SET.forEach(g=>{
    const wrap = document.createElement("div");
    wrap.className = "chk";
    wrap.style.flexDirection = "column";
    wrap.style.alignItems = "stretch";

    const top = document.createElement("div");
    top.className = "inline";
    top.style.justifyContent = "space-between";

    const label = document.createElement("div");
    label.textContent = g.name;
    label.style.color = "#fff";
    label.style.fontSize = "14px";

    const val = document.createElement("div");
    val.id = "val_" + g.key;
    val.className = "small";
    val.textContent = "0";

    top.appendChild(label);
    top.appendChild(val);

    const r = document.createElement("input");
    r.type = "range";
    r.min = "0";
    r.max = "10";
    r.step = "1";
    r.value = String(saved[g.key] ?? 0);
    val.textContent = r.value;

    r.addEventListener("input", ()=>{
      val.textContent = r.value;
      savePremiumSliders();
    });

    wrap.appendChild(top);
    wrap.appendChild(r);
    host.appendChild(wrap);
  });
}

function savePremiumSliders(){
  const data = {};
  PREMIUM_GENRE_SET.forEach(g=>{
    const el = document.querySelector(`#premiumGenres input[type="range"]#r_${g.key}`);
  });
  const ranges = Array.from(document.querySelectorAll("#premiumGenres input[type='range']"));
  ranges.forEach((r,i)=>{
    data[PREMIUM_GENRE_SET[i].key] = Number(r.value);
  });
  localStorage.setItem(LS.premiumSliders, JSON.stringify(data));
}

function getPremiumSliders(){
  const data = safeJson(localStorage.getItem(LS.premiumSliders), {});
  const out = {};
  PREMIUM_GENRE_SET.forEach(g=>{
    out[g.key] = Number(data[g.key] ?? 0);
  });
  return out;
}

function initPlatformsBox(){
  const box = $("platformsBox");
  box.innerHTML = "";

  const saved = safeJson(localStorage.getItem(LS.platforms), {});
  KNOWN_PLATFORMS_IT.forEach(name=>{
    const d = document.createElement("div");
    d.className = "chk";
    d.style.marginTop = "0";
    d.style.padding = "10px";
    d.style.minWidth = "190px";

    const c = document.createElement("input");
    c.type = "checkbox";
    c.id = "pl_" + name.replace(/\s+/g,"_");
    c.checked = !!saved[name];

    const l = document.createElement("label");
    l.setAttribute("for", c.id);
    l.textContent = name;
    l.style.margin = "0";

    d.appendChild(c);
    d.appendChild(l);
    box.appendChild(d);
  });
}

function savePlatforms(){
  const out = {};
  KNOWN_PLATFORMS_IT.forEach(name=>{
    const id = "pl_" + name.replace(/\s+/g,"_");
    const el = document.getElementById(id);
    out[name] = !!(el && el.checked);
  });
  localStorage.setItem(LS.platforms, JSON.stringify(out));
  setMsg("Piattaforme salvate.");
}

function resetPlatforms(){
  localStorage.removeItem(LS.platforms);
  initPlatformsBox();
  setMsg("Piattaforme resettate.");
}

function getSelectedPlatforms(){
  const saved = safeJson(localStorage.getItem(LS.platforms), {});
  const selected = Object.keys(saved).filter(k=>saved[k]);
  return selected;
}

function canSearchBaseToday(){
  const daily = safeJson(localStorage.getItem(LS.daily), {});
  return !(daily && daily.date === todayKey());
}

function markBaseSearchedToday(){
  localStorage.setItem(LS.daily, JSON.stringify({date: todayKey()}));
}

function shortOverview(text){
  if(!text) return "Trama non disponibile.";
  const t = text.trim();
  if(t.length <= 220) return t;
  return t.slice(0, 220).trim() + "...";
}

function normalize(n, min, max){
  if(max === min) return 0;
  return (n - min) / (max - min);
}

async function tmdbFetch(path, params){
  const apiKey = $("apiKey").value.trim();
  if(!apiKey){
    throw new Error("Manca la API key.");
  }
  const url = new URL(TMDB_BASE + path);
  url.searchParams.set("api_key", apiKey);
  url.searchParams.set("language", "it-IT");
  if(params){
    Object.keys(params).forEach(k=>{
      if(params[k] !== undefined && params[k] !== null && params[k] !== ""){
        url.searchParams.set(k, String(params[k]));
      }
    });
  }
  const res = await fetch(url.toString());
  if(!res.ok){
    throw new Error("Errore TMDB: " + res.status);
  }
  return await res.json();
}

async function getProviders(kind, id){
  try{
    const data = await tmdbFetch(`/${kind}/${id}/watch/providers`, {});
    const it = data && data.results && data.results.IT ? data.results.IT : null;
    if(!it) return null;

    const packs = [];
    const pushPack = (label, arr)=>{
      if(!Array.isArray(arr)) return;
      const unique = [];
      const seen = new Set();
      arr.forEach(p=>{
        if(p && p.provider_name && !seen.has(p.provider_name)){
          seen.add(p.provider_name);
          unique.push({
            name: p.provider_name,
            logo: p.logo_path ? (LOGO_BASE + p.logo_path) : null
          });
        }
      });
      if(unique.length) packs.push({label, items: unique});
    };

    pushPack("Abbonamento", it.flarate);
    pushPack("Noleggio", it.rent);
    pushPack("Acquisto", it.buy);

    if(!packs.length) return null;
    return packs;
  }catch(e){
    return null;
  }
}

function providersMatchSelected(packs, selectedPlatforms){
  if(!packs) return false;
  if(!selectedPlatforms || !selectedPlatforms.length) return true;
  const set = new Set(selectedPlatforms);
  for(const p of packs){
    for(const it of p.items){
      if(set.has(it.name)) return true;
    }
  }
  return false;
}

function flattenProviders(packs){
  if(!packs) return [];
  const all = [];
  packs.forEach(p=>p.items.forEach(i=>all.push(i.name)));
  return all;
}

function updateStatsOnSearch(payload){
  const st = safeJson(localStorage.getItem(LS.stats), {
    searches:0,
    searchesBase:0,
    searchesPremium:0,
    movieSearches:0,
    tvSearches:0,
    genreCounts:{},
    clicks:0,
    watchAdds:0
  });

  st.searches += 1;
  if(payload.userType === "base") st.searchesBase += 1;
  if(payload.userType === "premium") st.searchesPremium += 1;

  if(payload.contentType === "movie") st.movieSearches += 1;
  if(payload.contentType === "tv") st.tvSearches += 1;
  if(payload.contentType === "both"){
    st.movieSearches += 1;
    st.tvSearches += 1;
  }

  (payload.genres || []).forEach(g=>{
    const k = String(g);
    st.genreCounts[k] = (st.genreCounts[k] || 0) + 1;
  });

  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function updateStatsOnClick(){
  const st = safeJson(localStorage.getItem(LS.stats), {});
  st.clicks = Number(st.clicks || 0) + 1;
  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function updateStatsOnWatchAdd(){
  const st = safeJson(localStorage.getItem(LS.stats), {});
  st.watchAdds = Number(st.watchAdds || 0) + 1;
  localStorage.setItem(LS.stats, JSON.stringify(st));
  renderStats();
}

function renderStats(){
  const ut = $("userType").value;
  const box = $("statsKpi");
  if(!box) return;
  const st = safeJson(localStorage.getItem(LS.stats), {
    searches:0, searchesBase:0, searchesPremium:0, movieSearches:0, tvSearches:0, clicks:0, watchAdds:0
  });

  box.innerHTML = "";
  const items = [
    {num: st.searches || 0, lbl: "Ricerche totali"},
    {num: st.searchesPremium || 0, lbl: "Ricerche premium"},
    {num: st.searchesBase || 0, lbl: "Ricerche base"},
    {num: st.movieSearches || 0, lbl: "Ricerche film"},
    {num: st.tvSearches || 0, lbl: "Ricerche serie TV"},
    {num: st.clicks || 0, lbl: "Click su risultati"},
    {num: st.watchAdds || 0, lbl: "Aggiunte in watchlist"}
  ];
  items.forEach(it=>{
    const d = document.createElement("div");
    d.className = "box";
    d.innerHTML = `<p class="num">${it.num}</p><p class="lbl">${it.lbl}</p>`;
    box.appendChild(d);
  });
}

function resetStats(){
  localStorage.removeItem(LS.stats);
  renderStats();
  setMsg("Statistiche resettate.");
}

function getWatchlist(){
  return safeJson(localStorage.getItem(LS.watchlist), []);
}

function saveWatchlist(list){
  localStorage.setItem(LS.watchlist, JSON.stringify(list));
}

function addToWatchlist(item){
  const list = getWatchlist();
  const key = item.kind + ":" + item.id;
  if(list.some(x => (x.kind + ":" + x.id) === key)){
    setMsg("È già in watchlist.");
    return;
  }
  list.unshift({
    kind:item.kind,
    id:item.id,
    title:item.title,
    poster:item.poster || null,
    year:item.year || "",
    addedAt: Date.now()
  });
  saveWatchlist(list);
  updateStatsOnWatchAdd();
  setMsg("Aggiunto in watchlist.");
}

function removeFromWatchlist(kind, id){
  const list = getWatchlist();
  const key = kind + ":" + id;
  const out = list.filter(x => (x.kind + ":" + x.id) !== key);
  saveWatchlist(out);
  showWatchlist();
}

function showWatchlist(){
  const list = getWatchlist();
  clearResults();
  if(!list.length){
    setMsg("Watchlist vuota.");
    return;
  }
  setMsg("Watchlist. Tocca Rimuovi per cancellare un elemento.");
  const host = $("results");
  list.forEach(w=>{
    const card = document.createElement("div");
    card.className = "card";
    const poster = w.poster ? `<img src="${w.poster}" alt="Locandina">` : "";
    card.innerHTML = `
      <div class="poster">${poster || "Locandina"}</div>
      <div class="card-body">
        <h3 class="title">${escapeHtml(w.title)}</h3>
        <div class="meta">${escapeHtml(w.year || "")}</div>
        <div class="actions">
          <button class="danger" onclick="removeFromWatchlist('${w.kind}', ${w.id})">Rimuovi</button>
        </div>
      </div>
    `;
    host.appendChild(card);
  });
}

function clearResults(){
  $("results").innerHTML = "";
  setStatus("Pronto");
}

function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function getBaseSelectedGenres(){
  const ids = Array.from(document.querySelectorAll(".baseGenre"))
    .map(s=>Number(s.value || 0))
    .filter(n=>n > 0);
  const uniq = Array.from(new Set(ids));
  return uniq.slice(0, 4);
}

function getPremiumGenreIdsFor(kind){
  const sliders = getPremiumSliders();
  const active = PREMIUM_GENRE_SET
    .map(g=>{
      const w = Number(sliders[g.key] || 0);
      const id = kind === "movie" ? g.movieId : g.tvId;
      return {id, w};
    })
    .filter(x => x.id && x.w > 0);

  active.sort((a,b)=>b.w - a.w);
  return active;
}

async function discover(kind, genreIds, page){
  const withGenres = genreIds && genreIds.length ? genreIds.join(",") : "";
  const params = {
    include_adult: "false",
    include_video: "false",
    sort_by: "popularity.desc",
    "watch_region":"IT",
    "with_watch_monetization_types":"flatrate|rent|buy",
    page: page || 1
  };
  if(withGenres) params.with_genres = withGenres;

  const path = kind === "tv" ? "/discover/tv" : "/discover/movie";
  return await tmdbFetch(path, params);
}

function baseReRank(items, genreIds){
  const filtered = items.slice();
  const pops = filtered.map(x=>Number(x.popularity || 0));
  const votes = filtered.map(x=>Number(x.vote_average || 0));
  const pMin = Math.min(...pops, 0), pMax = Math.max(...pops, 1);
  const vMin = Math.min(...votes, 0), vMax = Math.max(...votes, 10);

  filtered.forEach(x=>{
    const p = normalize(Number(x.popularity||0), pMin, pMax);
    const v = normalize(Number(x.vote_average||0), vMin, vMax);
    const g = Array.isArray(x.genre_ids) ? x.genre_ids : [];
    let match = 0;
    genreIds.forEach(id=>{
      if(g.includes(id)) match += 1;
    });
    const m = genreIds.length ? (match / genreIds.length) : 0;
    x._score = (v * 0.55) + (p * 0.30) + (m * 0.15);
  });

  filtered.sort((a,b)=> (b._score||0) - (a._score||0));
  return filtered;
}

function premiumReRank(items, weightedGenreIds){
  const filtered = items.slice();
  const pops = filtered.map(x=>Number(x.popularity || 0));
  const votes = filtered.map(x=>Number(x.vote_average || 0));
  const pMin = Math.min(...pops, 0), pMax = Math.max(...pops, 1);
  const vMin = Math.min(...votes, 0), vMax = Math.max(...votes, 10);

  const maxW = Math.max(...weightedGenreIds.map(x=>x.w), 10);

  filtered.forEach(x=>{
    const p = normalize(Number(x.popularity||0), pMin, pMax);
    const v = normalize(Number(x.vote_average||0), vMin, vMax);
    const g = Array.isArray(x.genre_ids) ? x.genre_ids : [];

    let wsum = 0;
    let wmatch = 0;
    weightedGenreIds.forEach(it=>{
      wsum += it.w;
      if(g.includes(it.id)) wmatch += it.w;
    });
    const wm = wsum ? (wmatch / wsum) : 0;

    const topBoost = weightedGenreIds.length ? (weightedGenreIds[0].w / maxW) : 0;
    x._score = (v * 0.50) + (p * 0.25) + (wm * 0.25) + (topBoost * 0.03);
  });

  filtered.sort((a,b)=> (b._score||0) - (a._score||0));
  return filtered;
}

async function buildItems(kind, raw){
  const out = [];
  for(const r of raw){
    const title = kind === "tv" ? (r.name || "") : (r.title || "");
    const date = kind === "tv" ? (r.first_air_date || "") : (r.release_date || "");
    const year = date ? String(date).slice(0,4) : "";
    const poster = r.poster_path ? (IMG_BASE + r.poster_path) : null;

    out.push({
      kind,
      id: r.id,
      title,
      year,
      rating: Number(r.vote_average || 0).toFixed(1),
      popularity: Number(r.popularity || 0),
      overview: r.overview || "",
      poster
    });
  }
  return out;
}

async function attachProviders(items){
  const onlyOnline = $("onlyOnline").checked;
  const ut = $("userType").value;
  const selectedPlatforms = ut === "premium" ? getSelectedPlatforms() : [];

  const final = [];
  for(const it of items){
    const packs = await getProviders(it.kind, it.id);
    it.providers = packs;

    const hasOnline = !!packs;
    if(onlyOnline && !hasOnline) continue;

    const okPlatforms = providersMatchSelected(packs, selectedPlatforms);
    if(!okPlatforms) continue;

    final.push(it);
  }
  return final;
}

function renderItems(items, userType){
  const host = $("results");
  host.innerHTML = "";

  if(!items.length){
    setMsg("Nessun risultato. Cambia generi o disattiva i filtri.");
    setStatus("Nessun risultato", "warn");
    return;
  }

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card";

    const posterHtml = it.poster ? `<img src="${it.poster}" alt="Locandina">` : "";
    const overviewText = userType === "premium" ? (it.overview || "Trama non disponibile.") : shortOverview(it.overview);
    const kindLabel = it.kind === "tv" ? "Serie TV" : "Film";

    const providersHtml = buildProvidersHtml(it.providers);
    const onlineBadge = it.providers ? `<span class="badge ok">Online IT</span>` : `<span class="badge warn">Non trovato online</span>`;

    card.innerHTML = `
      <div class="poster">${posterHtml || "Locandina"}</div>
      <div class="card-body">
        <h3 class="title">${escapeHtml(it.title)}</h3>
        <div class="meta">${escapeHtml(kindLabel)} ${it.year ? " , " + escapeHtml(it.year) : ""} , Voto ${escapeHtml(it.rating)}</div>
        <div style="margin-top:8px">${onlineBadge}</div>
        <p class="overview">${escapeHtml(overviewText)}</p>
        <div class="providers">${providersHtml}</div>
        <div class="actions">
          <button class="secondary" onclick="openTmdb('${it.kind}', ${it.id})">Apri su TMDB</button>
          <button onclick='addToWatchlist(${JSON.stringify(it).replace(/</g,"\\u003c")})'>Watchlist</button>
        </div>
      </div>
    `;
    host.appendChild(card);
  });
}

function buildProvidersHtml(packs){
  if(!packs) return `<div class="small">Disponibilità streaming IT non trovata.</div>`;
  let html = "";
  packs.forEach(p=>{
    html += `<div class="small" style="margin-top:8px">${escapeHtml(p.label)}</div>`;
    html += `<div class="p-row">`;
    p.items.forEach(i=>{
      const logo = i.logo ? `<img src="${i.logo}" alt="">` : "";
      html += `<div class="pill">${logo}${escapeHtml(i.name)}</div>`;
    });
    html += `</div>`;
  });
  return html;
}

function openTmdb(kind, id){
  updateStatsOnClick();
  const url = "https://www.themoviedb.org/" + (kind === "tv" ? "tv/" : "movie/") + id;
  window.open(url, "_blank");
}

async function runSearch(){
  try{
    saveApiKey();
    localStorage.setItem(LS.userType, $("userType").value);
    localStorage.setItem("mf_onlyOnline", $("onlyOnline").checked ? "1" : "0");

    refreshUI();
    clearResults();
    setStatus("Cerco...");

    const userType = $("userType").value;

    if(userType === "base"){
      if(!canSearchBaseToday()){
        setMsg("Oggi hai già fatto la ricerca base. Torna domani.");
        setStatus("Bloccato", "warn");
        return;
      }

      const genres = getBaseSelectedGenres();
      if(!genres.length){
        setMsg("Seleziona almeno 1 genere.");
        setStatus("Attenzione", "warn");
        return;
      }

      setMsg("Sto cercando 3 film con locandina e trama breve.");
      const d1 = await discover("movie", genres, 1);
      const d2 = await discover("movie", genres, 2);

      const raw = (d1.results || []).concat(d2.results || []);
      const ranked = baseReRank(raw, genres).slice(0, 12);
      let items = await buildItems("movie", ranked);

      items = await attachProviders(items);
      items = items.slice(0, 3);

      renderItems(items, "base");
      markBaseSearchedToday();
      refreshDailyNotice();
      updateStatsOnSearch({userType:"base", contentType:"movie", genres});
      setStatus("Fatto", "ok");
      return;
    }

    if(userType === "premium"){
      const contentType = $("contentType").value;
      const selectedPlatforms = getSelectedPlatforms();
      const sliders = getPremiumSliders();

      const activeMovie = getPremiumGenreIdsFor("movie");
      const activeTv = getPremiumGenreIdsFor("tv");

      const usedGenres = [];
      Object.keys(sliders).forEach(k=>{
        if(Number(sliders[k]||0) > 0) usedGenres.push(k);
      });

      if(!usedGenres.length){
        setMsg("Imposta almeno 1 slider sopra 0.");
        setStatus("Attenzione", "warn");
        return;
      }

      if(contentType === "movie" && !activeMovie.length){
        setMsg("I generi scelti non hanno corrispondenze film. Alza altri slider.");
        setStatus("Attenzione", "warn");
        return;
      }
      if(contentType === "tv" && !activeTv.length){
        setMsg("I generi scelti non hanno corrispondenze serie TV. Alza altri slider.");
        setStatus("Attenzione", "warn");
        return;
      }

      if(selectedPlatforms.length){
        setMsg("Sto cercando risultati pertinenti, filtrati sulle tue piattaforme.");
      }else{
        setMsg("Sto cercando risultati pertinenti. Tu non hai impostato piattaforme.");
      }

      let pool = [];

      if(contentType === "movie" || contentType === "both"){
        const gids = activeMovie.map(x=>x.id);
        const d1 = await discover("movie", gids, 1);
        const d2 = await discover("movie", gids, 2);
        const raw = (d1.results || []).concat(d2.results || []);
        const ranked = premiumReRank(raw, activeMovie).slice(0, 14);
        const items = await buildItems("movie", ranked);
        pool = pool.concat(items);
      }

      if(contentType === "tv" || contentType === "both"){
        const gids = activeTv.map(x=>x.id);
        const d1 = await discover("tv", gids, 1);
        const d2 = await discover("tv", gids, 2);
        const raw = (d1.results || []).concat(d2.results || []);
        const ranked = premiumReRank(raw, activeTv).slice(0, 14);
        const items = await buildItems("tv", ranked);
        pool = pool.concat(items);
      }

      const popMin = Math.min(...pool.map(x=>x.popularity), 0);
      const popMax = Math.max(...pool.map(x=>x.popularity), 1);
      const voteMin = Math.min(...pool.map(x=>Number(x.rating)), 0);
      const voteMax = Math.max(...pool.map(x=>Number(x.rating)), 10);

      pool.forEach(x=>{
        const p = normalize(x.popularity, popMin, popMax);
        const v = normalize(Number(x.rating), voteMin, voteMax);
        x._score = (v * 0.55) + (p * 0.45);
      });
      pool.sort((a,b)=>(b._score||0)-(a._score||0));

      pool = await attachProviders(pool);
      const top = pool.slice(0, 8);

      renderItems(top, "premium");
      updateStatsOnSearch({userType:"premium", contentType, genres: usedGenres});
      setStatus("Fatto", "ok");
      return;
    }

  }catch(e){
    setMsg(String(e && e.message ? e.message : e));
    setStatus("Errore", "warn");
  }
}

$("userType").addEventListener("change", ()=>{
  localStorage.setItem(LS.userType, $("userType").value);
  refreshUI();
});

$("apiKey").addEventListener("input", ()=>{
  localStorage.setItem(LS.apiKey, $("apiKey").value.trim());
});

$("onlyOnline").addEventListener("change", ()=>{
  localStorage.setItem("mf_onlyOnline", $("onlyOnline").checked ? "1" : "0");
});

function clearResults(){
  $("results").innerHTML = "";
  setStatus("Pronto");
}

(function fixPremiumSlidersIds(){
  const host = $("premiumGenres");
  if(!host) return;
  const rows = Array.from(host.querySelectorAll(".chk"));
  rows.forEach((row, idx)=>{
    const r = row.querySelector("input[type='range']");
    if(r) r.id = "r_" + PREMIUM_GENRE_SET[idx].key;
  });
})();

loadState();
</script>
</body>
</html>
